{% extends "base.html" %}

{% block title %}Central de Pedidos - ALIV{% endblock %}

{% block head %}
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
<style>
    .tab-btn {
        border-bottom: 3px solid transparent;
        opacity: 0.6;
        transition: all 0.2s;
    }

    .tab-btn.active {
        border-color: #6366f1;
        opacity: 1;
        font-weight: bold;
        color: white;
    }

    .tab-content {
        display: none;
        animation: fadeIn 0.3s ease;
    }

    .tab-content.active {
        display: block;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(5px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* MESA CARD */
    .mesa-card {
        transition: all 0.2s;
        height: 180px;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }

    .mesa-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 15px 20px -5px rgba(0, 0, 0, 0.4);
    }

    .mesa-livre {
        background: #1e293b;
        border: 1px solid #334155;
        opacity: 0.7;
    }

    .mesa-livre:hover {
        opacity: 1;
        border-color: #6366f1;
    }

    .mesa-ocupada {
        background: linear-gradient(145deg, #450a0a, #1e293b);
        border: 1px solid #ef4444;
    }

    /* KANBAN CARD */
    .kanban-card {
        background: #1e293b;
        border: 1px solid #334155;
        border-radius: 0.75rem;
        padding: 1rem;
        margin-bottom: 0.75rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        transition: all 0.2s;
        cursor: pointer;
    }

    .kanban-card:hover {
        border-color: #6366f1;
        transform: translateY(-2px);
    }

    .custom-scroll::-webkit-scrollbar {
        width: 6px;
    }

    .custom-scroll::-webkit-scrollbar-thumb {
        background-color: #475569;
        border-radius: 4px;
    }

    /* Select2 Fix */
    .select2-container--default .select2-selection--single {
        background-color: #0f172a;
        border-color: #334155;
        color: white;
        height: 42px;
        display: flex;
        align-items: center;
    }

    .select2-dropdown {
        background-color: #1e293b;
        border-color: #334155;
        color: white;
    }

    .select2-search__field {
        background-color: #0f172a;
        color: white;
    }

    .select2-container--default .select2-selection--single .select2-selection__rendered {
        color: white;
    }

    .card-checkbox {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 20;
        transform: scale(1.3);
        cursor: pointer;
        accent-color: #6366f1;
        /* Cor Indigo */
        display: none;
        /* Escondido por padrão, aparece no hover ou se selecionado */
    }

    .kanban-card:hover .card-checkbox,
    .card-checkbox:checked {
        display: block;
    }

    /* Barra de Ação em Massa (Flutuante) */
    #bulkActionBar {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%) translateY(150%);
        /* Escondido para baixo */
        background: #1e293b;
        border: 1px solid #475569;
        padding: 15px 25px;
        border-radius: 50px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        gap: 20px;
        z-index: 60;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    #bulkActionBar.active {
        transform: translateX(-50%) translateY(0);
        /* Aparece */
    }

    /* --- PDV PROFISSIONAL CSS --- */
    .pdv-layout {
        display: flex;
        height: 100%;
        overflow: hidden;
        background: #0f172a;
    }

    .pdv-left {
        width: 35%;
        background: #1e293b;
        display: flex;
        flex-direction: column;
        border-right: 1px solid #334155;
    }

    .pdv-right {
        width: 65%;
        display: flex;
        flex-direction: column;
        background: #0f172a;
    }

    /* Grid de Produtos */
    .prod-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 12px;
        padding: 16px;
        overflow-y: auto;
        align-content: start;
        /* Importante para não esticar verticalmente */
    }

    .prod-card {
        background: #1e293b;
        border: 1px solid #334155;
        border-radius: 12px;
        padding: 12px;
        cursor: pointer;
        transition: all 0.1s;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        height: 100px;
    }

    .prod-card:hover {
        border-color: #6366f1;
        background: #263346;
        transform: translateY(-2px);
    }

    .prod-card:active {
        transform: scale(0.98);
    }

    .prod-price {
        font-weight: bold;
        color: #4ade80;
        font-family: monospace;
        font-size: 0.9rem;
    }

    /* Categorias (Filtro Rápido) */
    .cat-scroll {
        display: flex;
        gap: 8px;
        padding: 12px 16px;
        overflow-x: auto;
        background: #0f172a;
        border-bottom: 1px solid #1e293b;
    }

    .cat-chip {
        background: #1e293b;
        color: #94a3b8;
        padding: 6px 16px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: bold;
        cursor: pointer;
        white-space: nowrap;
        border: 1px solid #334155;
        transition: all 0.2s;
    }

    .cat-chip.active {
        background: #6366f1;
        color: white;
        border-color: #6366f1;
    }

    /* Área de Pagamento Multi */
    .payment-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px;
        background: #0f172a;
        border-radius: 6px;
        margin-bottom: 4px;
        font-size: 0.85rem;
        border: 1px solid #334155;
    }

    .pay-btn-group {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        margin-bottom: 12px;
    }

    .pay-btn-opt {
        background: #0f172a;
        border: 1px solid #475569;
        color: #cbd5e1;
        padding: 10px;
        border-radius: 8px;
        font-weight: bold;
        font-size: 0.8rem;
        cursor: pointer;
        transition: all 0.2s;
    }

    .pay-btn-opt:hover,
    .pay-btn-opt.active {
        background: #6366f1;
        border-color: #6366f1;
        color: white;
    }

    /* Carrinho */
    .cart-item {
        padding: 10px;
        border-bottom: 1px solid #334155;
        background: #1e293b;
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
    }

    .cart-scroll {
        flex: 1;
        overflow-y: auto;
    }

    .card-oven {
        border: 3px solid #ff9800 !important;
        /* Laranja Forno */
        background-color: #fff3e0;
    }
</style>
{% endblock %}

{% block content %}

<div id="boxClosedAlert"
    class="hidden bg-red-600 text-white p-3 text-center font-bold sticky top-0 z-50 shadow-lg animate-pulse cursor-pointer"
    onclick="window.location.href='/admin/management'">
    <i class="fas fa-exclamation-triangle mr-2"></i> CAIXA FECHADO - CLIQUE AQUI PARA ABRIR
</div>

<div class="h-full flex flex-col gap-4">

    <div class="bg-slate-800 p-4 rounded-2xl border border-slate-700 shadow-lg mb-4">

        <div class="flex justify-between items-center mb-4 border-b border-slate-700 pb-3">
            <h2 class="text-sm font-bold text-slate-400 uppercase tracking-widest flex items-center gap-2">
                <i class="fas fa-satellite-dish text-indigo-500"></i> Painel de Monitoramento (Tempo Real)
            </h2>

            <div class="flex gap-2">

                <button onclick="openFeeManager()" class="bg-slate-700 hover:bg-slate-600 text-slate-300 border border-slate-600 px-3 py-1.5 rounded-lg text-xs font-bold transition flex items-center gap-2 group">
                    <i class="fas fa-map-marked-alt text-yellow-500"></i> Bairros & Taxas
                </button>    

                <button onclick="openEmployeeActionModal()"
                    class="bg-slate-700 hover:bg-indigo-600 text-white border border-slate-600 px-4 py-2 rounded-lg text-sm font-bold transition flex items-center gap-2 shadow-lg">
                    <i class="fas fa-hand-holding-usd"></i> Lançar Vale / Bônus (Equipe)
                </button>
            </div>
        </div>

        <div class="flex flex-col xl:flex-row justify-between items-center gap-6">

                <div class="flex flex-col gap-3 flex-1 w-full xl:w-auto">
                    
                    <div class="flex flex-wrap justify-center xl:justify-start gap-3">
                        <div class="flex items-center gap-3 bg-slate-900/50 px-4 py-2 rounded-xl border border-slate-700/50 min-w-[130px] flex-1 xl:flex-none">
                            <div class="w-10 h-10 rounded-full bg-orange-900/30 flex items-center justify-center border border-orange-500/30 shrink-0">
                                <i class="fas fa-pizza-slice text-orange-500 text-lg"></i>
                            </div>
                            <div>
                                <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wider block">Pizzas</span>
                                <span id="dash-qty-pizzas" class="text-2xl font-black text-white leading-none">0</span>
                            </div>
                        </div>

                        <div class="flex items-center gap-3 bg-slate-900/50 px-4 py-2 rounded-xl border border-slate-700/50 min-w-[130px] flex-1 xl:flex-none">
                            <div class="w-10 h-10 rounded-full bg-yellow-900/30 flex items-center justify-center border border-yellow-500/30 shrink-0">
                                <i class="fas fa-star text-yellow-500 text-lg"></i>
                            </div>
                            <div>
                                <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wider block">Esfihas</span>
                                <span id="dash-qty-esfihas" class="text-2xl font-black text-white leading-none">0</span>
                            </div>
                        </div>

                        <div class="flex items-center gap-3 bg-slate-900/50 px-4 py-2 rounded-xl border border-slate-700/50 min-w-[130px] flex-1 xl:flex-none">
                            <div class="w-10 h-10 rounded-full bg-red-900/30 flex items-center justify-center border border-red-500/30 shrink-0">
                                <i class="fas fa-hamburger text-red-500 text-lg"></i>
                            </div>
                            <div>
                                <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wider block">Beirutes</span>
                                <span id="dash-qty-beirutes" class="text-2xl font-black text-white leading-none">0</span>
                            </div>
                        </div>
                    </div>

                    <div class="flex flex-wrap justify-center xl:justify-start gap-3">
                        <div id="filter-btn-ifood" onclick="togglePlatformFilter('ifood')"
                            class="flex items-center gap-3 bg-slate-900/50 px-4 py-2 rounded-xl border border-slate-700/50 min-w-[120px] cursor-pointer hover:bg-slate-800 transition group select-none flex-1 xl:flex-none">
                            <div class="w-10 h-10 rounded-full bg-[#ea1d2c]/20 flex items-center justify-center border border-[#ea1d2c]/50 shrink-0 group-hover:scale-110 transition">
                                <i class="fas fa-utensils text-[#ea1d2c] text-lg"></i>
                            </div>
                            <div>
                                <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wider block group-hover:text-white">iFood</span>
                                <span id="dash-qty-ifood" class="text-2xl font-black text-white leading-none">0</span>
                            </div>
                        </div>

                        <div id="filter-btn-wabiz" onclick="togglePlatformFilter('wabiz')"
                            class="flex items-center gap-3 bg-slate-900/50 px-4 py-2 rounded-xl border border-slate-700/50 min-w-[120px] cursor-pointer hover:bg-slate-800 transition group select-none flex-1 xl:flex-none">
                            <div class="w-10 h-10 rounded-full bg-orange-600/20 flex items-center justify-center border border-orange-600/50 shrink-0 group-hover:scale-110 transition">
                                <i class="fas fa-shopping-bag text-orange-500 text-lg"></i>
                            </div>
                            <div>
                                <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wider block group-hover:text-white">Wabiz</span>
                                <span id="dash-qty-wabiz" class="text-2xl font-black text-white leading-none">0</span>
                            </div>
                        </div>

                        <div id="filter-btn-pdv" onclick="togglePlatformFilter('pdv')"
                            class="flex items-center gap-3 bg-slate-900/50 px-4 py-2 rounded-xl border border-slate-700/50 min-w-[120px] cursor-pointer hover:bg-slate-800 transition group select-none flex-1 xl:flex-none">
                            <div class="w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center border border-slate-600 shrink-0 group-hover:scale-110 transition">
                                <i class="fas fa-desktop text-slate-300 text-lg"></i>
                            </div>
                            <div>
                                <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wider block group-hover:text-white">Loja</span>
                                <span id="dash-qty-pdv" class="text-2xl font-black text-white leading-none">0</span>
                            </div>
                        </div>
                    </div>

                </div>

                <div class="flex w-full xl:w-auto gap-3 items-start xl:items-center">
                     <button onclick="toggleFullScreen()" class="bg-slate-700 hover:bg-slate-600 text-slate-300 w-12 h-[46px] rounded-xl font-bold text-lg shadow-inner transition flex items-center justify-center" title="Modo TV"><i class="fas fa-expand"></i></button>

                     <button onclick="testSoundSystem()" class="bg-yellow-600 hover:bg-yellow-500 text-white w-12 h-[46px] rounded-xl font-bold text-lg shadow-inner transition flex items-center justify-center ml-2" title="Testar Som"><i class="fas fa-volume-up"></i></button>
     
                     <div class="relative flex-1 xl:w-64 min-w-[200px]"> 
                         <select id="driverFilter" onchange="toggleDriverFilter(this.value)" class="w-full bg-slate-900 border border-slate-600 rounded-xl px-3 py-3 text-sm text-white outline-none focus:border-indigo-500 transition shadow-inner font-medium appearance-none cursor-pointer mb-2 xl:mb-0 xl:hidden"> <option value="">Todos Motoboys</option>
                            {% for driver in drivers %}
                                <option value="{{ driver.id }}">{{ driver.full_name }}</option>
                            {% endfor %}
                        </select>

                         <input type="text" id="globalSearch" placeholder="Buscar pedido, cliente..." class="w-full bg-slate-900 border border-slate-600 rounded-xl pl-10 pr-4 py-3 text-base text-white outline-none focus:border-indigo-500 transition shadow-inner font-medium">
                         <i class="fas fa-search absolute left-3.5 top-3.5 text-slate-500"></i>
                     </div>
     
                     <button onclick="openPDV()" class="bg-indigo-600 hover:bg-indigo-500 text-white px-6 py-3 rounded-xl font-bold text-sm shadow-lg shadow-indigo-900/30 flex items-center gap-2 whitespace-nowrap transition active:scale-95">
                         <i class="fas fa-plus-circle text-lg"></i> <span class="hidden sm:inline">Novo Pedido</span>
                     </button>
                </div>
            </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-2">

        <div id="btn-hud-delivery" onclick="switchTab('delivery')"
            class="bg-slate-800 border border-slate-700 p-3 rounded-xl flex items-center justify-between cursor-pointer hover:border-indigo-500 transition group shadow-lg">
            <div class="flex items-center gap-3">
                <div
                    class="w-10 h-10 rounded-full bg-indigo-900/50 flex items-center justify-center text-indigo-400 border border-indigo-500/30 group-hover:bg-indigo-600 group-hover:text-white transition">
                    <i class="fas fa-motorcycle text-lg"></i>
                </div>
                <div>
                    <h4 class="text-xs font-bold text-slate-400 uppercase tracking-wider group-hover:text-indigo-300">
                        Delivery</h4>
                    <span class="text-xl font-bold text-white" id="hud-del-total">0</span> <span
                        class="text-xs text-slate-500">ativos</span>
                </div>
            </div>
            <div class="flex gap-2 text-right">
                <div class="bg-slate-900 px-2 py-1 rounded border border-slate-700/50">
                    <div class="text-[10px] text-orange-400 font-bold uppercase">Cozinha</div>
                    <div class="text-sm font-bold text-white" id="hud-del-prep">0</div>
                </div>
                <div class="bg-slate-900 px-2 py-1 rounded border border-slate-700/50">
                    <div class="text-[10px] text-emerald-400 font-bold uppercase">Entrega</div>
                    <div class="text-sm font-bold text-white" id="hud-del-ready">0</div>
                </div>
            </div>
        </div>

        <div id="btn-hud-balcao" onclick="switchTab('balcao')"
            class="bg-slate-800 border border-slate-700 p-3 rounded-xl flex items-center justify-between cursor-pointer hover:border-blue-500 transition group shadow-lg">
            <div class="flex items-center gap-3">
                <div
                    class="w-10 h-10 rounded-full bg-blue-900/50 flex items-center justify-center text-blue-400 border border-blue-500/30 group-hover:bg-blue-600 group-hover:text-white transition">
                    <i class="fas fa-walking text-lg"></i>
                </div>
                <div>
                    <h4 class="text-xs font-bold text-slate-400 uppercase tracking-wider group-hover:text-blue-300">
                        Balcão</h4>
                    <span class="text-xl font-bold text-white" id="hud-bal-total">0</span> <span
                        class="text-xs text-slate-500">ativos</span>
                </div>
            </div>
            <div class="flex gap-2 text-right">
                <div class="bg-slate-900 px-2 py-1 rounded border border-slate-700/50">
                    <div class="text-[10px] text-orange-400 font-bold uppercase">Cozinha</div>
                    <div class="text-sm font-bold text-white" id="hud-bal-prep">0</div>
                </div>
                <div class="bg-slate-900 px-2 py-1 rounded border border-slate-700/50">
                    <div class="text-[10px] text-green-400 font-bold uppercase">Retirar</div>
                    <div class="text-sm font-bold text-white" id="hud-bal-ready">0</div>
                </div>
            </div>
        </div>

        <div id="btn-hud-mesas" onclick="switchTab('mesas')"
            class="bg-slate-800 border border-slate-700 p-3 rounded-xl flex items-center justify-between cursor-pointer hover:border-orange-500 transition group shadow-lg">
            <div class="flex items-center gap-3">
                <div
                    class="w-10 h-10 rounded-full bg-orange-900/50 flex items-center justify-center text-orange-400 border border-orange-500/30 group-hover:bg-orange-600 group-hover:text-white transition">
                    <i class="fas fa-chair text-lg"></i>
                </div>
                <div>
                    <h4 class="text-xs font-bold text-slate-400 uppercase tracking-wider group-hover:text-orange-300">
                        Salão</h4>
                    <span class="text-xl font-bold text-white" id="hud-mesas-total">0</span> <span
                        class="text-xs text-slate-500">mesas</span>
                </div>
            </div>
            <div class="text-right pr-2">
                <div class="text-xs text-slate-400">Ocupação</div>
                <div class="text-sm font-bold text-green-400">Ativo</div>
            </div>
        </div>

    </div>

    <div class="flex-1 relative min-h-[60vh]">
        <div id="loader" class="absolute inset-0 z-10 flex items-center justify-center bg-slate-900/50 hidden">
            <i class="fas fa-circle-notch fa-spin text-4xl text-indigo-500"></i>
        </div>

        <div id="view-mesas" class="tab-content active">
            <div class="flex justify-between mb-4 items-center">
                <h3 class="text-white font-bold flex items-center gap-2"><i class="fas fa-th text-slate-400"></i> Mapa
                    de Salão</h3>
                <div class="flex gap-4 text-xs font-bold uppercase tracking-wide">
                    <span class="flex items-center gap-2 text-slate-400">
                        <div class="w-3 h-3 bg-slate-700 border border-slate-500 rounded"></div> Livre
                    </span>
                    <span class="flex items-center gap-2 text-red-400">
                        <div class="w-3 h-3 bg-red-900 border border-red-500 rounded"></div> Ocupada
                    </span>
                </div>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 2xl:grid-cols-6 gap-5"
                id="grid-mesas"></div>
        </div>

        <div id="view-delivery" class="tab-content h-full">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 h-full">

                <div class="flex flex-col bg-slate-800/50 rounded-xl border border-slate-700/50 h-full">
                    <div
                        class="p-3 border-b border-slate-700 bg-slate-800 rounded-t-xl flex justify-between items-center sticky top-0 z-10 shadow-md border-t-4 border-orange-500">
                        <h3 class="font-bold text-white text-sm flex items-center gap-2">
                            <i class="fas fa-fire text-orange-500"></i> COZINHA
                        </h3>
                        <span id="count-kanban-PREPARO"
                            class="text-xs bg-slate-700 px-2 py-0.5 rounded text-white font-bold">0</span>
                    </div>
                    <div class="p-3 space-y-3 flex-1 overflow-y-auto custom-scroll max-h-[70vh]"
                        id="kanban-col-PREPARO"></div>
                </div>

                <div class="flex flex-col bg-slate-800/50 rounded-xl border border-slate-700/50 h-full relative">
                    <div
                        class="p-3 border-b border-slate-700 bg-slate-800 rounded-t-xl flex justify-between items-center sticky top-0 z-10 shadow-md border-t-4 border-emerald-500">
                        <h3 class="font-bold text-white text-sm flex items-center gap-2">
                            <i class="fas fa-map-signs text-emerald-500"></i> ROTAS / PRONTO
                        </h3>
                        <span id="count-kanban-PRONTO"
                            class="text-xs bg-slate-700 px-2 py-0.5 rounded text-white font-bold">0</span>
                    </div>
                    <div
                        class="absolute inset-0 opacity-5 pointer-events-none bg-[url('https://www.transparenttextures.com/patterns/black-scales.png')]">
                    </div>
                    <div class="p-3 space-y-3 flex-1 overflow-y-auto custom-scroll max-h-[70vh]" id="kanban-col-PRONTO">
                    </div>
                </div>

                <div class="flex flex-col bg-slate-800/50 rounded-xl border border-slate-700/50 h-full">
                    <div
                        class="p-3 border-b border-slate-700 bg-slate-800 rounded-t-xl flex justify-between items-center sticky top-0 z-10 shadow-md border-t-4 border-blue-500">
                        <h3 class="font-bold text-white text-sm flex items-center gap-2">
                            <i class="fas fa-motorcycle text-blue-500"></i> DESPACHADO
                        </h3>
                        <span id="count-kanban-SAIU_ENTREGA"
                            class="text-xs bg-slate-700 px-2 py-0.5 rounded text-white font-bold">0</span>
                    </div>
                    <div class="p-3 space-y-3 flex-1 overflow-y-auto custom-scroll max-h-[70vh]"
                        id="kanban-col-SAIU_ENTREGA"></div>
                </div>

                <div class="flex flex-col bg-slate-800/50 rounded-xl border border-slate-700/50 h-full">
                    <div
                        class="p-3 border-b border-slate-700 bg-slate-800 rounded-t-xl flex justify-between items-center sticky top-0 z-10 shadow-md border-t-4 border-slate-500">
                        <h3 class="font-bold text-slate-400 text-sm flex items-center gap-2">
                            <i class="fas fa-check-double"></i> A FINALIZAR
                        </h3>
                        <span id="count-kanban-ENTREGUE"
                            class="text-xs bg-slate-700 px-2 py-0.5 rounded text-white font-bold">0</span>
                    </div>
                    <div class="p-3 space-y-3 flex-1 overflow-y-auto custom-scroll max-h-[70vh]"
                        id="kanban-col-ENTREGUE"></div>
                </div>

            </div>
        </div>

        <div id="view-balcao" class="tab-content h-full">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 h-full">

                <div class="flex flex-col bg-slate-800/50 rounded-xl border border-slate-700/50 h-full">
                    <div
                        class="p-3 border-b border-slate-700 bg-slate-800 rounded-t-xl flex justify-between items-center sticky top-0 z-10 shadow-md border-t-4 border-orange-500">
                        <h3 class="font-bold text-white text-sm flex items-center gap-2">
                            <i class="fas fa-fire text-orange-500"></i> COZINHA
                        </h3>
                        <span id="count-balcao-PREPARO"
                            class="text-xs bg-slate-700 px-2 py-0.5 rounded text-white font-bold">0</span>
                    </div>
                    <div class="p-3 space-y-3 flex-1 overflow-y-auto custom-scroll max-h-[70vh]"
                        id="balcao-col-PREPARO"></div>
                </div>

                <div class="flex flex-col bg-slate-800/50 rounded-xl border border-slate-700/50 h-full">
                    <div
                        class="p-3 border-b border-slate-700 bg-slate-800 rounded-t-xl flex justify-between items-center sticky top-0 z-10 shadow-md border-t-4 border-emerald-500">
                        <h3 class="font-bold text-white text-sm flex items-center gap-2">
                            <i class="fas fa-box-open text-emerald-500"></i> AGUARDANDO RETIRADA
                        </h3>
                        <span id="count-balcao-PRONTO"
                            class="text-xs bg-slate-700 px-2 py-0.5 rounded text-white font-bold">0</span>
                    </div>
                    <div class="p-3 space-y-3 flex-1 overflow-y-auto custom-scroll max-h-[70vh]" id="balcao-col-PRONTO">
                    </div>
                </div>

                <div class="flex flex-col bg-slate-800/50 rounded-xl border border-slate-700/50 h-full">
                    <div
                        class="p-3 border-b border-slate-700 bg-slate-800 rounded-t-xl flex justify-between items-center sticky top-0 z-10 shadow-md border-t-4 border-blue-500">
                        <h3 class="font-bold text-white text-sm flex items-center gap-2">
                            <i class="fas fa-clipboard-check text-blue-500"></i> A FINALIZAR
                        </h3>
                        <span id="count-balcao-ENTREGUE"
                            class="text-xs bg-slate-700 px-2 py-0.5 rounded text-white font-bold">0</span>
                    </div>
                    <div class="p-3 space-y-3 flex-1 overflow-y-auto custom-scroll max-h-[70vh]"
                        id="balcao-col-ENTREGUE"></div>
                </div>

            </div>
        </div>
    </div>
</div>

<div id="pdvModal" class="fixed inset-0 z-[60] hidden flex items-center justify-center p-0 md:p-4">
    <div class="absolute inset-0 bg-black/95 backdrop-blur-sm" onclick="closePDV()"></div>

    <div
        class="relative w-full h-full md:h-[95vh] md:max-w-[95vw] bg-slate-900 md:rounded-2xl shadow-2xl border border-slate-700 flex flex-col overflow-hidden">

        <div class="h-14 bg-slate-800 border-b border-slate-700 flex justify-between items-center px-4 shrink-0">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-full bg-indigo-600 flex items-center justify-center text-white font-bold">
                    <i class="fas fa-cash-register"></i>
                </div>
                <div>
                    <h2 class="text-base font-bold text-white leading-none" id="pdvTitle">Novo Pedido</h2>
                    <span class="text-[10px] text-slate-400" id="pdvSubtitle">Balcão & Delivery</span>
                </div>
            </div>

            <div class="flex items-center gap-2">
                <button id="btnCancelPDV" type="button" onclick="cancelCurrentPdvOrder()"
                    class="hidden bg-red-900/20 hover:bg-red-900/40 text-red-400 border border-red-500/30 px-3 py-1.5 rounded-lg text-xs font-bold transition flex items-center gap-2 mr-2">
                    <i class="fas fa-trash-alt"></i> Cancelar Pedido
                </button>

                <button onclick="minimizeCurrentPDV()" class="text-slate-400 hover:text-indigo-400 p-2 mr-1 transition" title="Minimizar / Nova Aba">
                    <i class="fas fa-window-minimize text-sm mb-1"></i>
                </button>

                <button onclick="closePDV()" class="text-slate-400 hover:text-white p-2">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
        </div>

        <div class="flex-1 flex overflow-hidden">

            <div class="pdv-left w-full md:w-[380px] lg:w-[420px] flex flex-col bg-slate-800 border-r border-slate-700 shadow-xl z-20 overflow-y-auto">

                <div class="flex flex-col bg-slate-800 border-b border-slate-700 shadow-sm z-10">

                    <div class="p-3 pb-0 relative">
                        <div class="relative group">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i
                                    class="fas fa-search text-slate-500 group-focus-within:text-indigo-400 transition"></i>
                            </div>
                            <input type="text" id="pdvSearch" placeholder="Buscar Cliente (F2)"
                                class="w-full bg-slate-900 border border-slate-600 text-white text-sm rounded-xl block pl-10 p-3 outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 transition placeholder-slate-500"
                                oninput="searchClient(this.value)" autocomplete="off">
                        </div>
                        <div id="clientList"
                            class="hidden absolute top-full left-3 right-3 bg-slate-800 border border-slate-600 rounded-b-xl shadow-2xl z-50 max-h-60 overflow-y-auto custom-scroll mt-1">
                        </div>
                    </div>

                    <div id="selectedClientBox"
                        class="hidden mx-3 mt-3 bg-indigo-500/10 border border-indigo-500/30 rounded-xl p-3 relative group transition-all">
                        <button onclick="clearClient()"
                            class="absolute top-2 right-2 text-slate-400 hover:text-red-400 p-1 transition bg-slate-800/50 rounded-full w-6 h-6 flex items-center justify-center"
                            title="Remover Cliente">
                            <i class="fas fa-times text-xs"></i>
                        </button>

                        <div class="flex items-center gap-3 mb-2">
                            <div
                                class="w-10 h-10 rounded-full bg-indigo-600 flex items-center justify-center text-white font-bold shadow-md">
                                <i class="fas fa-user"></i>
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="text-sm font-bold text-white leading-tight truncate" id="lblClientName">
                                    Cliente</div>
                                <div class="text-xs text-indigo-300 font-mono mt-0.5" id="lblClientPhone">--</div>
                            </div>
                            <button onclick="editClientFull()" class="text-slate-400 hover:text-white transition px-2"
                                title="Editar Cadastro">
                                <i class="fas fa-pen text-xs"></i>
                            </button>
                        </div>

                        <div class="bg-slate-900/60 rounded-lg p-2 border border-slate-700/50 flex items-start gap-2">
                            <i class="fas fa-map-marker-alt text-red-400 mt-0.5 text-xs"></i>
                            <div class="flex-1 min-w-0">
                                <div class="text-[11px] text-slate-300 leading-snug break-words" id="lblClientAddress">
                                    Sem endereço</div>
                            </div>
                            <button onclick="editAddress()" class="text-slate-500 hover:text-indigo-400 text-xs px-1"
                                title="Trocar Endereço">
                                <i class="fas fa-exchange-alt"></i>
                            </button>
                        </div>
                    </div>

                    <input type="hidden" id="pdvName"><input type="hidden" id="pdvPhone">
                    <input type="hidden" id="pdvStreet"><input type="hidden" id="pdvNum"><input type="hidden"
                        id="pdvNeigh">
                    <input type="hidden" id="pdvOrderId"><input type="hidden" id="pdvTableNum">

                    <div class="p-3">
                        <div class="grid grid-cols-2 bg-slate-900 p-1 rounded-xl border border-slate-700 shadow-inner">
                            <button onclick="setDeliveryMode('balcao')" id="btnModeBalcao"
                                class="py-2 rounded-lg text-xs font-bold text-slate-400 hover:text-white transition flex items-center justify-center gap-2">
                                <i class="fas fa-store"></i> BALCÃO
                            </button>
                            <button onclick="setDeliveryMode('delivery')" id="btnModeDelivery"
                                class="py-2 rounded-lg text-xs font-bold text-slate-400 hover:text-white transition flex items-center justify-center gap-2">
                                <i class="fas fa-motorcycle"></i> ENTREGA
                            </button>
                        </div>
                        <input type="hidden" id="pdvDeliveryType" value="balcao">
                    </div>
                </div>

                <div class="flex-1 overflow-y-auto custom-scroll bg-slate-900/30 min-h-[300px]" id="cartList">
                </div>

                <div
                    class="bg-slate-800 border-t border-slate-700 shadow-[0_-5px_15px_rgba(0,0,0,0.3)] z-20 flex flex-col">

                    <button onclick="openCheckOrderModal()"
                        class="w-full bg-slate-700/50 hover:bg-slate-700 text-slate-400 hover:text-yellow-400 py-2 text-[10px] font-bold uppercase tracking-wider transition border-b border-slate-700 flex items-center justify-center gap-2">
                        <i class="fas fa-clipboard-check"></i> Conferir Pedido em Tela Cheia
                    </button>

                    <div class="p-4 space-y-4">

                        <div id="finalizationFields"
                            class="hidden bg-slate-900 p-3 rounded-xl border border-green-500/30">
                            <div
                                class="text-[10px] text-green-400 font-bold uppercase mb-2 text-center border-b border-green-500/20 pb-1">
                                Conferência</div>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="text-[9px] text-slate-500 font-bold block uppercase">Caixinha</label>
                                    <input type="number" id="valTip"
                                        class="w-full bg-slate-800 border border-slate-600 rounded p-1.5 text-white text-right text-xs focus:border-green-500 outline-none">
                                </div>
                                <div>
                                    <label class="text-[9px] text-slate-500 font-bold block uppercase">Crédito</label>
                                    <input type="number" id="valCredit"
                                        class="w-full bg-slate-800 border border-slate-600 rounded p-1.5 text-white text-right text-xs focus:border-blue-500 outline-none">
                                </div>
                            </div>
                            <button id="btnConcludeForever" onclick="finalizeOrderForever()"
                                class="hidden w-full mt-3 bg-green-600 hover:bg-green-500 text-white py-2.5 rounded-lg font-bold text-xs shadow-lg flex items-center justify-center gap-2">
                                <i class="fas fa-check-double"></i> CONCLUIR E ARQUIVAR
                            </button>
                        </div>

                        <div class="grid grid-cols-3 gap-3">
                            <div
                                class="bg-slate-900 rounded-lg border border-slate-600 px-2 py-1.5 relative group focus-within:border-yellow-500 transition">
                                <label
                                    class="text-[8px] text-slate-500 uppercase font-bold absolute -top-2 left-2 bg-slate-800 px-1 group-focus-within:text-yellow-500">Entrega</label>
                                <div class="flex items-center">
                                    <span class="text-slate-500 text-[10px] mr-1">R$</span>
                                    <input type="number" id="valFee" value="0" oninput="renderCart()"
                                        class="bg-transparent text-right text-sm text-yellow-400 font-mono font-bold w-full outline-none p-0">
                                </div>
                            </div>

                            <div
                                class="bg-slate-900 rounded-lg border border-slate-600 px-2 py-1.5 relative group focus-within:border-red-500 transition">
                                <label
                                    class="text-[8px] text-slate-500 uppercase font-bold absolute -top-2 left-2 bg-slate-800 px-1 group-focus-within:text-red-500">Desc.</label>
                                <div class="flex items-center">
                                    <span class="text-slate-500 text-[10px] mr-1">%</span>
                                    <input type="number" id="valDisc" value="0" oninput="renderCart()"
                                        class="bg-transparent text-right text-sm text-red-400 font-mono font-bold w-full outline-none p-0">
                                </div>
                            </div>

                            <label
                                class="flex flex-col justify-center items-center bg-slate-900 rounded-lg border border-slate-600 cursor-pointer hover:bg-slate-700 transition relative">
                                <input type="checkbox" id="chkService10" onchange="renderCart()" class="peer sr-only">
                                <span
                                    class="text-[9px] text-slate-400 uppercase font-bold peer-checked:text-indigo-400">10%
                                    Serv.</span>
                                <div
                                    class="w-3 h-3 rounded-full border border-slate-500 mt-0.5 peer-checked:bg-indigo-500 peer-checked:border-indigo-500">
                                </div>
                            </label>
                        </div>

                        <div class="flex justify-between items-end border-t border-slate-700 pt-3">
                            <div class="flex flex-col">
                                <span class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Total a
                                    Pagar</span>
                                <div class="text-xs text-slate-500" id="itemsCountBadge">0 itens</div>
                            </div>
                            <span class="text-3xl font-black text-emerald-400 font-mono leading-none tracking-tight"
                                id="lblTotal">R$ 0,00</span>
                        </div>

                        <div class="flex gap-3">
                            <button id="btnSaveOrder" onclick="saveOrderDraft()"
                                class="flex-1 bg-slate-700 hover:bg-indigo-600 hover:text-white text-slate-300 py-3.5 rounded-xl font-bold text-sm shadow-md transition flex items-center justify-center gap-2 group">
                                <i class="fas fa-save text-slate-400 group-hover:text-white"></i> Salvar
                            </button>

                            <button id="btnOpenPay" onclick="openPaymentLayer()"
                                class="flex-[1.5] bg-emerald-600 hover:bg-emerald-500 text-white py-3.5 rounded-xl font-bold text-lg shadow-lg shadow-emerald-900/30 flex items-center justify-center gap-2 transition transform active:scale-[0.98]">
                                <i class="fas fa-wallet"></i> PAGAR
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pdv-right flex-1 flex flex-col relative overflow-hidden">

                <div class="p-3 bg-slate-800/80 border-b border-slate-700 flex gap-2">
                    <div class="relative flex-1">
                        <i class="fas fa-search absolute left-3 top-3 text-slate-500"></i>
                        <input type="text" id="prodSearch" onkeyup="filterProductsGrid()"
                            placeholder="Procurar produto (Nome, Cód)..."
                            class="w-full bg-slate-900 border border-slate-600 rounded-lg pl-9 pr-4 py-2.5 text-white text-sm outline-none focus:border-indigo-500">
                    </div>
                </div>

                <div class="cat-scroll custom-scroll" id="catFilterContainer">
                    <div class="cat-chip active" onclick="filterGridCategory('all', this)">Tudo</div>
                </div>

                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-3 p-4 bg-slate-900 flex-1 overflow-y-auto min-h-0 content-start custom-scroll"
                    id="prodGrid">
                </div>

                
                <div id="paymentLayer" class="absolute inset-0 bg-slate-900 z-50 transform translate-y-full transition-transform duration-300 flex flex-col">
                    
                    <div class="p-4 border-b border-slate-700 bg-slate-800 flex justify-between items-center">
                        <h3 class="font-bold text-white text-lg">
                            <i class="fas fa-coins text-yellow-400 mr-2"></i> Finalizar Pagamento
                        </h3>
                        <button onclick="closePaymentLayer()" class="text-slate-400 hover:text-white">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>

                    <div class="flex-1 p-6 overflow-y-auto flex flex-col items-center">
                        
                        <div class="text-slate-400 text-sm mb-1">Total a Pagar</div>
                        <div class="text-4xl font-bold text-white font-mono mb-6" id="payTotalDisplay">R$ 0,00</div>

                        <div class="w-full max-w-md space-y-4">
                            
                            <p id="payInputLabel" class="text-xs font-bold text-slate-400 ml-1 mb-1">Valor do Pagamento</p>
                            <div class="flex gap-2">
                                <div class="relative flex-1">
                                    <span class="absolute left-3 top-3 text-slate-500 font-bold">R$</span>
                                    <input type="number" id="payInputVal"
                                        class="w-full bg-slate-800 border border-slate-600 rounded-lg py-3 pl-10 pr-4 text-white font-bold text-lg outline-none focus:border-indigo-500 placeholder-slate-600 transition-colors"
                                        onkeydown="if(event.key === 'Enter') addPayment()">
                                </div>
                                <button onclick="addPayment()"
                                    class="bg-indigo-600 hover:bg-indigo-500 text-white px-6 rounded-lg font-bold shadow-lg active:scale-95 transition">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>

                            <div class="grid grid-cols-2 gap-2">
                                <div class="pay-btn-opt bg-slate-700 hover:bg-slate-600 p-3 rounded cursor-pointer text-white font-bold text-center border border-slate-600" onclick="selectPayMethod('Pix', this)">
                                    <i class="fab fa-pix mr-1 text-emerald-400"></i> PIX
                                </div>
                                <div class="pay-btn-opt bg-slate-700 hover:bg-slate-600 p-3 rounded cursor-pointer text-white font-bold text-center border border-slate-600" onclick="selectPayMethod('Dinheiro', this)">
                                    <i class="fas fa-money-bill-wave mr-1 text-green-400"></i> Dinheiro
                                </div>
                                <div class="pay-btn-opt bg-slate-700 hover:bg-slate-600 p-3 rounded cursor-pointer text-white font-bold text-center border border-slate-600" onclick="selectPayMethod('Cartão Crédito', this)">
                                    <i class="far fa-credit-card mr-1 text-blue-400"></i> Crédito
                                </div>
                                <div class="pay-btn-opt bg-slate-700 hover:bg-slate-600 p-3 rounded cursor-pointer text-white font-bold text-center border border-slate-600" onclick="selectPayMethod('Cartão Débito', this)">
                                    <i class="fas fa-credit-card mr-1 text-orange-400"></i> Débito
                                </div>
                                
                                <div class="col-span-2 bg-indigo-900/30 border border-indigo-500/30 text-indigo-300 hover:bg-indigo-900/50 p-3 rounded cursor-pointer text-center font-bold" onclick="payWithEmployeeAccount()">
                                    <i class="fas fa-user-tag mr-1"></i> CONTA FUNCIONÁRIO
                                </div>
                                <div class="col-span-2 bg-red-900/20 border border-red-500/30 text-red-300 hover:bg-red-900/40 p-3 rounded cursor-pointer text-center font-bold" onclick="selectPayMethod('Fiado', this)">
                                    <i class="fas fa-book-dead mr-1"></i> FIADO / CARTEIRA
                                </div>
                            </div>
                            
                            <input type="hidden" id="selectedMethod" value="">

                            <div id="paymentListEl" class="bg-slate-800 rounded-xl border border-slate-700 p-2 space-y-1 min-h-[100px] mt-4">
                                <div class="text-center text-slate-500 text-xs py-4">Nenhum pagamento lançado.</div>
                            </div>

                            <div class="flex justify-between items-center text-sm font-bold border-t border-slate-700 pt-3 mt-2">
                                <span class="text-slate-400">Status:</span>
                                <div id="payRestanteDisplay" class="text-lg">---</div>
                            </div>
                        </div>
                    </div>

                    <div class="p-4 border-t border-slate-700 bg-slate-800">
                        <div class="flex gap-3">
                            <button onclick="actionSavePayment()" id="btnActionSave"
                                class="flex-1 bg-slate-700 hover:bg-slate-600 text-slate-200 py-4 rounded-xl font-bold text-sm shadow-md flex items-center justify-center gap-2 transition border border-slate-600">
                                <i class="fas fa-save"></i> SALVAR PAGAMENTO
                            </button>
                    
                            <button onclick="actionPayAndFinish()" id="btnActionFinish"
                                class="flex-[1.5] bg-emerald-600 hover:bg-emerald-500 text-white py-4 rounded-xl font-bold text-lg shadow-lg flex items-center justify-center gap-2 transition transform active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed">
                                <i class="fas fa-check-double"></i> PAGAR E FINALIZAR
                            </button>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<div id="checkoutModal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4">
    <div class="absolute inset-0 bg-black/90 backdrop-blur-sm" onclick="closeCheckoutModal()"></div>
    <div class="relative w-full max-w-md bg-slate-800 rounded-2xl shadow-2xl border border-slate-600 p-6 fade-in">
        <h3 class="text-xl font-bold text-white mb-1 flex items-center gap-2"><i
                class="fas fa-receipt text-yellow-400"></i> Fechar Mesa <span id="chkTableNum"></span></h3>
        <p class="text-xs text-slate-400 mb-6">Confira os valores e selecione o pagamento.</p>
        <div class="bg-slate-900/50 p-4 rounded-xl border border-slate-700 space-y-2 mb-6">
            <div class="flex justify-between text-sm text-slate-300"><span>Consumo</span><span id="chkSubtotal"
                    data-val="0">R$ 0,00</span></div>
            <label class="flex justify-between items-center cursor-pointer hover:bg-slate-800 p-1 rounded -mx-1">
                <div class="flex items-center gap-2"><input type="checkbox" id="chkServiceFee" checked
                        onchange="calcCheckout()"
                        class="w-4 h-4 rounded bg-slate-700 border-slate-500 text-yellow-500 focus:ring-0"><span
                        class="text-sm text-yellow-400 font-bold">Taxa de Serviço (10%)</span></div><span id="chkFeeVal"
                    class="text-sm text-yellow-400 font-mono">R$ 0,00</span>
            </label>
            <div class="flex justify-between text-sm text-slate-300"><span>Desconto</span><input type="number"
                    id="chkDiscount" value="0" onchange="calcCheckout()"
                    class="w-20 bg-slate-800 border border-slate-600 rounded p-1 text-right text-xs text-red-400 outline-none">
            </div>
            <div class="border-t border-slate-700 pt-2 flex justify-between items-center"><span
                    class="font-bold text-white text-lg">TOTAL FINAL</span><span
                    class="font-bold text-green-400 text-2xl font-mono" id="chkFinalTotal" data-val="0">R$ 0,00</span>
            </div>
        </div>
        <div class="space-y-3"><label class="text-xs font-bold text-slate-500 uppercase">Forma de Pagamento</label>
            <div class="grid grid-cols-2 gap-2"><button type="button" onclick="setPayMethod('Pix')"
                    class="pay-btn bg-slate-900 border border-slate-600 text-slate-300 py-2 rounded hover:border-green-500 hover:text-white transition text-xs font-bold">PIX</button><button
                    type="button" onclick="setPayMethod('Cartão Crédito')"
                    class="pay-btn bg-slate-900 border border-slate-600 text-slate-300 py-2 rounded hover:border-blue-500 hover:text-white transition text-xs font-bold">CRÉDITO</button><button
                    type="button" onclick="setPayMethod('Cartão Débito')"
                    class="pay-btn bg-slate-900 border border-slate-600 text-slate-300 py-2 rounded hover:border-blue-400 hover:text-white transition text-xs font-bold">DÉBITO</button><button
                    type="button" onclick="setPayMethod('Dinheiro')"
                    class="pay-btn bg-slate-900 border border-slate-600 text-slate-300 py-2 rounded hover:border-yellow-500 hover:text-white transition text-xs font-bold">DINHEIRO</button>
            </div><input type="hidden" id="chkPayMethod">
        </div>
        <div class="flex gap-3 mt-6"><button onclick="sendBillWhatsapp()"
                class="flex-1 bg-green-600/20 hover:bg-green-600/40 text-green-400 border border-green-600/50 py-3 rounded-xl font-bold text-sm flex items-center justify-center gap-2 transition"><i
                    class="fab fa-whatsapp text-lg"></i> Enviar Comanda</button><button onclick="confirmCloseAccount()"
                class="flex-[2] bg-indigo-600 hover:bg-indigo-500 text-white py-3 rounded-xl font-bold text-sm shadow-lg">RECEBER
                E FECHAR</button></div>
    </div>
</div>

<div id="dispatchModal" class="fixed inset-0 z-[9999] hidden flex items-center justify-center p-4">
    <div class="absolute inset-0 bg-black/90 backdrop-blur-sm" onclick="closeDispatchModal()"></div>
    <div class="relative w-full max-w-sm bg-slate-800 rounded-2xl border border-slate-600 p-6 fade-in">
        <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2"><i
                class="fas fa-motorcycle text-orange-400"></i> Despachar Pedido</h3>
        <input type="hidden" id="dspOrderId">
        <label class="text-xs font-bold text-slate-500 uppercase mb-2 block">Selecione o Entregador</label>
        <select id="dspDriverSelect"
            class="w-full bg-slate-900 border border-slate-600 rounded-lg p-3 text-white outline-none mb-4 focus:border-orange-500">
            <option value="">Selecione...</option>
            {% for d in drivers %}
            <option value="{{ d.id }}">{{ d.full_name }}</option>
            {% endfor %}
        </select>
        <button onclick="confirmDispatch()"
            class="w-full bg-orange-600 hover:bg-orange-500 text-white py-3 rounded-xl font-bold shadow-lg">CONFIRMAR
            SAÍDA</button>
    </div>
</div>

<div id="pizzaModal"
    class="fixed inset-0 z-[70] hidden flex items-center justify-center p-4 bg-black/90 backdrop-blur-md">
    <div
        class="relative w-full max-w-6xl bg-slate-900 rounded-2xl border border-slate-700 shadow-2xl flex flex-col max-h-[95vh] overflow-hidden">

        <div class="p-5 bg-slate-800 border-b border-slate-700 flex justify-between items-center shrink-0">
            <div>
                <h3 class="text-xl font-bold text-white flex items-center gap-2">
                    <i class="fas fa-pizza-slice text-orange-500"></i> Montar Pizza
                </h3>
                <p class="text-xs text-slate-400">Selecione tamanho, sabores e personalizações.</p>
            </div>
            <button onclick="closePizzaModal()"
                class="w-8 h-8 rounded-full bg-slate-700 text-slate-400 hover:text-white flex items-center justify-center transition">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="flex-1 overflow-y-auto custom-scroll p-6 space-y-8">

            <div class="space-y-3">
                <label class="text-xs font-bold text-indigo-400 uppercase tracking-wider flex items-center gap-2">
                    <span
                        class="bg-indigo-500/20 w-5 h-5 rounded-full flex items-center justify-center text-[10px] border border-indigo-500/30">1</span>
                    Escolha o Tamanho
                </label>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3" id="pizzaSizesBox">
                </div>
            </div>

            <div id="stepFlavors" class="hidden space-y-4 animate-fade-in-up">
                <div class="flex justify-between items-end">
                    <label class="text-xs font-bold text-orange-400 uppercase tracking-wider flex items-center gap-2">
                        <span
                            class="bg-orange-500/20 w-5 h-5 rounded-full flex items-center justify-center text-[10px] border border-orange-500/30">Mais</span>
                        Sabores
                    </label>
                    <span id="flavorCounter"
                        class="text-[10px] font-bold bg-slate-800 px-2 py-1 rounded text-slate-400 border border-slate-700">1/2
                        Selecionados</span>
                </div>

                <div id="flavorsContainer" class="space-y-3"></div>

                <button id="btnAddFlavor" type="button" onclick="addFlavorRow()"
                    class="hidden w-full py-3 bg-slate-800 border border-dashed border-slate-600 rounded-xl text-slate-400 hover:text-white hover:border-orange-500 hover:bg-orange-500/10 transition text-xs font-bold flex items-center justify-center gap-2">
                    <i class="fas fa-plus-circle"></i> Adicionar Outro Sabor
                </button>

                <div id="pizzaIngsBox"
                    class="hidden mt-4 bg-slate-800/50 p-4 rounded-xl border border-slate-700 relative">
                    <div
                        class="absolute -top-2.5 left-3 bg-slate-900 px-2 text-[10px] font-bold text-red-400 uppercase tracking-wide border border-slate-700 rounded">
                        <i class="fas fa-minus-circle mr-1"></i> Retirar Ingredientes
                    </div>
                    <div id="pizzaIngsList" class="grid grid-cols-2 sm:grid-cols-3 gap-2 pt-2"></div>
                </div>
            </div>

            <div id="stepEdges" class="hidden space-y-3 animate-fade-in-up">
                <label class="text-xs font-bold text-yellow-400 uppercase tracking-wider flex items-center gap-2">
                    <span
                        class="bg-yellow-500/20 w-5 h-5 rounded-full flex items-center justify-center text-[10px] border border-yellow-500/30">3</span>
                    Borda Recheada?
                </label>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3" id="pizzaEdgesBox"></div>
            </div>


            <div id="stepExtras" class="hidden space-y-3 animate-fade-in-up">
                <label class="text-xs font-bold text-emerald-400 uppercase tracking-wider flex items-center gap-2">
                    <span class="bg-emerald-500/20 w-5 h-5 rounded-full flex items-center justify-center text-[10px] border border-emerald-500/30">4</span>
                    Turbinar Pizza? (Adicionais)
                </label>
                <div class="grid grid-cols-2 gap-3" id="pizzaExtrasBox"></div>
            </div>

            
        </div>

        <div class="p-5 bg-slate-800 border-t border-slate-700 shrink-0">
            <div class="mb-4">
                <label class="text-[10px] font-bold text-slate-500 uppercase mb-1 block">Observação Geral</label>
                <input type="text" id="pizzaObs"
                    class="w-full bg-slate-900 border border-slate-600 rounded-lg p-3 text-white text-sm outline-none focus:border-indigo-500 placeholder-slate-600"
                    placeholder="Ex: Bem passada, cortar em aperitivo...">
            </div>

            <div class="flex justify-between items-center">
                <div>
                    <span class="text-xs text-slate-400 font-bold uppercase block">Valor Final</span>
                    <span class="text-3xl font-black text-green-400 font-mono" id="pizzaTotal">R$ 0,00</span>
                </div>
                <button onclick="confirmPizza()"
                    class="bg-green-600 hover:bg-green-500 text-white px-8 py-4 rounded-xl font-bold shadow-lg shadow-green-900/30 transition transform hover:scale-105 flex items-center gap-2">
                    <i class="fas fa-check"></i> CONFIRMAR
                </button>
            </div>
        </div>
    </div>
</div>

<div id="viewOrderModal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4">
    <div class="absolute inset-0 bg-black/90 backdrop-blur-sm" onclick="closeOrderModal()"></div>

    <div
        class="relative bg-slate-800 rounded-2xl border border-slate-600 w-full max-w-2xl shadow-2xl flex flex-col max-h-[90vh] fade-in overflow-hidden">

        <div class="p-5 border-b border-slate-700 bg-slate-900 flex justify-between items-center shrink-0">
            <div>
                <h3 class="text-xl font-bold text-white flex items-center gap-2">
                    Pedido <span id="voId" class="text-indigo-400 font-mono">#---</span>
                </h3>
                <span id="voStatusBadge"
                    class="text-[10px] uppercase font-bold px-2 py-0.5 rounded bg-slate-700 text-slate-300 border border-slate-600">PENDENTE</span>
            </div>

            <div class="flex gap-2">

                <button type="button" onclick="editOrderFromModal()"
                    class="bg-indigo-600 hover:bg-indigo-500 text-white border border-indigo-500 px-3 py-1.5 rounded-lg text-xs font-bold transition flex items-center gap-2 shadow-lg">
                    <i class="fas fa-edit"></i> Editar
                </button>

                <button type="button" onclick="cancelFromViewModal()"
                    class="bg-red-900/30 hover:bg-red-900/60 text-red-400 border border-red-500/30 px-3 py-1.5 rounded-lg text-xs font-bold transition flex items-center gap-2">
                    <i class="fas fa-ban"></i> Cancelar
                </button>

                <button onclick="closeOrderModal()" class="text-slate-400 hover:text-white p-1"><i
                        class="fas fa-times text-lg"></i></button>
            </div>
        </div>

        <div class="p-6 overflow-y-auto custom-scroll space-y-6 flex-1">

            <div class="bg-slate-900/50 p-4 rounded-xl border border-slate-700 relative">
                <h4 class="text-xs font-bold text-slate-500 uppercase mb-3"><i class="fas fa-user mr-1"></i> Dados do
                    Cliente</h4>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <div class="text-[10px] text-slate-400 uppercase">Nome</div>
                        <div class="text-white font-bold" id="voName">--</div>
                    </div>
                    <div>
                        <div class="text-[10px] text-slate-400 uppercase">Telefone / Contato</div>
                        <div class="flex items-center gap-2">
                            <span class="text-white font-mono font-bold" id="voPhone">--</span>
                            
                            <a id="voWppBtn" href="#" target="_blank" class="hidden bg-green-600 hover:bg-green-500 text-white px-2 py-1 rounded-lg text-xs font-bold transition flex items-center gap-1 shadow-lg shadow-green-900/20 border border-green-500">
                                <i class="fab fa-whatsapp"></i> Chamar
                            </a>
                        </div>
                    </div>

                    <div class="md:col-span-2">
                        <div class="text-[10px] text-slate-400 uppercase">Email</div>
                        <div class="text-slate-300 text-sm" id="voEmail">Não informado</div>
                    </div>

                    <div class="md:col-span-2 p-3 bg-black/20 rounded border border-white/5">
                        <div class="text-[10px] text-slate-400 uppercase flex items-center gap-1">
                            <i class="fas fa-map-marker-alt"></i> Endereço de Entrega
                        </div>
                        <div class="text-slate-200 text-sm font-medium mt-1 leading-snug" id="voAddress">--</div>
                    </div>
                </div>
            </div>

            <div id="modal-order-obs-container"
                class="hidden mx-6 mt-4 mb-2 bg-yellow-900/30 border-l-4 border-yellow-500 p-3 rounded-r-lg animate-pulse-slow">
                <div class="flex items-start gap-3">
                    <i class="fas fa-exclamation-triangle text-yellow-500 text-xl mt-0.5"></i>
                    <div>
                        <h4 class="text-yellow-500 font-bold text-xs uppercase tracking-wider mb-1">Observação do Pedido
                        </h4>
                        <p id="modal-order-obs-text" class="text-yellow-100 text-lg font-medium italic leading-tight">
                        </p>
                    </div>
                </div>
            </div>

            <div>
                <h4 class="text-xs font-bold text-slate-500 uppercase mb-2"><i class="fas fa-shopping-basket mr-1"></i>
                    Itens</h4>
                <div class="space-y-2" id="voItems"></div>
            </div>

            <div class="bg-slate-900 p-4 rounded-xl border border-slate-700 mt-4">
                <h4 class="text-xs font-bold text-slate-500 uppercase mb-3">Resumo Financeiro</h4>
                <div class="space-y-2 text-sm">

                    <div class="flex justify-between text-slate-300 border-b border-slate-800 pb-2">
                        <span>Pagamento</span>
                        <span id="voPayment" class="text-white font-medium text-right max-w-[60%]">--</span>
                    </div>

                    <div id="boxVoChange" class="hidden flex justify-between items-center bg-yellow-900/20 p-2 rounded border border-yellow-500/20 mb-2">
                        <span class="text-yellow-500 font-bold uppercase text-xs"><i class="fas fa-hand-holding-usd mr-1"></i> Troco a Devolver</span>
                        <span id="voChangeVal" class="text-yellow-400 font-mono font-bold text-lg">R$ 0,00</span>
                    </div>

                    <div class="flex justify-between text-slate-400">
                        <span>Taxa de Entrega</span>
                        <span id="voDeliveryFee" class="text-yellow-400 font-mono font-bold">R$ 0,00</span>
                    </div>

                    <div class="flex justify-between text-slate-400">
                        <span>Desconto</span>
                        <span id="voDiscount" class="text-red-400 font-mono">R$ 0,00</span>
                    </div>

                    <div id="boxServiceFee" class="hidden flex justify-between text-slate-400">
                        <span>Taxa Serviço (10%)</span>
                        <span id="voService" class="text-blue-400 font-mono">R$ 0,00</span>
                    </div>

                    <div class="border-t border-slate-700 mt-2 pt-2 flex justify-between items-center">
                        <span class="font-bold text-white">TOTAL FINAL</span>
                        <span class="text-2xl font-bold text-green-400 font-mono" id="voTotal">R$ 0,00</span>
                    </div>
                </div>
            </div>

            <div class="bg-indigo-900/20 p-4 rounded-xl border border-indigo-500/30">
                <h4 class="text-xs font-bold text-indigo-400 uppercase mb-3"><i class="fas fa-motorcycle mr-1"></i>
                    Logística</h4>
                <div class="flex items-center justify-between gap-4">
                    <div>
                        <div class="text-[10px] text-slate-400 uppercase">Motoboy Atual</div>
                        <div class="text-white font-bold" id="voDriverName">Sem Motoboy</div>
                    </div>
                    <button type="button" onclick="openDispatchFromModal()"
                        class="bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 rounded-lg text-xs font-bold shadow transition">
                        Definir / Trocar
                    </button>
                </div>
            </div>

        </div>
    </div>
</div>

<div id="bulkActionBar"
    class="fixed bottom-6 left-1/2 transform -translate-x-1/2 bg-slate-800 border border-slate-600 rounded-full shadow-2xl px-5 py-3 flex items-center gap-3 z-[80] translate-y-32 transition-transform duration-300">

    <div class="flex items-center gap-3 border-r border-slate-600 pr-4 mr-1">
        <div class="bg-indigo-600 w-8 h-8 rounded-full flex items-center justify-center text-white font-bold text-sm"
            id="bulkCount">0</div>
        <span class="text-white text-xs font-bold hidden sm:inline uppercase tracking-wider">Itens</span>
    </div>

    <button onclick="openBulkDispatch()"
        class="text-white hover:text-indigo-400 font-bold text-xs uppercase flex flex-col items-center gap-1 transition px-2 group"
        title="Atribuir Motoboy">
        <i class="fas fa-motorcycle text-lg group-hover:scale-110 transition"></i>
        <span class="hidden md:inline">Motoboy</span>
    </button>

    <div class="w-px h-8 bg-slate-600 mx-1"></div>

    <div class="flex items-center bg-slate-900 rounded-lg p-1 border border-slate-700">
        <button onclick="openBulkRevert()"
            class="w-10 h-8 text-slate-400 hover:text-orange-400 hover:bg-slate-800 rounded transition flex items-center justify-center"
            title="Voltar Status">
            <i class="fas fa-chevron-left text-lg"></i>
        </button>
        <div class="w-px h-4 bg-slate-700 mx-1"></div>
        <button onclick="openBulkAdvance()"
            class="w-10 h-8 text-slate-400 hover:text-yellow-400 hover:bg-slate-800 rounded transition flex items-center justify-center"
            title="Avançar Status">
            <i class="fas fa-chevron-right text-lg"></i>
        </button>
    </div>

    <div class="w-px h-8 bg-slate-600 mx-1"></div>

    <button onclick="openBulkFinalize()"
        class="text-slate-300 hover:text-green-400 font-bold text-xs uppercase flex flex-col items-center gap-1 transition px-2"
        title="Marcar como Entregue">
        <i class="fas fa-check-circle text-lg"></i>
        <span class="hidden md:inline">Entregue</span>
    </button>

    <button onclick="openBulkArchive()"
        class="text-slate-300 hover:text-emerald-400 font-bold text-xs uppercase flex flex-col items-center gap-1 transition px-2"
        title="Concluir e Arquivar">
        <i class="fas fa-archive text-lg"></i>
        <span class="hidden md:inline">Arquivar</span>
    </button>

    <button onclick="openBulkCancel()"
        class="text-slate-300 hover:text-red-500 font-bold text-xs uppercase flex flex-col items-center gap-1 transition px-2 border-l border-slate-600 pl-4 ml-1"
        title="Cancelar Pedidos">
        <i class="fas fa-ban text-lg"></i>
        <span class="hidden md:inline">Cancelar</span>
    </button>

    <button onclick="clearBulkSelection()" class="text-slate-500 hover:text-white ml-2 p-2" title="Limpar Seleção">
        <i class="fas fa-times"></i>
    </button>
</div>

<div id="newClientModal" class="fixed inset-0 z-[70] hidden flex items-center justify-center p-4">
    <div class="absolute inset-0 bg-black/90 backdrop-blur-sm" onclick="closeNewClientModal()"></div>
    <div
        class="relative w-full max-w-lg bg-slate-800 rounded-2xl shadow-2xl border border-slate-600 p-6 transform transition-all scale-100 opacity-100 max-h-[90vh] overflow-y-auto custom-scroll">

        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold text-white flex items-center gap-2">
                <i class="fas fa-user-plus text-green-400"></i> Ficha do Cliente
            </h3>
            <button onclick="closeNewClientModal()" class="text-slate-400 hover:text-white"><i
                    class="fas fa-times"></i></button>
        </div>

        <form onsubmit="submitNewClientFromPOS(event)" class="space-y-4">

            <input type="hidden" name="cust_id" id="ncId">

            <div class="bg-slate-900/50 p-3 rounded-xl border border-slate-700/50">
                <label class="text-[10px] font-bold text-slate-500 uppercase mb-2 block">Dados Obrigatórios</label>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-xs font-bold text-slate-400 uppercase">Nome *</label>
                        <input type="text" name="name" id="ncName" required
                            class="w-full bg-slate-800 border border-slate-600 rounded-lg p-2.5 text-white outline-none focus:border-green-500 placeholder-slate-600">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-400 uppercase">Telefone *</label>
                        <input type="text" name="phone" id="ncPhone" required
                            class="w-full bg-slate-800 border border-slate-600 rounded-lg p-2.5 text-white outline-none focus:border-green-500 placeholder-slate-600">
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="text-xs font-bold text-slate-400 uppercase">Email (Opcional)</label>
                    <input type="email" name="email" id="ncEmail" placeholder="cliente@email.com"
                        class="w-full bg-slate-900 border border-slate-600 rounded-lg p-2.5 text-white outline-none focus:border-indigo-500">
                </div>
                <div>
                    <label class="text-xs font-bold text-pink-400 uppercase">Aniversário (Opcional)</label>
                    <input type="date" name="birth_date" id="ncBirth"
                        class="w-full bg-slate-900 border border-slate-600 rounded-lg p-2.5 text-white outline-none focus:border-pink-500">
                </div>
            </div>

            <div class="bg-slate-900/50 p-3 rounded-xl border border-slate-700">
                <div class="flex justify-between items-center mb-3">
                    <p class="text-xs font-bold text-indigo-400 uppercase flex items-center gap-2">
                        <i class="fas fa-map-marker-alt"></i> Endereço de Entrega
                    </p>
                </div>

                <div class="grid grid-cols-4 gap-3 mb-3">
                    <input type="text" name="zip_code" id="ncZip" placeholder="CEP"
                        class="col-span-1 bg-slate-800 border border-slate-600 rounded-lg p-2.5 text-white text-sm outline-none focus:border-indigo-500 placeholder-slate-500">
                    <input type="text" name="city" id="ncCity" placeholder="Cidade" value="São Vicente"
                        class="col-span-2 bg-slate-800 border border-slate-600 rounded-lg p-2.5 text-white text-sm outline-none focus:border-indigo-500 placeholder-slate-500">
                    <input type="text" name="state" id="ncState" placeholder="UF" value="SP"
                        class="col-span-1 bg-slate-800 border border-slate-600 rounded-lg p-2.5 text-white text-sm outline-none focus:border-indigo-500 placeholder-slate-500 text-center">
                </div>

                <div class="grid grid-cols-4 gap-3 mb-3">
                    <input type="text" name="street" id="ncStreet" placeholder="Nome da Rua / Avenida"
                        class="col-span-3 bg-slate-800 border border-slate-600 rounded-lg p-2.5 text-white text-sm outline-none focus:border-indigo-500 placeholder-slate-500">
                    <input type="text" name="number" id="ncNum" placeholder="Nº"
                        class="col-span-1 bg-slate-800 border border-slate-600 rounded-lg p-2.5 text-white text-sm font-bold outline-none focus:border-indigo-500 placeholder-slate-500 text-center">
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <select id="ncNeighSelect" onchange="toggleNewNeighFields()"
                            class="w-full bg-slate-800 border border-slate-600 rounded-lg p-2.5 text-white text-sm outline-none focus:border-indigo-500 cursor-pointer">
                            <option value="">Selecione o Bairro...</option>
                        </select>
                    </div>

                    <input type="text" name="complement" id="ncComp" placeholder="Complemento (Apt, Bloco...)"
                        class="w-full bg-slate-800 border border-slate-600 rounded-lg p-2.5 text-white text-sm outline-none focus:border-indigo-500 placeholder-slate-500">
                </div>

                <div id="boxNewNeigh"
                    class="hidden mt-3 p-3 bg-indigo-900/20 border border-indigo-500/30 rounded-lg animate-fade-in-up">
                    <label class="text-[10px] font-bold text-indigo-300 uppercase mb-2 block flex items-center gap-1">
                        <i class="fas fa-plus-circle"></i> Cadastrar Novo Bairro
                    </label>
                    <div class="grid grid-cols-3 gap-3">
                        <input type="text" id="newNeighName" placeholder="Nome do Bairro"
                            class="col-span-2 bg-slate-900 border border-indigo-500/50 rounded-lg p-2 text-white text-sm outline-none focus:border-indigo-400">
                        <div class="relative">
                            <span class="absolute left-2 top-2 text-slate-500 text-xs font-bold">R$</span>
                            <input type="number" id="newNeighFee" placeholder="Taxa"
                                class="w-full bg-slate-900 border border-indigo-500/50 rounded-lg p-2 pl-6 text-white text-sm outline-none font-bold text-green-400 focus:border-green-500">
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex justify-end gap-2 pt-2 border-t border-slate-700">
                <button type="button" onclick="closeNewClientModal()"
                    class="px-4 py-2 text-slate-400 hover:text-white text-sm font-bold">Cancelar</button>
                <button type="submit"
                    class="bg-green-600 hover:bg-green-500 text-white px-6 py-2 rounded-lg font-bold shadow-lg text-sm transition transform hover:scale-105 flex items-center gap-2">
                    <i class="fas fa-save"></i> SALVAR
                </button>
            </div>
        </form>
    </div>
</div>

<div id="checkOrderModal"
    class="fixed inset-0 z-[80] hidden flex items-center justify-center p-4 bg-black/95 backdrop-blur-md">
    <div
        class="relative w-full max-w-4xl bg-slate-900 rounded-2xl border border-slate-600 shadow-2xl flex flex-col h-[90vh]">

        <div
            class="p-6 border-b border-slate-700 bg-slate-800 rounded-t-2xl flex justify-between items-center shrink-0">
            <div>
                <h3 class="text-2xl font-bold text-white flex items-center gap-3">
                    <i class="fas fa-clipboard-check text-green-400"></i> Conferência de Saída
                </h3>
                <p class="text-slate-400 text-sm mt-1">Marque os itens conforme for conferindo.</p>
            </div>
            <button onclick="document.getElementById('checkOrderModal').classList.add('hidden')"
                class="bg-slate-700 hover:bg-red-600 text-white w-12 h-12 rounded-xl transition flex items-center justify-center text-xl">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="flex-1 overflow-y-auto p-6 space-y-4 custom-scroll" id="checkOrderList">
        </div>

        <div class="p-6 border-t border-slate-700 bg-slate-800 rounded-b-2xl flex justify-end">
            <button onclick="document.getElementById('checkOrderModal').classList.add('hidden')"
                class="bg-green-600 hover:bg-green-500 text-white px-8 py-4 rounded-xl font-bold text-lg shadow-lg flex items-center gap-3 transition transform hover:scale-105">
                <i class="fas fa-check-double"></i> CONFERIDO / VOLTAR
            </button>
        </div>
    </div>
</div>

<div id="comboPDVModal"
    class="fixed inset-0 z-[80] hidden flex items-center justify-center p-4 bg-black/95 backdrop-blur-md">
    <div
        class="relative w-full max-w-3xl bg-slate-900 rounded-2xl border border-slate-600 shadow-2xl flex flex-col max-h-[90vh]">
        <div class="p-5 bg-slate-800 border-b border-slate-700 flex justify-between items-start shrink-0">
            <div>
                <h3 class="text-xl font-bold text-white leading-tight" id="cpTitle">Montar Combo</h3>
                <p class="text-sm text-slate-400 mt-1 font-medium hidden" id="cpDesc">...</p>
            </div>
            <button onclick="document.getElementById('comboPDVModal').classList.add('hidden')"
                class="text-slate-400 hover:text-white p-1"><i class="fas fa-times text-xl"></i></button>
        </div>

        <div class="flex-1 overflow-y-auto custom-scroll p-6 space-y-8" id="cpGroupsContainer">
        </div>

        <div class="p-5 bg-slate-800 border-t border-slate-700 flex justify-between items-center">
            <div id="cpGlobalStatus" class="text-sm font-bold text-yellow-500 animate-pulse">Pendências...</div>
            <button onclick="confirmComboPDV()" id="btnConfirmCombo" disabled
                class="bg-green-600 hover:bg-green-500 disabled:opacity-50 disabled:cursor-not-allowed text-white px-8 py-3 rounded-xl font-bold shadow-lg transition transform active:scale-95">
                CONFIRMAR
            </button>
        </div>
    </div>
</div>

<div id="employeeActionModal"
    class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 bg-black/90 backdrop-blur-sm">
    <div class="bg-slate-800 rounded-2xl w-full max-w-sm border border-slate-600 shadow-2xl p-6 animate-fade-in-up">
        <div class="flex justify-between items-center mb-4">
            <div>
                <h3 class="text-xl font-bold text-white mb-1">Lançamento Equipe</h3>
                <p class="text-xs text-slate-400">Adiantamentos ou Premiações.</p>
            </div>
            <button onclick="document.getElementById('employeeActionModal').classList.add('hidden')"
                class="text-slate-400 hover:text-white"><i class="fas fa-times text-lg"></i></button>
        </div>

        <div class="space-y-4">
            <div>
                <label class="text-[10px] font-bold text-slate-500 uppercase mb-1 block">Funcionário</label>
                <select id="empSelect"
                    class="w-full bg-slate-900 border border-slate-600 rounded-lg p-3 text-white outline-none focus:border-indigo-500"></select>
            </div>

            <div class="grid grid-cols-2 gap-3">
                <label class="cursor-pointer group">
                    <input type="radio" name="empActionType" value="vale" class="peer hidden" checked>
                    <div
                        class="bg-slate-900 border border-slate-600 rounded-lg p-3 text-center text-xs font-bold text-slate-400 peer-checked:bg-red-900/30 peer-checked:text-red-400 peer-checked:border-red-500 transition group-hover:border-slate-500">
                        <i class="fas fa-money-bill-wave mb-1 block text-lg"></i> VALE (Débito)
                    </div>
                </label>
                <label class="cursor-pointer group">
                    <input type="radio" name="empActionType" value="bonus" class="peer hidden">
                    <div
                        class="bg-slate-900 border border-slate-600 rounded-lg p-3 text-center text-xs font-bold text-slate-400 peer-checked:bg-green-900/30 peer-checked:text-green-400 peer-checked:border-green-500 transition group-hover:border-slate-500">
                        <i class="fas fa-star mb-1 block text-lg"></i> BÔNUS (Crédito)
                    </div>
                </label>
            </div>

            <div>
                <label class="text-[10px] font-bold text-slate-500 uppercase mb-1 block">Valor (R$)</label>
                <div class="relative">
                    <span class="absolute left-3 top-3 text-slate-500 font-bold">R$</span>
                    <input type="number" id="empValue" step="0.50"
                        class="w-full bg-slate-900 border border-slate-600 rounded-lg p-3 pl-10 text-white font-bold text-xl outline-none focus:border-indigo-500"
                        placeholder="0.00">
                </div>
            </div>

            <div>
                <label class="text-[10px] font-bold text-slate-500 uppercase mb-1 block">Forma de Pagamento</label>
                <select id="empMethod" class="w-full bg-slate-900 border border-slate-600 rounded-lg p-3 text-white outline-none focus:border-indigo-500">
                    <option value="DINHEIRO">💵 Dinheiro (Gaveta)</option>
                    <option value="PIX">💠 Pix (Conta)</option>
                </select>
            </div>

            <div>
                <label class="text-[10px] font-bold text-slate-500 uppercase mb-1 block">Motivo / Descrição</label>
                <input type="text" id="empDesc"
                    class="w-full bg-slate-900 border border-slate-600 rounded-lg p-3 text-white text-sm outline-none focus:border-indigo-500"
                    placeholder="Ex: Adiantamento gasolina...">
            </div>

            <div class="pt-2">
                <button onclick="submitEmployeeAction()"
                    class="w-full bg-indigo-600 hover:bg-indigo-500 text-white py-3.5 rounded-xl font-bold shadow-lg shadow-indigo-900/20 transition active:scale-95 flex items-center justify-center gap-2">
                    <i class="fas fa-check-circle"></i> CONFIRMAR
                </button>
            </div>
        </div>
    </div>
</div>


<div id="feeManagerModal" class="fixed inset-0 z-[70] hidden flex items-center justify-center p-4 bg-black/90 backdrop-blur-sm">
    <div class="bg-slate-800 rounded-2xl w-full max-w-md border border-slate-600 shadow-2xl flex flex-col max-h-[85vh]">
        
        <div class="p-5 border-b border-slate-700 bg-slate-900 rounded-t-2xl flex justify-between items-center shrink-0">
            <h3 class="text-lg font-bold text-white flex items-center gap-2">
                <i class="fas fa-map-marker-alt text-yellow-500"></i> Bairros e Taxas
            </h3>
            <button onclick="document.getElementById('feeManagerModal').classList.add('hidden')" class="text-slate-400 hover:text-white"><i class="fas fa-times text-lg"></i></button>
        </div>

        <div class="p-4 bg-slate-800 border-b border-slate-700 shrink-0">
            <form onsubmit="submitFee(event)" class="flex gap-2 items-end">
                <input type="hidden" id="feeId">
                <div class="flex-1">
                    <label class="text-[10px] text-slate-500 font-bold uppercase mb-1 block">Nome do Bairro</label>
                    <input type="text" id="feeName" required class="w-full bg-slate-900 border border-slate-600 rounded-lg p-2 text-white text-sm outline-none focus:border-yellow-500 uppercase placeholder-slate-600" placeholder="Ex: CENTRO">
                </div>
                <div class="w-24">
                    <label class="text-[10px] text-slate-500 font-bold uppercase mb-1 block">Valor (R$)</label>
                    <input type="number" id="feeVal" step="0.50" required class="w-full bg-slate-900 border border-slate-600 rounded-lg p-2 text-white text-sm font-bold text-center outline-none focus:border-green-500" placeholder="0.00">
                </div>
                <button type="submit" class="bg-yellow-600 hover:bg-yellow-500 text-white w-10 h-[38px] rounded-lg shadow transition flex items-center justify-center">
                    <i class="fas fa-plus" id="btnFeeIcon"></i>
                </button>
            </form>
            
            <div class="mt-3 relative">
                <i class="fas fa-search absolute left-3 top-2.5 text-slate-500 text-xs"></i>
                <input type="text" id="searchFee" onkeyup="filterFees()" placeholder="Pesquisar bairro..." class="w-full bg-slate-900 border border-slate-700 rounded-lg pl-8 p-2 text-xs text-white outline-none focus:border-indigo-500">
            </div>
        </div>

        <div class="flex-1 overflow-y-auto p-2 space-y-1 custom-scroll" id="feesList">
            <div class="text-center py-10 text-slate-500 text-xs"><i class="fas fa-circle-notch fa-spin"></i> Carregando...</div>
        </div>
    </div>
</div>

<div id="pdvTaskbar" class="fixed bottom-0 left-0 right-0 z-[200] flex justify-center gap-2 pointer-events-none px-4 pb-0">
    </div>

{% endblock %}

{% block scripts %}
<script>

    let CURRENT_TAB = 'delivery';
    let SEARCH_TIMER = null;
    let PDV_DATA = {};
    let CURRENT_PIZZA = {};
    let CURRENT_ORDER_ID = null;
    let CURRENT_MODAL_ORDER_ID = null;

    // --- VARIÁVEIS DO NOVO PDV ---
    let CART = [];
    let PAYMENTS = []; // Array { method: 'Pix', value: 50.00 }
    let CURRENT_CLIENT = null;
    let IS_TABLE_MODE = false;
    let CURRENT_CAT_FILTER = 'all';

    let IS_FINALIZE_MODE = false;

    let CURRENT_FLAVORS_COUNT = 0;
    let MAX_FLAVORS_ALLOWED = 1;

    // --- VARIÁVEIS PARA O COMBO NO PDV ---
    let CURRENT_COMBO_PDV = { product: null, groups: [] };

    let CURRENT_PLATFORM_FILTER = null;
    let CURRENT_DRIVER_FILTER = null;

    let CACHED_PROD_CARDS = []; // Cache para performance extrema no PDV

    // --- ADICIONE ISTO AQUI ---
    let EDITING_CART_INDEX = null;

    // --- INICIALIZAÇÃO ---
    $(document).ready(async function () {

        // 1. Configura a Barra de Busca (Digitação Inteligente)
        const searchInput = document.getElementById('globalSearch');
        if (searchInput) {
            // Evento 'input' pega digitação, colar (Ctrl+V) e limpeza (X)
            searchInput.addEventListener('input', function () {
                clearTimeout(SEARCH_TIMER);
                // Aguarda 400ms após parar de digitar para buscar (Debounce)
                SEARCH_TIMER = setTimeout(fetchOrders, 400);
            });

            // Permite buscar imediatamento ao dar ENTER
            searchInput.addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    clearTimeout(SEARCH_TIMER);
                    fetchOrders();
                }
            });

        }

        // 2. Carrega Dados do PDV
        try {
            const res = await fetch('/admin/api/pdv/data');
            if (res.ok) { PDV_DATA = await res.json(); initPDVData(); }
        } catch (e) { console.error("Erro PDV Init:", e); }

        // 3. Define Aba Inicial e Carrega Pedidos
        switchTab('delivery');

        // Função para verificar status do caixa
        async function checkBoxStatus() {
            try {
                // Reutiliza a API de resumo que já traz info do caixa
                const res = await fetch('/admin/api/finance/daily-summary');
                const data = await res.json();

                // Lógica simples: Se expected_in_box for 0 e não tiver abertura hoje, assume fechado?
                // Melhor: Vamos criar uma flag na API daily-summary no backend pra ser preciso.
                // Mas com o que temos: Se a abertura for 0 e não tiver vendas, pode ser indício.
                // Vamos confiar no 'management' view que passa 'box_state'. 
                // Como estamos na orders.html, vamos fazer um fetch leve específico ou usar a dica abaixo.
            } catch (e) { }
        }

    });

    // 3. Define Aba Inicial
    switchTab('delivery');

    // --- WEBSOCKET REAL-TIME (Substitui o Polling) ---
    let socket;
    let reconnectInterval = 3000;

    function connectWebSocket() {
        // Define protocolo (ws ou wss)
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        // AQUI ESTÁ A MUDANÇA: ?token={{ access_token }}
        const wsUrl = `${protocol}//${window.location.host}/ws/orders?token={{ access_token }}`;

        console.log("🔌 Conectando ao Painel em tempo real...", wsUrl);
        socket = new WebSocket(wsUrl);

        socket.onopen = function () {
            console.log("✅ Painel Conectado!");
            // Carrega a primeira vez para garantir dados frescos
            fetchOrders();
        };

        socket.onmessage = function (event) {
            console.log("🔔 Sinal recebido:", event.data);

            const isModalOpen = !document.getElementById('pdvModal').classList.contains('hidden');

            if (event.data === "cash_update" || event.data === "new_order") {
                if (typeof checkCashBox === "function") checkCashBox();
                if (typeof playAlert === "function" && event.data === "new_order") playAlert();
            }

            // Atualiza o Kanban
            if (!isModalOpen) {
                if (event.data === "new_order" || event.data === "update" || event.data.includes("driver_update")) {
                    console.log("⏳ Aguardando banco de dados...");

                    // CORREÇÃO DE 1 MILHÃO: Pequeno delay para garantir que o banco gravou o pedido
                    setTimeout(() => {
                        console.log("🔄 Buscando pedidos agora!");
                        fetchOrders().catch(err => console.error("❌ Erro ao renderizar:", err));
                    }, 500); // 500ms de espera estratégica
                }
            }

            // --- NOVO: Notificação de Conta ---
            if (event.data.startsWith("bill_req:")) {
                // Formato: bill_req:MESA:ORDER_ID:GARCOM
                const parts = event.data.split(':');
                const tableNum = parts[1];
                const orderId = parts[2];
                const waiterName = parts[3];

                // Toca o som de alerta (que já existe na página)
                if (typeof playAlert === 'function') playAlert();

                // Mostra notificação interativa
                Swal.fire({
                    title: `📢 Mesa ${tableNum} pediu a conta!`,
                    text: `Solicitado por ${waiterName}`,
                    icon: 'info',
                    toast: true,
                    position: 'top-right',
                    showConfirmButton: true,
                    confirmButtonText: 'ABRIR MESA',
                    confirmButtonColor: '#10b981', // Verde
                    showCancelButton: true,
                    cancelButtonText: 'Fechar',
                    timer: 15000, // Fica 15s na tela
                    timerProgressBar: true,
                    background: '#1e293b', color: '#fff',
                    didOpen: (toast) => {
                        toast.addEventListener('mouseenter', Swal.stopTimer)
                        toast.addEventListener('mouseleave', Swal.resumeTimer)
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        // Atalho Inteligente:
                        // 1. Muda para a aba de mesas
                        switchTab('mesas');
                        
                        // 2. Abre o PDV da mesa automaticamente
                        // Passamos {id: orderId} para ele buscar os dados completos
                        openTablePDV(tableNum, {id: orderId});
                    }
                });
            }
            
        };

        socket.onclose = function () {
            console.warn("❌ Painel Desconectado. Reconectando em 3s...");
            setTimeout(connectWebSocket, reconnectInterval);
        };

        socket.onerror = function (err) {
            console.error("Socket erro:", err);
            socket.close();
        };
    }

    // Inicia conexão
    connectWebSocket();

    // --- NAVEGAÇÃO ---
    function switchTab(tab) {
        CURRENT_TAB = tab;

        // 1. LIMPA ESTILO DE TODOS (Volta ao padrão slate-700)
        // Remove bordas coloridas e anéis de foco de todos os botões HUD
        ['delivery', 'balcao', 'mesas'].forEach(t => {
            const el = document.getElementById(`btn-hud-${t}`);
            if (el) {
                el.classList.remove(
                    'border-indigo-500', 'ring-1', 'ring-indigo-500', // Cores Delivery
                    'border-blue-500', 'ring-1', 'ring-blue-500',   // Cores Balcão
                    'border-orange-500', 'ring-1', 'ring-orange-500', // Cores Mesas
                    'bg-slate-750' // Remove fundo ativo
                );
                el.classList.add('border-slate-700'); // Volta borda padrão
            }
        });

        // Atualiza Visibilidade das Divs de Conteúdo (Isso já existia)
        document.querySelectorAll('.tab-content').forEach(view => view.classList.remove('active'));
        const view = document.getElementById(`view-${tab}`);
        if (view) view.classList.add('active');

        // 2. ATIVA ESTILO DO SELECIONADO
        const activeEl = document.getElementById(`btn-hud-${tab}`);
        if (activeEl) {
            activeEl.classList.remove('border-slate-700'); // Tira a borda cinza
            activeEl.classList.add('bg-slate-750'); // Um fundo levemente mais claro (opcional, se tiver no CSS, senão ignora)

            if (tab === 'delivery') {
                activeEl.classList.add('border-indigo-500', 'ring-1', 'ring-indigo-500');
            } else if (tab === 'balcao') {
                activeEl.classList.add('border-blue-500', 'ring-1', 'ring-blue-500');
            } else if (tab === 'mesas') {
                activeEl.classList.add('border-orange-500', 'ring-1', 'ring-orange-500');
            }
        }

        // Recarrega dados da aba selecionada
        fetchOrders();
    }

    function debounceSearch() { clearTimeout(SEARCH_TIMER); SEARCH_TIMER = setTimeout(fetchOrders, 500); }

    // --- BUSCA DE PEDIDOS (CORE) ---

    async function fetchOrders() {
        const loader = document.getElementById('loader');
        const termInput = document.getElementById('globalSearch');

        // 1. DEFINIÇÃO DA BUSCA (Obrigatório vir antes da URL)
        const term = termInput ? encodeURIComponent(termInput.value.trim()) : '';

        // Feedback visual de loading (só se estiver buscando)
        const isSearching = document.activeElement === termInput;
        if (loader && isSearching) loader.classList.remove('hidden');

        try {
            // 2. CONSTRUÇÃO DA URL
            // Adiciona timestamp para evitar cache do navegador
            let url = `/admin/api/orders/list?tab=${CURRENT_TAB}&search=${term}&_=${new Date().getTime()}`;

            // 3. FILTRO DE PLATAFORMA (NOVO)
            // Verifica se a variável existe e tem valor antes de adicionar
            if (typeof CURRENT_PLATFORM_FILTER !== 'undefined' && CURRENT_PLATFORM_FILTER) {
                url += `&platform=${CURRENT_PLATFORM_FILTER}`;
            }

            if (CURRENT_DRIVER_FILTER) {
                url += `&driver_id=${CURRENT_DRIVER_FILTER}`;
            }

            const res = await fetch(url);

            if (!res.ok) throw new Error("Erro na API");

            const response = await res.json();

            let data = [];
            let counts = null;
            let productStats = null;
            let platformStats = null;

            if (Array.isArray(response)) {
                data = response; // Fallback para formato antigo
            } else {
                data = response.orders || [];
                counts = response.counts;
                productStats = response.product_stats;
                platformStats = response.platform_stats;
            }

            // --- ATUALIZA PAINEL DE PRODUTOS ---
            if (productStats) {
                const elPizzas = document.getElementById('dash-qty-pizzas');
                const elEsfihas = document.getElementById('dash-qty-esfihas');
                const elBeirutes = document.getElementById('dash-qty-beirutes');

                if (elPizzas) elPizzas.innerText = productStats.pizzas;
                if (elEsfihas) elEsfihas.innerText = productStats.esfihas;
                if (elBeirutes) elBeirutes.innerText = productStats.beirutes;
            }

            // --- ATUALIZA PAINEL DE PLATAFORMAS ---
            if (platformStats) {
                const elIfood = document.getElementById('dash-qty-ifood');
                const elWabiz = document.getElementById('dash-qty-wabiz');
                const elPdv = document.getElementById('dash-qty-pdv');

                if (elIfood) elIfood.innerText = platformStats.ifood;
                if (elWabiz) elWabiz.innerText = platformStats.wabiz;
                if (elPdv) elPdv.innerText = platformStats.pdv;
            }

            // Renderiza Kanban/Lista conforme a aba
            if (CURRENT_TAB === 'delivery') {
                // --- NOVA LÓGICA V5: Usa dados pré-processados do Backend ---
                if (CURRENT_TAB === 'delivery') {
                    if (response.kanban) {
                        renderKanban(response.kanban);
                    }
                }
            }
            else if (CURRENT_TAB === 'balcao') renderKanbanBalcao(data);
            else if (CURRENT_TAB === 'mesas') renderMesas(data);

            // Atualiza Badges e HUD
            if (counts) {
                const bD = document.getElementById('badge-delivery'); if (bD) bD.innerText = counts.delivery.total;
                const bB = document.getElementById('badge-balcao'); if (bB) bB.innerText = counts.balcao.total;
                const bM = document.getElementById('badge-mesas'); if (bM) bM.innerText = counts.mesas;

                const hudDelTotal = document.getElementById('hud-del-total'); if (hudDelTotal) hudDelTotal.innerText = counts.delivery.total;
                const hudDelPrep = document.getElementById('hud-del-prep'); if (hudDelPrep) hudDelPrep.innerText = counts.delivery.prep;
                const hudDelReady = document.getElementById('hud-del-ready'); if (hudDelReady) hudDelReady.innerText = counts.delivery.ready;

                const hudBalTotal = document.getElementById('hud-bal-total'); if (hudBalTotal) hudBalTotal.innerText = counts.balcao.total;
                const hudBalPrep = document.getElementById('hud-bal-prep'); if (hudBalPrep) hudBalPrep.innerText = counts.balcao.prep;
                const hudBalReady = document.getElementById('hud-bal-ready'); if (hudBalReady) hudBalReady.innerText = counts.balcao.ready;

                const hudMesasTotal = document.getElementById('hud-mesas-total'); if (hudMesasTotal) hudMesasTotal.innerText = counts.mesas;
                
                // NOVO: Atualiza o badge "Abertas" com o mesmo valor (já filtrado pelo backend)
                const hudMesasActive = document.getElementById('hud-mesas-active'); 
                if (hudMesasActive) hudMesasActive.innerText = counts.mesas;
            }

        } catch (e) {
            console.error("Erro ao buscar pedidos:", e);
        } finally {
            if (loader) loader.classList.add('hidden');
        }
    }

    // --- 1. FUNÇÃO DE LIMPEZA AGRESSIVA (NORMALIZADOR) ---
    function normalizeNeigh(text) {
        if (!text) return "OUTROS";

        return text.toString()
            .normalize("NFD").replace(/[\u0300-\u036f]/g, "") // Remove acentos (ã -> a)
            .replace(/[^a-zA-Z0-9 ]/g, "") // Remove símbolos (traços, pontos)
            .replace(/\s+/g, ' ') // <--- NOVO: Transforma múltiplos espaços em um só ("A  B" -> "A B")
            .trim() // Remove espaços das pontas
            .toUpperCase(); // Tudo Maiúsculo
    }

    // --- RENDERIZADOR INTELIGENTE V6 (DOM DIFFING - ZERO ENGASGO) ---
    function renderKanban(kanbanData) {

        // 1. Atualiza os Contadores (Badges)
        ['PREPARO', 'PRONTO', 'SAIU_ENTREGA', 'ENTREGUE'].forEach(st => {
            // Conta quantos itens tem em cada status (PRONTO é especial pq tem grupos)
            let count = 0;
            if (st === 'PRONTO') {
                const groups = kanbanData['PRONTO'] || [];
                count = groups.reduce((acc, g) => acc + g.orders.length, 0);
            } else {
                count = (kanbanData[st] || []).length;
            }

            const badge = document.getElementById(`count-kanban-${st}`);
            if (badge) badge.innerText = count;
        });

        // 2. Sincroniza Colunas Simples (PREPARO, SAIU_ENTREGA, ENTREGUE)
        ['PREPARO', 'SAIU_ENTREGA', 'ENTREGUE'].forEach(st => {
            const list = kanbanData[st] || [];
            const container = document.getElementById(`kanban-col-${st}`);
            if (container) syncColumn(container, list, st);
        });

        // 3. Sincroniza Coluna PRONTO (Grupos de Bairros)
        // Como grupos mudam pouco, recriamos a estrutura do grupo, mas usamos syncColumn dentro deles
        renderProntoGroups(kanbanData['PRONTO'] || []);
    }

    // --- O SEGREDO DA PERFORMANCE: Sincroniza sem apagar tudo ---
    function syncColumn(container, newList, status) {
        const existingCards = Array.from(container.children);
        const existingMap = new Map();

        // Mapeia o que já está na tela para achar rápido
        existingCards.forEach(card => {
            if (card.id.startsWith('card-')) {
                const id = card.id.replace('card-', '');
                existingMap.set(id, card);
            }
        });

        const newIds = new Set();

        // A) Percorre a lista nova do Python
        newList.forEach(order => {
            const strId = String(order.id);
            newIds.add(strId);

            let cardElement;

            if (existingMap.has(strId)) {
                // JA EXISTE: Só atualiza o texto/tempo
                cardElement = existingMap.get(strId);
                updateCardContent(cardElement, order);
            } else {
                // NOVO: Cria o elemento do zero
                cardElement = createCardElement(order, status);
                container.appendChild(cardElement);
            }

            // --- CORREÇÃO CRÍTICA: Atualiza o JSON do dataset ---
            // Isso garante que o botão "Finalizar" e "Editar" tenham dados para ler
            cardElement.dataset.json = JSON.stringify(order);
        });

        // B) Remove o que sumiu
        existingCards.forEach(card => {
            const id = card.id.replace('card-', '');
            if (card.id.startsWith('card-') && !newIds.has(id)) {
                card.remove();
            }
        });
    }

    // Cria o HTML do Card (CORRIGIDO: Inclui data-json para a coluna PRONTO funcionar)
    function createCardElement(o, status) {
        const div = document.createElement('div');
        div.id = `card-${o.id}`;
        // REMOVI 'overflow-hidden' da classe base se houver, mas mantive o resto
        div.className = `kanban-card bg-slate-800 p-3 rounded-lg border-l-4 shadow-sm hover:shadow-md transition-all cursor-pointer relative group mb-2 animate-fade-in-up`;

        const currentStatus = o.status || status;
        applyCardColor(div, currentStatus, o.css_class);

        let borderClass = 'border-slate-500'; 
        if (currentStatus === 'PENDING') borderClass = 'border-red-500'; 
        else if (currentStatus === 'PREPARO') borderClass = 'border-blue-500';
        else if (currentStatus === 'PRONTO') borderClass = 'border-orange-500 shadow-[0_0_10px_rgba(249,115,22,0.3)]';
        else if (currentStatus === 'SAIU_ENTREGA') borderClass = 'border-green-500'; 
        else if (currentStatus === 'ENTREGUE' || currentStatus === 'CONCLUIDO') borderClass = 'border-slate-600 opacity-60'; 

        if (o.css_class === 'card-oven') borderClass = 'border-red-600 animate-pulse-slow';

        borderClass.split(' ').forEach(cls => { if (cls.trim()) div.classList.add(cls); });

        div.setAttribute('onclick', `openOrderDetails(this)`);
        
        // JSON Vital
        div.dataset.json = JSON.stringify(o); 

        // --- CORREÇÃO DO ÍCONE DE OBSERVAÇÃO ---
        let obsAlert = '';
        // Verifica se 'obs' (que agora vem do backend) ou 'items_desc' tem conteúdo
        const hasNotes = (o.obs && o.obs.trim() !== "");
        const hasItemObs = (o.items_desc && o.items_desc.toLowerCase().includes('obs:'));

        if (hasNotes || hasItemObs) {
            // Mudei a posição de -top-2 para top-0 right-0 para não ser cortado
            obsAlert = `
            <div class="absolute top-0 right-0 z-50 transform translate-x-1/3 -translate-y-1/3">
                <div class="w-6 h-6 bg-yellow-500 rounded-full flex items-center justify-center shadow-md animate-bounce border-2 border-slate-800" title="Ver Observação">
                    <i class="fas fa-exclamation text-slate-900 font-black text-xs"></i>
                </div>
            </div>`;
        }
        // ---------------------------------------

        updateCardContent(div, o);

        if (obsAlert) {
            div.insertAdjacentHTML('beforeend', obsAlert);
        }

        return div;
    }

    function updateCardContent(div, o) {

        applyCardColor(div, o.status, o.css_class);
        const elapsed = o.elapsed || 0; // Correção: usa o campo certo do backend
        let timeColor = 'text-slate-400';

        if (elapsed > 40) timeColor = "text-red-400 font-bold animate-pulse";
        else if (elapsed > 20) timeColor = "text-yellow-400";

        // --- LÓGICA DO ALERTA (OBSERVAÇÃO OU TROCO) ---
        let obsAlertHtml = '';
        
        // 1. Tem Observação Geral?
        const hasNotes = (o.obs && o.obs.trim() !== "");
        
        // 2. Tem Observação nos Itens?
        const hasItemObs = (o.items_desc && o.items_desc.toLowerCase().includes('obs:'));
        
        // 3. Tem Troco no Pagamento? (NOVO)
        const hasChange = (o.payment && o.payment.toLowerCase().includes('troco'));

        // Se QUALQUER uma for verdadeira, mostra o alerta
        if (hasNotes || hasItemObs || hasChange) {
            obsAlertHtml = `
            <div class="absolute top-0 right-0 z-50 transform translate-x-1/3 -translate-y-1/3">
                <div class="w-6 h-6 bg-yellow-500 rounded-full flex items-center justify-center shadow-md animate-bounce border-2 border-slate-800" title="Atenção: Obs ou Troco">
                    <i class="fas fa-exclamation text-slate-900 font-black text-xs"></i>
                </div>
            </div>`;
        }
        // --------------------------------------------

        // Botões de Ação
        let mainBtnHtml = '';
        let backBtnHtml = '';

        if (o.status === 'PREPARO') {
            mainBtnHtml = `<button onclick="event.stopPropagation(); updateOrderStatus(${o.id}, 'PRONTO')" class="flex-1 bg-emerald-600 hover:bg-emerald-500 text-white text-xs font-bold py-2 rounded-lg shadow-lg transition flex items-center justify-center gap-2"><i class="fas fa-check"></i> PRONTO</button>`;
        }
        else if (o.status === 'PRONTO') {
            backBtnHtml = `<button onclick="event.stopPropagation(); updateOrderStatus(${o.id}, 'PREPARO')" class="w-10 h-full rounded-lg bg-slate-700 hover:bg-red-900/50 text-slate-400 hover:text-red-400 border border-slate-600 transition flex items-center justify-center" title="Voltar"><i class="fas fa-chevron-left"></i></button>`;
            
            if (o.delivery_type === 'balcao') {
                mainBtnHtml = `<button onclick="event.stopPropagation(); updateOrderStatus(${o.id}, 'ENTREGUE')" class="flex-1 bg-blue-600 hover:bg-blue-500 text-white text-xs font-bold py-2 rounded-lg shadow-lg transition"><i class="fas fa-walking"></i> RETIROU</button>`;
            } else {
                mainBtnHtml = `<button onclick="event.stopPropagation(); openDispatchModal(${o.id})" class="flex-1 bg-indigo-600 hover:bg-indigo-500 text-white text-xs font-bold py-2 rounded-lg shadow-lg transition flex items-center justify-center gap-2"><i class="fas fa-motorcycle"></i> DESPACHAR</button>`;
            }
        }
        else if (o.status === 'SAIU_ENTREGA') {
            backBtnHtml = `<button onclick="event.stopPropagation(); updateOrderStatus(${o.id}, 'PRONTO')" class="w-10 h-full rounded-lg bg-slate-700 hover:bg-red-900/50 text-slate-400 hover:text-red-400 border border-slate-600 transition flex items-center justify-center" title="Voltar"><i class="fas fa-chevron-left"></i></button>`;
            mainBtnHtml = `<button onclick="event.stopPropagation(); updateOrderStatus(${o.id}, 'ENTREGUE')" class="flex-1 bg-green-600 hover:bg-green-500 text-white text-xs font-bold py-2 rounded-lg shadow-lg transition flex items-center justify-center gap-2"><i class="fas fa-check-circle"></i> FINALIZAR</button>`;
        }
        else if (o.status === 'ENTREGUE') {
            backBtnHtml = `<button onclick="event.stopPropagation(); updateOrderStatus(${o.id}, 'SAIU_ENTREGA')" class="w-10 h-full rounded-lg bg-slate-700 hover:bg-red-900/50 text-slate-400 hover:text-red-400 border border-slate-600 transition flex items-center justify-center" title="Voltar"><i class="fas fa-chevron-left"></i></button>`;
            mainBtnHtml = `<button onclick="event.stopPropagation(); openFinalizePDV(${o.id})" class="flex-1 bg-slate-600 hover:bg-slate-500 text-white text-xs font-bold py-2 rounded-lg shadow-lg transition border border-slate-500 flex items-center justify-center gap-2"><i class="fas fa-archive"></i> ARQUIVAR</button>`;
        }

        const topActions = `
            <div class="flex gap-1 absolute top-2 right-2 z-30">
                <button onclick="event.stopPropagation(); openEditModal(${o.id})" class="w-7 h-7 rounded bg-blue-600 hover:bg-blue-500 text-white flex items-center justify-center shadow-sm border border-blue-500" title="Editar"><i class="fas fa-pen text-[10px]"></i></button>
                <button onclick="event.stopPropagation(); printOrder(${o.id})" class="w-7 h-7 rounded bg-slate-600 hover:bg-slate-500 text-white flex items-center justify-center shadow-sm border border-slate-500" title="Imprimir"><i class="fas fa-print text-[10px]"></i></button>
            </div>
        `;

        const checkboxHtml = `
            <div class="absolute top-3 left-3 z-40" onclick="event.stopPropagation()">
                <input type="checkbox" class="order-checkbox w-4 h-4 rounded bg-slate-900 border-slate-600 text-indigo-500 focus:ring-0 cursor-pointer hidden group-hover:block checked:block" value="${o.id}" onchange="toggleBulkActions()">
            </div>
        `;

        const rawName = o.customer_name || "Cliente";
        const firstName = String(rawName).split(' ')[0];

        // Monta o HTML final
        div.innerHTML = `
            ${obsAlertHtml} ${checkboxHtml}
            ${topActions}
            
            <div class="pl-6 flex justify-between items-start mb-2 relative">
                <div>
                    <span class="font-bold text-white text-sm block truncate w-32" title="${rawName}">${firstName}</span>
                    <span class="font-mono text-[10px] ${timeColor}">${o.time} (${elapsed}m)</span>
                </div>
            </div>

            <div class="pl-6 text-[10px] text-slate-400 mb-2 flex flex-wrap items-center gap-1">
                <span class="bg-slate-700 px-1.5 py-0.5 rounded text-slate-300 font-mono">#${o.wabiz_id || o.id}</span>
                ${o.platform ? `<span class="bg-indigo-900/50 text-indigo-300 border border-indigo-500/30 px-1.5 py-0.5 rounded text-[9px]">${o.platform}</span>` : ''}
            </div>

            <div class="pl-6 text-xs text-slate-300 line-clamp-3 leading-snug min-h-[2.5em] mb-3 border-l-2 border-slate-700 pl-2">
                ${o.items_desc || '<span class="italic opacity-50">Sem itens...</span>'}
            </div>

            <div class="flex gap-2 items-stretch border-t border-slate-700/50 pt-2 mt-auto relative z-20">
                ${backBtnHtml}
                ${mainBtnHtml}
                <div class="flex items-center justify-center bg-slate-900/50 px-2 rounded border border-slate-700">
                    <span class="text-xs font-bold text-emerald-400 font-mono">R$ ${(o.total || 0).toFixed(2)}</span>
                </div>
            </div>
        `;
    }

    // --- PONTE ENTRE O NOVO KANBAN E O PDV ---
    async function openEditModal(orderId) {
        try {
            // 1. Busca os dados frescos do pedido no servidor
            // (Não lemos mais do HTML para não pesar a tela)
            const response = await fetch(`/admin/api/orders/${orderId}`);

            if (!response.ok) throw new Error("Erro ao buscar pedido");

            const orderData = await response.json();

            // 2. Chama a SUA função que já existia e funciona bem
            if (typeof loadOrderIntoPDV === 'function') {
                loadOrderIntoPDV(orderData); // <--- AQUI ESTÁ A MÁGICA

                // Abre o modal (garante que remova o hidden)
                const modal = document.getElementById('pdvModal');
                if (modal) modal.classList.remove('hidden');

            } else {
                console.error("Função loadOrderIntoPDV não encontrada!");
                Swal.fire('Erro', 'Sistema de edição não carregado.', 'error');
            }

        } catch (e) {
            console.error(e);
            Swal.fire('Erro', 'Não foi possível carregar o pedido.', 'error');
        }
    }

    // Função para mover cartões (Avançar/Voltar)
    async function updateOrderStatus(orderId, newStatus) {
        try {
            // Feedback visual rápido (opcional)
            const card = document.getElementById(`card-${orderId}`);
            if (card) card.style.opacity = '0.5';

            const formData = new FormData();
            formData.append('status', newStatus);

            const response = await fetch(`/admin/orders/${orderId}/status`, {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                // O WebSocket vai atualizar a tela automaticamente
                console.log(`Pedido ${orderId} movido para ${newStatus}`);

                // Homologação iFood: Se for para Entrega ou Pronto, a API cuida
            } else {
                throw new Error('Falha ao atualizar');
            }
        } catch (e) {
            console.error(e);
            Swal.fire('Erro', 'Não foi possível mover o pedido.', 'error');
            if (card) card.style.opacity = '1';
        }
    }

    // Renderiza Grupos da Coluna PRONTO (Com Checkbox de Bairro)
    function renderProntoGroups(groups) {
        const container = document.getElementById('kanban-col-PRONTO');
        if (!container) return;

        // OTIMIZAÇÃO: Monta HTML gigante na memória
        const groupsHtml = [];
        let totalPronto = 0;

        groups.forEach((group, index) => {
            totalPronto += group.orders.length;
            const safeGroupId = `group-route-${index}`;
            const groupTotal = group.total_value.toFixed(2);

            // Gera o HTML dos cards internos deste grupo
            // Nota: Aqui precisamos simular o createCardElement em string para performance máxima
            const cardsInGroup = group.orders.map(o => {
                // Truque: Criamos um elemento temporário só para pegar o HTML do card
                // Isso aproveita a lógica do createCardElement sem reescrevê-la
                const tempDiv = createCardElement(o, 'PRONTO');
                return tempDiv.outerHTML;
            }).join('');

            groupsHtml.push(`
                <div class="mb-3 bg-slate-900 rounded-xl border border-slate-700 shadow-sm overflow-hidden animate-fade-in-up">
                    <div class="bg-slate-800 p-3 flex justify-between items-center border-b border-slate-700/50 cursor-pointer hover:bg-slate-750 transition select-none group-header relative" 
                         onclick="toggleGroup('${safeGroupId}')">
                        
                        <div class="flex items-center gap-3 overflow-hidden">
                            <div class="z-20 flex items-center justify-center bg-slate-900 rounded p-1 border border-slate-600 hover:border-indigo-500 transition"
                                 onclick="event.stopPropagation()">
                                <input type="checkbox" class="w-4 h-4 rounded bg-slate-900 border-slate-500 text-indigo-600 focus:ring-0 cursor-pointer"
                                       title="Selecionar Bairro"
                                       onchange="toggleGroupSelection('${safeGroupId}', this)">
                            </div>
                            <span class="bg-emerald-600 text-white text-[10px] font-bold px-2 py-0.5 rounded-full shadow-sm">${group.orders.length}</span>
                            <span class="text-sm font-bold text-emerald-100 truncate uppercase tracking-wide" title="${group.name}">
                                <i class="fas fa-map-marker-alt mr-1 opacity-50"></i> ${group.name}
                            </span>
                        </div>

                        <div class="flex items-center gap-3">
                            <span class="text-[10px] font-mono text-emerald-400 font-bold bg-black/20 px-2 py-1 rounded">R$ ${groupTotal}</span>
                            <i class="fas fa-chevron-down text-slate-500 text-sm transition-transform duration-200 -rotate-90"></i>
                        </div>
                    </div>
                    
                    <div class="p-2 space-y-2 bg-slate-900/30 hidden" id="${safeGroupId}">
                        ${cardsInGroup}
                    </div>
                </div>
            `);
        });

        // Injeção Única (Zero Reflow)
        container.innerHTML = groupsHtml.join('');

        // Atualiza badge
        const badgePronto = document.getElementById('count-kanban-PRONTO');
        if (badgePronto) badgePronto.innerText = totalPronto;
    }


    // Função para Selecionar Todos do Bairro
    function toggleGroupSelection(groupId, masterCheckbox) {
        // Encontra o container dos pedidos desse bairro
        const container = document.getElementById(groupId);
        if (!container) return;

        // Se o grupo estiver fechado, vamos abrir para mostrar a seleção acontecendo (opcional, mas visualmente melhor)
        if (container.classList.contains('hidden') && masterCheckbox.checked) {
            toggleGroup(groupId);
        }

        // Busca todos os checkboxes de pedidos DENTRO deste grupo
        const checkboxes = container.querySelectorAll('.order-checkbox');

        checkboxes.forEach(cb => {
            cb.checked = masterCheckbox.checked;
        });

        // Atualiza a barra flutuante de ações (Motoboy, Finalizar, etc)
        toggleBulkActions();
    }


    // Função de toggle visual (para a setinha girar)
    function toggleGroup(id) {
        const el = document.getElementById(id);
        const header = el.previousElementSibling;
        const icon = header.querySelector('.fa-chevron-down');

        // Alterna a visibilidade
        el.classList.toggle('hidden');

        // Se estiver escondido (hidden), gira a seta para o lado (-90). Se abrir, zera a rotação.
        if (el.classList.contains('hidden')) {
            icon.classList.add('-rotate-90');
        } else {
            icon.classList.remove('-rotate-90');
        }
    }

    function renderMesas(orders) {
        const grid = document.getElementById('grid-mesas');
        if (!grid) return;

        // --- OTIMIZAÇÃO: ARRAY JOIN ---
        const cardsHtml = [];

        for (let i = 1; i <= 20; i++) {
            const order = orders.find(o => o.table == i &&
                o.status !== 'ENTREGUE' &&
                o.status !== 'CONCLUIDO' &&
                !o.status.includes('CANCELADO')
            );
            const isBusy = !!order;
            const cardClass = isBusy ? 'mesa-ocupada' : 'mesa-livre';
            const iconColor = isBusy ? 'text-white' : 'text-slate-600';
            const statusText = isBusy ? `R$ ${order.total.toFixed(2)}` : 'Livre';

            let itemsPreview = '';
            if (isBusy && order.items) {
                order.items.slice(0, 2).forEach(item => {
                    itemsPreview += `<div class="text-[10px] text-slate-300 truncate">• ${item.quantity}x ${item.title || item.name}</div>`;
                });
                if (order.items.length > 2) itemsPreview += `<div class="text-[10px] text-slate-400 italic">+${order.items.length - 2} itens...</div>`;
            }

            const jsonSafe = order ? JSON.stringify(order).replace(/'/g, "&#39;").replace(/"/g, "&quot;") : 'null';

            const printBtn = isBusy
                ? `<button onclick="event.stopPropagation(); printOrder(${order.id})" class="absolute top-2 right-2 bg-slate-800 hover:bg-slate-700 text-slate-300 hover:text-white w-8 h-8 rounded-full shadow border border-slate-600 flex items-center justify-center transition z-20" title="Imprimir Comanda">
                     <i class="fas fa-print text-xs"></i>
                   </button>`
                : '';

            cardsHtml.push(`
            <div class="mesa-card ${cardClass} rounded-2xl p-4 cursor-pointer relative group" onclick="openTablePDV(${i}, ${jsonSafe})">
                
                ${printBtn}

                <div class="flex justify-between items-start">
                    <span class="text-sm font-bold text-slate-400 uppercase">Mesa ${i}</span>
                    ${isBusy ? `<span class="w-3 h-3 bg-green-500 rounded-full animate-pulse shadow-lg shadow-green-500/50"></span>` : ''}
                </div>
                <div class="flex flex-col items-center my-2">
                    <i class="fas fa-utensils text-4xl ${iconColor} mb-2 opacity-80"></i>
                    <span class="text-xl font-bold text-white tracking-tight">${statusText}</span>
                </div>
                <div class="bg-black/20 rounded p-2 h-16 overflow-hidden border border-white/5">
                    ${itemsPreview || '<span class="text-[10px] text-slate-600 flex items-center justify-center h-full">Disponível</span>'}
                </div>
            </div>`);
        }

        // Injeção Única
        grid.innerHTML = cardsHtml.join('');
    }


    function initPDVData() {
        renderGridCategories();

        // Constrói o HTML e o Cache UMA ÚNICA VEZ
        buildProductDOM();

        // Zera carrinho
        CART = [];
        PAYMENTS = [];
        updateCartUI();
    }

    function openPDV() {
        document.getElementById('pdvModal').classList.remove('hidden');
        IS_TABLE_MODE = false;
        resetPDV();
        document.getElementById('pdvTitle').innerText = "Novo Pedido";
        document.getElementById('pdvSubtitle').innerText = "Venda Avulsa / Balcão";
    }


    // --- CONSTRUTOR BLINDADO E ÚNICO (V11) ---
    function buildProductDOM() {
        const grid = document.getElementById('prodGrid');
        if (!grid) return;

        let fullHtml = '';
        CACHED_PROD_CARDS = []; // Reseta o cache
        let visibleCount = 0;

        PDV_DATA.products.forEach(p => {
            try {
                if (!p || !p.id) return;

                const borderColor = p.is_pizza ? 'border-orange-500/30' : 'border-slate-700';
                const cardId = `prod-card-${p.id}`;
                const icon = p.is_pizza ? '<i class="fas fa-pizza-slice text-orange-500 text-xs"></i>' : '<i class="fas fa-box text-indigo-500 text-xs"></i>';

                // Preço
                let contentHtml = '';
                if (p.is_pizza && p.size_prices) {
                    let listItems = Object.entries(p.size_prices).map(([sid, val]) => {
                        const sObj = PDV_DATA.sizes ? PDV_DATA.sizes.find(s => s.id == sid) : null;
                        return { name: sObj ? sObj.name : 'Tam', price: parseFloat(val || 0) };
                    }).sort((a, b) => a.price - b.price).map(s =>
                        `<div class="flex justify-between items-center text-xs text-slate-300 border-b border-white/5 last:border-0 py-1"><span class="truncate mr-2 font-medium">${s.name}</span><span class="text-green-400 font-mono font-bold">R$ ${s.price.toFixed(0)}</span></div>`
                    ).join('');
                    contentHtml = listItems ? `<div class="w-full mt-2 bg-black/40 rounded-lg px-3 py-1 border border-white/5 shadow-inner max-h-[85px] overflow-y-auto custom-scroll">${listItems}</div>` : '<div class="text-red-400 text-xs font-bold mt-auto">Sem preço</div>';
                } else {
                    const priceVal = parseFloat(p.price || 0);
                    contentHtml = `<div class="mt-auto w-full flex justify-end"><div class="text-lg font-bold text-green-400 font-mono bg-black/20 px-3 py-1 rounded border border-green-500/20">R$ ${priceVal.toFixed(2)}</div></div>`;
                }

                // HTML
                fullHtml += `
                <div id="${cardId}" class="prod-card-item ${borderColor} bg-slate-800 border flex flex-col p-3 h-auto min-h-[140px] rounded-xl relative group hover:bg-slate-750 transition shadow-lg cursor-pointer overflow-hidden" onclick="quickAddProduct(${p.id})">
                    <div class="text-sm font-bold text-white leading-snug mb-1 line-clamp-2 group-hover:text-indigo-300 transition h-10">
                        ${p.name || 'Sem Nome'}
                    </div>
                    <div class="mt-auto w-full">${contentHtml}</div>
                    <div class="absolute top-2 right-2 opacity-20 group-hover:opacity-100 transition">${icon}</div>
                </div>`;

                // Cache
                CACHED_PROD_CARDS.push({
                    id: cardId,
                    name: normalizeStr(p.name),
                    catId: p.category_id,
                    // Concatena tudo que vier do backend para garantir a busca
                    fullSearch: normalizeStr(p.search_text || (p.name + " " + (p.description || "") + " " + (p.code || "")))
                });
                visibleCount++;

            } catch (err) { console.error(err); }
        });

        grid.innerHTML = fullHtml;
        console.log(`✅ DOM Construído: ${visibleCount} itens.`);

        // Aplica o filtro inicial (Tudo)
        filterProductsGrid();
    }

    function closePDV() { document.getElementById('pdvModal').classList.add('hidden'); }



    // Função Universal para Carregar Pedido no PDV (Edição)
    function loadOrderIntoPDV(orderData) {

        document.getElementById('pdvModal').classList.remove('hidden');
        resetPDV();

        // 1. Dados Básicos
        const cName = orderData.name || orderData.customer_name || "Cliente";
        const cPhone = orderData.phone || orderData.customer_phone || "";
        document.getElementById('pdvOrderId').value = orderData.id;
        
        setClient({
            id: orderData.customer_id || null,
            name: cName,
            phone: cPhone,
            street: orderData.address_street || orderData.street,
            number: orderData.address_number || orderData.number,
            neighborhood: orderData.address_neighborhood || orderData.neighborhood
        });

        if (orderData.table_number) {
            IS_TABLE_MODE = true;
            document.getElementById('pdvTableNum').value = orderData.table_number;
            document.getElementById('pdvTitle').innerText = `Mesa ${orderData.table_number}`;
            document.getElementById('pdvSubtitle').innerText = "Editando Pedido";
            setDeliveryMode('balcao');
        } else {
            IS_TABLE_MODE = false;
            document.getElementById('pdvTableNum').value = '';
            document.getElementById('pdvTitle').innerText = "Editando Pedido";
            document.getElementById('pdvSubtitle').innerText = `#${orderData.wabiz_id || orderData.id} - ${cName}`;
            
            const rawType = (orderData.delivery_type || "").toLowerCase();
            const addr = (orderData.address_street || "").toLowerCase();
            if (rawType === 'delivery' || (orderData.address_street && !addr.includes('retirada') && !addr.includes('balcão'))) {
                setDeliveryMode('delivery');
                document.getElementById('pdvStreet').value = orderData.address_street || '';
                document.getElementById('pdvNum').value = orderData.address_number || '';
            } else {
                setDeliveryMode('balcao');
            }
        }

        // 4. CARREGA ITENS (COM LÓGICA DE FUSÃO E EXPLOSÃO)
        const itemsList = orderData.items || orderData.items_json || [];

        if (itemsList.length > 0) {
            CART = itemsList.map(i => {
                let stage = (i.kds_stage !== undefined && i.kds_stage !== null) ? parseInt(i.kds_stage) : 0;
                
                let finalType = i.type || (i.parts ? 'pizza' : 'simple');
                let finalParts = i.parts || [];
                let finalPartsRich = i.parts_rich || [];
                let displayTitle = i.title || i.name;
                
                // Tenta usar details existentes
                let finalDetails = i.details || [];
                
                // === CORREÇÃO: SE NÃO TIVER DETAILS, GERA A PARTIR DAS PARTES (COM EXPLOSÃO) ===
                if (finalDetails.length === 0 && finalParts.length > 0) {
                    finalParts.forEach(partStr => {
                        // Limpa nome
                        let cleanPart = partStr.replace(/^\d+\/\d+\s*/, '').trim();

                        // Verifica se tem adicionais no formato "Sabor (+ Add1, Add2)"
                        if (cleanPart.includes('(+')) {
                            const split = cleanPart.split('(+');
                            const flavorName = split[0].trim();
                            const extrasRaw = split[1].replace(')', '').split(',');

                            finalDetails.push({ text: `• ${flavorName}`, type: 'flavor' });
                            
                            extrasRaw.forEach(ext => {
                                if(ext.trim()) finalDetails.push({ text: `+ ${ext.trim()}`, type: 'addon' });
                            });
                        } else {
                            // Sabor simples
                            finalDetails.push({ text: `• ${cleanPart}`, type: 'flavor' });
                        }
                    });

                    // Recupera Borda do Título se necessário
                    if (displayTitle.includes("Borda:")) {
                        try {
                            const edgeName = displayTitle.split("Borda:")[1].split(")")[0].trim();
                            finalDetails.push({ text: `🧀 Borda: ${edgeName}`, type: 'edge' });
                        } catch(e){}
                    }
                }

                return {
                    type: finalType,
                    id: i.external_code || i.id,
                    product_id: i.product_id || i.id,
                    title: displayTitle,
                    price: parseFloat(i.price || 0),
                    quantity: parseFloat(i.quantity || 1),
                    parts: finalParts,       
                    parts_rich: finalPartsRich, 
                    observation: i.observation || "",
                    removed_ingredients: i.removed_ingredients || [],
                    removed_names: i.removed_names || [],
                    details: finalDetails, // Lista explodida e corrigida
                    kds_stage: stage,
                    kds_done: i.kds_done || false
                };
            });
        }

        // 5. Carrega Valores Finais
        document.getElementById('valFee').value = parseFloat(orderData.delivery_fee || 0);
        document.getElementById('chkService10').checked = (parseFloat(orderData.service_fee || 0) > 0);

        const btnCancel = document.getElementById('btnCancelPDV');
        if (btnCancel) btnCancel.classList.remove('hidden');

        // Descontos e Pagamentos
        const savedDiscVal = parseFloat(orderData.discount || 0);
        const subtotal = itemsList.reduce((acc, i) => acc + (parseFloat(i.price || 0) * parseFloat(i.quantity || 1)), 0);
        let savedDiscPerc = 0;
        if (subtotal > 0 && savedDiscVal > 0) savedDiscPerc = (savedDiscVal / subtotal) * 100;
        document.getElementById('valDisc').value = parseFloat(savedDiscPerc.toFixed(2));

        PAYMENTS = [];
        const payString = orderData.payment_method || "";
        if (payString && payString !== "Em Aberto" && payString !== "A Combinar") {
            const parts = payString.split('|');
            parts.forEach(p => {
                let cleanPart = p.split('(')[0].trim();
                const match = cleanPart.match(/(.+):\s*([\d\.]+)/);
                if (match) {
                    PAYMENTS.push({ method: match[1].trim(), value: parseFloat(match[2]) });
                } else {
                    const total = parseFloat(orderData.total_value || 0);
                    if (PAYMENTS.length === 0 && total > 0 && cleanPart.length > 2) {
                        PAYMENTS.push({ method: cleanPart, value: total });
                    }
                }
            });
        }

        updateCartUI();
    }


    // Função chamada pelo Lápis do Modal
    async function editOrderFromModal() {
        if (!CURRENT_MODAL_ORDER_ID) return;

        // Busca dados completos (Do card ou fetch se necessário)
        // Hack rápido: Pega do card que tem o dataset
        const card = document.querySelector(`.kanban-card[data-json*='"id": ${CURRENT_MODAL_ORDER_ID},']`) ||
            document.querySelector(`.kanban-card[data-json*='"id":${CURRENT_MODAL_ORDER_ID},']`);

        if (card) {
            const data = JSON.parse(card.dataset.json);
            closeOrderModal();
            loadOrderIntoPDV(data);
        } else {
            // Fallback: Se não achar o card (raro), recarrega
            Swal.fire('Erro', 'Não foi possível carregar os dados para edição.', 'error');
        }
    }

    // --- 1. FUNÇÃO QUE ABRE O PDV DE MESA (CORRIGIDA: BUSCA DADOS COMPLETOS) ---
    async function openTablePDV(tableNum, orderSummary) { // orderSummary vem do card (incompleto)
        document.getElementById('pdvModal').classList.remove('hidden');
        IS_TABLE_MODE = true;
        resetPDV();

        document.getElementById('pdvTableNum').value = tableNum;
        document.getElementById('pdvTitle').innerText = `Mesa ${tableNum}`;
        document.getElementById('pdvSubtitle').innerText = "Atendimento de Mesa";
        document.getElementById('chkService10').checked = true;

        const btnCancel = document.getElementById('btnCancelPDV');

        if (orderSummary) {
            // MESA OCUPADA
            if (btnCancel) btnCancel.classList.remove('hidden');
            
            // Feedback de carregamento
            const originalTitle = document.getElementById('pdvTitle').innerText;
            document.getElementById('pdvTitle').innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Carregando...';

            try {
                // === AQUI ESTÁ A CORREÇÃO ===
                // O orderSummary (do card) não tem parts_rich. Buscamos o completo na API.
                const res = await fetch(`/admin/api/orders/${orderSummary.id}`);
                if (!res.ok) throw new Error("Erro ao buscar detalhes");
                const fullOrder = await res.json();
                
                // Usa o objeto COMPLETO daqui pra frente
                populatePDVWithOrder(fullOrder, tableNum);
                
            } catch (e) {
                console.error("Erro ao abrir mesa:", e);
                Swal.fire("Erro", "Falha ao carregar dados da mesa.", "error");
                closePDV();
            } finally {
                document.getElementById('pdvTitle').innerText = originalTitle;
            }

        } else {
            // MESA NOVA
            if (btnCancel) btnCancel.classList.add('hidden');
            CURRENT_ORDER_ID = null;
            setDeliveryMode('balcao');
            updateCartUI();
        }
    }

    // Função auxiliar para preencher os dados (extraída para reutilização)
    function populatePDVWithOrder(orderJson, tableNum) {
        document.getElementById('pdvOrderId').value = orderJson.id;

        if (orderJson.customer_name && !orderJson.customer_name.toLowerCase().includes('mesa ' + tableNum)) {
            setClient({ name: orderJson.customer_name, phone: orderJson.customer_phone });
        } else {
            document.getElementById('pdvName').value = `Mesa ${tableNum}`;
        }

        // 1. Carrega Itens (COM DADOS TÉCNICOS COMPLETOS)
        if (orderJson.items_json) {
            CART = orderJson.items_json.map(i => {
                let stage = 0;
                if (i.kds_stage !== undefined && i.kds_stage !== null) {
                    stage = parseInt(i.kds_stage);
                } else {
                    const status = orderJson.status;
                    if (status === 'PRONTO' || status === 'SAIU_ENTREGA' || status === 'EXPEDICAO') stage = 1;
                    else if (status === 'ENTREGUE' || status === 'CONCLUIDO') stage = 2;
                }
                
                // Limpeza Visual do Título
                let displayTitle = i.title || i.name;
                const hasDetails = i.details && i.details.length > 0;
                const isPizza = i.type === 'pizza' || i.is_pizza || (i.parts && i.parts.length > 0);

                if (isPizza && hasDetails && displayTitle.includes(':')) {
                    displayTitle = displayTitle.split(':')[0].trim();
                }
                
                return {
                    type: isPizza ? 'pizza' : 'simple',
                    id: i.external_code || i.id,
                    product_id: i.product_id || i.id,
                    title: displayTitle,
                    price: parseFloat(i.price || 0),
                    quantity: parseFloat(i.quantity || 1),
                    
                    // --- DADOS VITAIS (Vindos da API completa) ---
                    parts: i.parts || [],
                    parts_rich: i.parts_rich || [], // <--- Agora isso vem preenchido!
                    // ---------------------------------------------
                    
                    observation: i.observation || "",
                    removed_ingredients: i.removed_ingredients || [],
                    removed_names: i.removed_names || [],
                    details: i.details || [],
                    
                    kds_stage: stage,
                    kds_done: i.kds_done
                };
            });
        }

        // 2. RECUPERA PAGAMENTOS
        PAYMENTS = [];
        const payString = orderJson.payment_method || "";
        if (payString && payString !== "Em Aberto" && !payString.includes("A Combinar") && payString !== "Não Informado") {
            const parts = payString.split('|');
            parts.forEach(p => {
                let cleanPart = p.split('(')[0].trim();
                const match = cleanPart.match(/(.+):\s*([\d\.]+)/);
                if (match) {
                    PAYMENTS.push({ method: match[1].trim(), value: parseFloat(match[2]) });
                } else {
                    let total = parseFloat(orderJson.total_value || 0);
                    if (PAYMENTS.length === 0 && total > 0 && cleanPart.length > 2) {
                            PAYMENTS.push({ method: cleanPart, value: total });
                    }
                }
            });
        }

        updateCartUI();

        // 3. Recupera Desconto
        const savedDiscMoney = parseFloat(orderJson.discount || 0);
        const currentSubtotal = CART.reduce((acc, i) => acc + (i.price * i.quantity), 0);

        if (savedDiscMoney > 0 && currentSubtotal > 0) {
            const percent = (savedDiscMoney / currentSubtotal) * 100;
            document.getElementById('valDisc').value = parseFloat(percent.toFixed(2));
            updateCartUI(); 
        } else {
            document.getElementById('valDisc').value = 0;
            updateCartUI();
        }
    }

    // --- 2. FUNÇÃO QUE ABRE O PDV AVULSO (ESCONDE O BOTÃO) ---
    function openPDV() {
        document.getElementById('pdvModal').classList.remove('hidden');
        IS_TABLE_MODE = false;
        resetPDV();

        document.getElementById('pdvTitle').innerText = "Novo Pedido";
        document.getElementById('pdvSubtitle').innerText = "Venda Avulsa / Balcão";

        // Esconde botão cancelar pois é pedido novo
        const btnCancel = document.getElementById('btnCancelPDV');
        if (btnCancel) btnCancel.classList.add('hidden');
    }

    // --- 3. AÇÃO DO CLIQUE NO BOTÃO CANCELAR DO PDV ---
    function cancelCurrentPdvOrder() {
        // Pega o ID que está no campo oculto do PDV
        const orderId = document.getElementById('pdvOrderId').value;

        if (orderId) {
            // Se tem ID (Mesa aberta), chama o fluxo de cancelamento com senha
            confirmCancelOrder(orderId);
        } else {
            // Se é um pedido novo não salvo (apenas digitou itens), limpa a tela
            if (confirm('Limpar dados e sair?')) closePDV();
        }
    }

    function resetPDV() {
        IS_FINALIZE_MODE = false;

        CART = [];
        PAYMENTS = [];
        CURRENT_CLIENT = null;

        document.getElementById('pdvSearch').value = '';
        document.getElementById('prodSearch').value = '';
        document.getElementById('valFee').value = 0;
        document.getElementById('valDisc').value = 0;
        document.getElementById('valTip').value = 0; // Reseta Caixinha
        document.getElementById('valCredit').value = 0; // Reseta Crédito
        document.getElementById('chkService10').checked = false;
        document.getElementById('pdvOrderId').value = '';
        document.getElementById('pdvTableNum').value = '';

        // Reseta visibilidade dos botões e campos
        document.getElementById('finalizationFields').classList.add('hidden');
        document.getElementById('btnConcludeForever').classList.add('hidden');

        // Restaura Botões Normais
        const btnSave = document.getElementById('btnSaveOrder');
        const btnPay = document.getElementById('btnOpenPay');

        if (btnSave) btnSave.classList.remove('hidden');

        if (btnPay) {
            btnPay.innerHTML = '<i class="fas fa-wallet"></i> <span>PAGAR</span>';
            btnPay.className = "flex-[1.5] bg-emerald-600 hover:bg-emerald-500 text-white border border-emerald-400/30 py-3 rounded-xl font-bold text-lg shadow-lg shadow-emerald-900/30 flex items-center justify-center gap-2 transition transform active:scale-95";
        }

        clearClient();
        updateCartUI();
        closePaymentLayer();
    }


    // --- FILTRO RÁPIDO CORRIGIDO ---
    function filterProductsGrid() {
        const term = normalizeStr(document.getElementById('prodSearch').value);
        const activeCat = CURRENT_CAT_FILTER;
        let visibleCount = 0;

        CACHED_PROD_CARDS.forEach(item => {
            const el = document.getElementById(item.id);
            if (!el) return;

            // Busca no texto completo (Nome + Descrição + Código)
            const matchesTerm = item.fullSearch.includes(term);

            const matchesCat = (String(activeCat) === 'all') || (item.catId == activeCat);

            if (matchesTerm && matchesCat) {
                el.style.display = '';
                visibleCount++;
            } else {
                el.style.display = 'none';
            }
        });
        console.log(`🔍 Filtro: ${visibleCount} visíveis.`);
    }


    async function quickAddProduct(id) {
        const p = PDV_DATA.products.find(x => x.id == id);
        if (!p) return;

        const config = p.config || {};

        // 1. Se for Combo Flexível (com escolhas), abre o modal específico
        if (config.combo_type === 'flexible' || (config.flexible_rules && config.flexible_rules.length > 0)) {
            openComboPDV(p);
            return;
        }

        // 2. Se for Pizza, abre o modal de Pizza
        if (p.is_pizza) {
            openPizzaModal(p); 
            return;
        }

        // 3. --- LÓGICA VISUAL: GERA A DESCRIÇÃO PARA O POPUP ---
        let descriptionHtml = '';
        let generatedDetails = [];

        // A) Se tiver descrição cadastrada, usa ela
        if (p.description) {
            const descFormatted = p.description.replace(/\n/g, '<br>');
            descriptionHtml = `
                <div class="bg-indigo-900/30 border border-indigo-500/30 p-3 rounded-lg mb-4 text-left">
                    <label class="text-[10px] font-bold text-indigo-400 uppercase mb-1 block">O que vem:</label>
                    <div class="text-sm text-slate-200 leading-snug">${descFormatted}</div>
                </div>`;
        }

        // B) Se for Combo Fixo, gera a lista técnica para o carrinho (details)
        // E se não tiver descrição (A), gera uma visual provisória agora
        if (p.combo_items && p.combo_items.length > 0) {
            let autoDescList = [];
            
            p.combo_items.forEach(cItem => {
                const child = PDV_DATA.products.find(x => x.id == cItem.product_id);
                const childName = child ? child.name : 'Item Fixo';
                const q = parseInt(cItem.qty) || 1;
                
                // Dados para o carrinho/KDS
                generatedDetails.push({
                    type: 'info',
                    text: `• ${q}x ${childName}`,
                    code: cItem.product_id
                });

                // Dados para visualização (se não tiver descrição cadastrada)
                autoDescList.push(`• ${q}x ${childName}`);
            });

            // Se não tinha descrição no cadastro, usa a gerada agora
            if (!descriptionHtml && autoDescList.length > 0) {
                descriptionHtml = `
                <div class="bg-indigo-900/30 border border-indigo-500/30 p-3 rounded-lg mb-4 text-left">
                    <label class="text-[10px] font-bold text-indigo-400 uppercase mb-1 block">Conteúdo do Combo:</label>
                    <div class="text-sm text-slate-200 leading-snug">${autoDescList.join('<br>')}</div>
                </div>`;
            }
        }
        // -----------------------------------------------------------

        // 4. Ingredientes (Remoção)
        let ingredientsHtml = '';
        if (p.ingredients && p.ingredients.length > 0) {
            ingredientsHtml = `<div class="text-left mt-3 bg-slate-800 p-2 rounded border border-slate-700">
                <label class="text-[10px] font-bold text-slate-400 uppercase mb-2 block">Ingredientes (Desmarque para remover)</label>
                <div class="grid grid-cols-2 gap-2">`;
            p.ingredients.forEach(ing => {
                ingredientsHtml += `
                <label class="flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" class="ing-check w-4 h-4 rounded bg-slate-900 border-slate-600 text-red-500 focus:ring-0" 
                           value="${ing.id}" data-name="${ing.name}" checked> <span class="text-xs text-slate-300">${ing.name}</span>
                </label>`;
            });
            ingredientsHtml += `</div></div>`;
        }

        const { value: formValues } = await Swal.fire({
            title: p.name,
            html: `
                <div class="space-y-3">
                    ${descriptionHtml} <div class="flex gap-4">
                        <div class="flex-1">
                            <label class="text-xs font-bold text-slate-500 uppercase block mb-1">Quantidade</label>
                            <input type="number" id="swal-qty" class="w-full bg-slate-900 border border-slate-600 rounded p-2 text-white font-bold text-center text-lg" value="1">
                        </div>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-500 uppercase block mb-1">Observação</label>
                        <input type="text" id="swal-obs" class="w-full bg-slate-900 border border-slate-600 rounded p-2 text-white text-sm" placeholder="Ex: Bem passado...">
                    </div>
                    ${ingredientsHtml}
                </div>
            `,
            background: '#1e293b', color: '#fff',
            showCancelButton: true, confirmButtonText: 'Adicionar', confirmButtonColor: '#16a34a', cancelButtonText: 'Cancelar',
            preConfirm: () => {
                const removedIds = [];
                const removedNames = [];
                if (p.ingredients) {
                    document.querySelectorAll('.ing-check').forEach(cb => {
                        if (!cb.checked) { removedIds.push(parseInt(cb.value)); removedNames.push(cb.dataset.name); }
                    });
                }
                return { qty: document.getElementById('swal-qty').value, obs: document.getElementById('swal-obs').value, removed: removedIds, removed_names: removedNames };
            }
        });

        if (formValues) {
            const qty = parseFloat(formValues.qty) || 1;
            
            if (formValues.removed_names && formValues.removed_names.length > 0) {
                formValues.removed_names.forEach(remName => {
                    generatedDetails.push({
                        type: 'removed',
                        text: `Sem ${remName}`,
                        code: null
                    });
                });
            }
            
            CART.push({
                type: generatedDetails.length > 0 ? 'combo' : 'simple',
                id: p.id, 
                product_id: p.id,
                title: p.name, 
                price: p.price, 
                quantity: qty,
                observation: formValues.obs, 
                removed_ingredients: formValues.removed, 
                removed_names: formValues.removed_names,
                details: generatedDetails, 
                kds_stage: 0,
                kds_done: false
            });
            
            updateCartUI();
            if (navigator.vibrate) navigator.vibrate(20);
        }
    }

    // --- UI CARRINHO (HÍBRIDA: CRIAÇÃO + EDIÇÃO) ---
    function updateCartUI() {
        const list = document.getElementById('cartList');
        list.innerHTML = '';
        let subtotal = 0;

        CART.forEach((item, idx) => {
            const totalItem = item.price * item.quantity;
            subtotal += totalItem;
            let htmlContent = '';

            // MODO 1: VISUALIZAÇÃO KDS (LISTA LIMPA)
            if (item.details && item.details.length > 0) {
                
                // Limpa título principal
                let mainTitle = item.title;
                if ((item.type === 'pizza' || item.is_pizza) && mainTitle.includes(':')) {
                    mainTitle = mainTitle.split(':')[0].trim();
                }

                let detailsHtml = '';
                
                item.details.forEach(det => {
                    // Garante string
                    let txt = (det.text || det || "").toString().trim();
                    const type = det.type || 'info';
                    
                    if (!txt) return;

                    // --- RENDERIZAÇÃO ESTILO KDS ---

                    // 1. SABOR (Branco, Negrito, Separado)
                    if (type === 'flavor' || txt.startsWith('•')) {
                        const cleanName = txt.replace(/^•\s*/, '').replace(/^\d+\/\d+\s*/, '').split('(')[0].trim();
                        // Margem top para separar do sabor anterior
                        const mt = detailsHtml === '' ? '' : 'mt-3';
                        
                        detailsHtml += `
                            <div class="${mt} text-sm text-white font-bold border-l-2 border-indigo-500 pl-2 leading-tight">
                                ${cleanName}
                            </div>`;
                    } 
                    // 2. ADICIONAL (Verde, Bloco separado, Recuado)
                    else if (type === 'addon' || txt.startsWith('+')) {
                        const cleanName = txt.replace(/^\+\s*/, '').replace(/\(|\)/g, '').trim();
                        detailsHtml += `
                            <div class="text-xs text-green-400 ml-4 mt-1 font-medium flex items-center">
                                <i class="fas fa-plus text-[9px] mr-1 opacity-70"></i> ${cleanName}
                            </div>`;
                    }
                    // 3. REMOÇÃO (Vermelho, Bloco separado, Recuado)
                    else if (type === 'removed' || txt.startsWith('Sem ') || txt.startsWith('-')) {
                        const cleanName = txt.replace(/^Sem\s*/, '').replace(/^-\s*/, '').replace(/\(|\)/g, '').trim();
                        detailsHtml += `
                            <div class="text-xs text-red-400 ml-4 mt-1 font-medium flex items-center">
                                <i class="fas fa-ban text-[9px] mr-1 opacity-70"></i> Sem ${cleanName}
                            </div>`;
                    }
                    // 4. BORDA (Laranja, Destaque final)
                    else if (type === 'edge' || txt.includes('🧀') || txt.includes('Borda:')) {
                        const cleanName = txt.replace('🧀', '').replace('Borda:', '').replace(/\(|\)/g, '').trim();
                        detailsHtml += `
                            <div class="mt-3 pt-1 border-t border-slate-700/50 text-xs text-orange-400 font-bold flex items-center ml-2">
                                <i class="fas fa-ring text-[10px] mr-1"></i> Borda: ${cleanName}
                            </div>`;
                    }
                    // 5. OBS E OUTROS
                    else if (type === 'obs') {
                        // Ignora aqui para colocar no final ou renderiza simples
                    } 
                    else {
                        detailsHtml += `<div class="text-xs text-slate-400 ml-2 mt-0.5">${txt}</div>`;
                    }
                });

                // Observação Final (Caixa Amarela)
                let finalObs = item.observation;
                if (!finalObs) {
                    const obsDet = item.details.find(d => d.type === 'obs');
                    if (obsDet) finalObs = obsDet.text;
                }

                if (finalObs) {
                    detailsHtml += `
                        <div class="mt-2 mx-1 bg-yellow-900/20 border border-yellow-600/30 p-1.5 rounded text-[10px] text-yellow-200 font-bold uppercase tracking-wide flex items-start gap-1">
                            <i class="fas fa-comment-alt mt-0.5"></i> ${finalObs}
                        </div>`;
                }

                htmlContent = `
                    <div class="font-black text-slate-200 text-sm mb-2 w-full tracking-wide">
                        ${mainTitle}
                    </div>
                    <div class="flex flex-col w-full pb-1">
                        ${detailsHtml}
                    </div>
                `;
            }
            // MODO 2: VISUALIZAÇÃO BASEADA EM CRIAÇÃO
            else {
                // (Código do Modo 2 mantido idêntico à resposta anterior)
                if (item.type === 'pizza') {
                    let displayTitle = item.title;
                    let edgeText = "";
                    if (displayTitle.includes('(Borda:')) {
                        const parts = displayTitle.split('(Borda:');
                        displayTitle = parts[0].trim();
                        edgeText = "Borda: " + parts[1].replace(')', '').trim();
                    }
                    let sizeText = item.title;
                    let flavors = [displayTitle];
                    if (displayTitle.includes(':')) {
                        const parts = displayTitle.split(':');
                        sizeText = parts[0].trim().toUpperCase().replace(/^PIZZA\s+PIZZA/i, 'PIZZA');
                        flavors = parts[1].split('/').map(f => f.trim());
                    }
                    const fraction = flavors.length > 1 ? `1/${flavors.length}` : '';
                    let flavorsHtml = '';
                    flavors.forEach(flavor => {
                        flavorsHtml += `<div class="text-sm text-slate-300 ml-2 border-l-2 border-slate-600 pl-2 mt-1 leading-snug flex items-start">${fraction ? `<span class="text-indigo-400 font-bold mr-1 text-xs mt-0.5">${fraction}</span>` : ''}<span>${flavor}</span></div>`;
                    });
                    let extrasHtml = '';
                    if (edgeText) extrasHtml += `<div class="text-xs text-orange-400 font-bold mt-1 ml-2 flex items-center gap-1"><i class="fas fa-ring text-[10px]"></i> ${edgeText}</div>`;
                    if (item.removed_names && item.removed_names.length > 0) {
                        extrasHtml += `<div class="text-xs text-red-400 font-bold mt-1 ml-2 flex items-center gap-1"><i class="fas fa-minus-circle text-[10px]"></i> Sem: ${item.removed_names.join(', ')}</div>`;
                    }
                    if (item.observation) {
                        extrasHtml += `<div class="text-xs text-yellow-500 italic mt-1 ml-2 font-medium flex items-start gap-1"><i class="fas fa-comment text-[10px] mt-0.5"></i> ${item.observation}</div>`;
                    }
                    let simpleSub = '';
                    if(item.observation) simpleSub += `<div class="text-xs text-yellow-500 italic"><i class="fas fa-comment"></i> ${item.observation}</div>`;
                    
                        htmlContent = `
                            <div class="text-sm font-bold text-slate-200 leading-snug">${item.title}</div>
                            ${simpleSub}`;

                    htmlContent = `<div class="font-bold text-white text-sm mb-1 border-b border-white/10 pb-1 w-full tracking-wide">${sizeText}</div>${flavorsHtml}${extrasHtml}`;
                } else {
                    let details = [];
                    if (item.removed_names && item.removed_names.length > 0) details.push(`<span class="text-red-400 font-bold">Sem ${item.removed_names.join(', ')}</span>`);
                    if (item.observation) details.push(`<span class="text-yellow-500 font-medium">Obs: ${item.observation}</span>`);
                    let subInfo = details.length > 0 ? `<div class="text-xs leading-tight mt-1 ml-1">${details.join(' • ')}</div>` : '';
                    htmlContent = `<div class="text-sm font-bold text-slate-200 leading-snug">${item.title}</div>${subInfo}`;
                }
            }

            list.innerHTML += `
            <div class="cart-item flex items-start justify-between p-3 border-b border-slate-700/50 hover:bg-slate-800 transition group select-none relative">
                <div class="font-mono text-slate-400 font-bold text-base w-8 text-center shrink-0 pt-0.5">${item.quantity}x</div>
                <div class="flex-1 min-w-0 px-2">${htmlContent}</div>
                <div class="flex flex-col items-end gap-2 shrink-0">
                    <div class="cursor-pointer group text-right" onclick="editItemPrice(${idx})" title="Clique para alterar o valor">
                        <span class="text-[10px] text-slate-500 group-hover:text-indigo-400 transition block">Unit: ${item.price.toFixed(2)}</span>
                        <span class="text-green-400 font-mono font-bold text-sm border-b border-dashed border-transparent group-hover:border-green-500 transition">R$ ${totalItem.toFixed(2)}</span>
                    </div>
                    
                    <div class="flex gap-1">
                        <button onclick="editCartItem(${idx})" class="text-slate-500 hover:text-blue-400 transition w-8 h-8 flex items-center justify-center rounded hover:bg-slate-700/50" title="Editar Item">
                            <i class="fas fa-pen text-xs"></i>
                        </button>
                        <button onclick="removeItem(${idx})" class="text-slate-500 hover:text-red-500 transition w-8 h-8 flex items-center justify-center rounded hover:bg-slate-700/50" title="Remover">
                            <i class="fas fa-times text-sm"></i>
                        </button>
                    </div>
                </div>
            </div>`;
        });

        if (CART.length === 0) list.innerHTML = `<div class="h-full flex flex-col items-center justify-center text-slate-600 opacity-30 select-none"><i class="fas fa-shopping-basket text-5xl mb-3"></i><span class="text-sm font-bold uppercase tracking-widest">Caixa Livre</span></div>`;

        // ... (cálculos de total mantidos) ...
        const fee = parseFloat(document.getElementById('valFee').value) || 0;
        let service = 0;
        if (document.getElementById('chkService10').checked) service = subtotal * 0.10;
        const discPercent = parseFloat(document.getElementById('valDisc').value) || 0;
        let discValue = subtotal * (discPercent / 100);
        if (discValue > subtotal) discValue = subtotal;
        const lblDisc = document.getElementById('lblDiscValue');
        if (lblDisc) lblDisc.innerText = `- R$ ${discValue.toFixed(2)}`;
        const finalTotal = subtotal + fee + service - discValue;
        document.getElementById('lblTotal').innerText = `R$ ${finalTotal.toFixed(2)}`;
        document.getElementById('lblTotal').dataset.val = finalTotal;
        document.getElementById('lblTotal').dataset.realDiscount = discValue;
        const badge = document.getElementById('itemsCountBadge');
        if (badge) badge.innerText = `${CART.length} itens`;
    }

    // --- FUNÇÃO DE EDIÇÃO (VERSÃO FINAL BLINDADA V4) ---
    async function editCartItem(index) {
        const item = CART[index];
        if (!item) return;

        // Se for Pizza
        if (item.type === 'pizza' || item.is_pizza) {
            const product = PDV_DATA.products.find(p => p.id == item.product_id);
            if (!product) return Swal.fire('Erro', 'Produto original não encontrado.', 'error');

            // 1. Abre o modal e reseta
            await openPizzaModal(product);
            EDITING_CART_INDEX = index; // Marca que é edição
            
            // Muda botão para "ATUALIZAR"
            const btn = document.querySelector('#pizzaModal button[onclick="confirmPizza()"]');
            if(btn) {
                btn.innerHTML = '<i class="fas fa-sync"></i> ATUALIZAR';
                btn.classList.replace('bg-green-600', 'bg-blue-600');
                btn.classList.replace('hover:bg-green-500', 'hover:bg-blue-500');
            }

            // 2. RECUPERA O TAMANHO (LÓGICA BLINDADA V2)
            let sizeObj = null;
            
            // Ordena tamanhos por comprimento do nome (decrescente) para match preciso
            // Ex: Evita que "Grande" dê match errado dentro de "Extra Grande"
            if (PDV_DATA.sizes && PDV_DATA.sizes.length > 0) {
                const sizesSorted = [...PDV_DATA.sizes].sort((a, b) => b.name.length - a.name.length);
                
                for (const s of sizesSorted) {
                    // Verifica se o nome do tamanho está contido no título do item (independente de formatação)
                    if (item.title.toLowerCase().includes(s.name.toLowerCase())) {
                        sizeObj = s;
                        break;
                    }
                }
            }
            
            // Fallback: Se não achou por nome e o produto só tem 1 tamanho configurado, seleciona ele automaticamente
            if (!sizeObj && product.size_prices) {
                const keys = Object.keys(product.size_prices);
                if (keys.length === 1) {
                     sizeObj = PDV_DATA.sizes.find(s => s.id == keys[0]);
                }
            }
            
            if (sizeObj) {
                const sizeInput = document.querySelector(`input[name="size"][value="${sizeObj.id}"]`);
                if (sizeInput) {
                    sizeInput.checked = true;
                    // Simula seleção (isso cria uma linha de sabor vazia que vamos limpar)
                    selectSize(sizeInput.parentElement, sizeObj);
                }
            }

            // 3. RECUPERA SABORES E EXTRAS
            const container = document.getElementById('flavorsContainer');
            container.innerHTML = ''; // Limpa a linha padrão criada pelo selectSize
            CURRENT_FLAVORS_COUNT = 0; 

            // Filtra detalhes que são sabores
            const flavorsList = item.details.filter(d => d.type === 'flavor' || (d.text && d.text.trim().startsWith('•')));
            
            for (let i = 0; i < flavorsList.length; i++) {
                const det = flavorsList[i];
                let flavorId = det.code; 
                
                // FALLBACK: Se não tiver ID, busca pelo nome
                if (!flavorId) {
                    let cleanName = det.text.replace(/^[•\s\d\/½]+/, '').trim(); 
                    const foundProd = PDV_DATA.products.find(p => p.name.toLowerCase() === cleanName.toLowerCase());
                    if (foundProd) flavorId = foundProd.id;
                }

                if (flavorId) {
                    // Adiciona a linha do sabor
                    addFlavorRow(flavorId, i === 0);
                    
                    // Recupera Adicionais deste sabor
                    let currentDetIdx = item.details.indexOf(det);
                    if (currentDetIdx > -1) {
                        for (let j = currentDetIdx + 1; j < item.details.length; j++) {
                            const nextDet = item.details[j];
                            if (nextDet.type === 'flavor' || (nextDet.text && nextDet.text.trim().startsWith('•'))) break;
                            
                            if (nextDet.type === 'addon') {
                                const lastRow = container.lastElementChild;
                                if (lastRow) {
                                    const toggleBtn = lastRow.querySelector('.btn-toggle-extras');
                                    if(toggleBtn) toggleBtn.classList.remove('hidden');
                                    
                                    let chk = null;
                                    if (nextDet.code) {
                                        chk = lastRow.querySelector(`input.flavor-extra-check[value="${nextDet.code}"]`);
                                    } 
                                    
                                    if (!chk) {
                                        let addonName = nextDet.text.replace(/^\+\s*/, '').trim();
                                        chk = Array.from(lastRow.querySelectorAll('input.flavor-extra-check')).find(inp => inp.dataset.name === addonName);
                                    }

                                    if (chk) chk.checked = true;
                                }
                            }
                        }
                    }
                }
            }

            // 4. RECUPERA BORDA
            const edgeDet = item.details.find(d => d.type === 'edge' || (d.text && d.text.includes('Borda')));
            if (edgeDet) {
                let edgeInput = null;
                if (edgeDet.code) {
                    edgeInput = document.querySelector(`input[name="edge"][value="${edgeDet.code}"]`);
                } 
                if (!edgeInput) {
                    let edgeName = edgeDet.text.replace('🧀', '').replace('Borda:', '').trim();
                    edgeInput = Array.from(document.querySelectorAll('input[name="edge"]')).find(inp => inp.dataset.name === edgeName);
                }
                
                if (edgeInput) {
                    edgeInput.checked = true;
                    // REMOVIDO: selectEdge(edgeInput); <--- AQUI ESTAVA O ERRO
                    // A função calcPizza lê diretamente do checkbox marcado, não precisa chamar função extra
                }
            }

            // 5. OBSERVAÇÃO (Agora vai funcionar pois o script não travou antes)
            document.getElementById('pizzaObs').value = item.observation || '';

            // 6. ATUALIZA TOTAIS E VISUAL
            setTimeout(calcPizza, 200); 

        } else {
            // --- EDIÇÃO DE PRODUTO SIMPLES (CORRIGIDA) ---
            const product = PDV_DATA.products.find(p => p.id == item.product_id);
            if (product) {
                
                // 1. Gera HTML da Descrição (Igual ao Adicionar)
                let descriptionHtml = '';
                if (product.description) {
                    const descFormatted = product.description.replace(/\n/g, '<br>');
                    descriptionHtml = `
                        <div class="bg-indigo-900/30 border border-indigo-500/30 p-3 rounded-lg mb-4 text-left">
                            <label class="text-[10px] font-bold text-indigo-400 uppercase mb-1 block">Detalhes:</label>
                            <div class="text-sm text-slate-200 leading-snug">${descFormatted}</div>
                        </div>`;
                }

                // 2. Gera HTML dos Ingredientes (Marcando/Desmarcando conforme o item atual)
                let ingredientsHtml = '';
                if (product.ingredients && product.ingredients.length > 0) {
                    ingredientsHtml = `<div class="text-left mt-3 bg-slate-800 p-2 rounded border border-slate-700">
                        <label class="text-[10px] font-bold text-slate-400 uppercase mb-2 block">Ingredientes (Desmarque para remover)</label>
                        <div class="grid grid-cols-2 gap-2">`;
                    
                    product.ingredients.forEach(ing => {
                        // Verifica se este ingrediente estava removido neste item
                        const isRemoved = item.removed_ingredients && item.removed_ingredients.includes(ing.id);
                        const checkedStr = isRemoved ? '' : 'checked';
                        
                        ingredientsHtml += `
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" class="edit-ing-check w-4 h-4 rounded bg-slate-900 border-slate-600 text-red-500 focus:ring-0" 
                                   value="${ing.id}" data-name="${ing.name}" ${checkedStr}> <span class="text-xs text-slate-300">${ing.name}</span>
                        </label>`;
                    });
                    ingredientsHtml += `</div></div>`;
                }

                // 3. Abre Modal de Edição (PREENCHIDO)
                const { value: formValues } = await Swal.fire({
                    title: 'Editar: ' + product.name,
                    html: `
                        <div class="space-y-3">
                            ${descriptionHtml} 
                            <div class="flex gap-4">
                                <div class="flex-1">
                                    <label class="text-xs font-bold text-slate-500 uppercase block mb-1">Quantidade</label>
                                    <input type="number" id="swal-edit-qty" class="w-full bg-slate-900 border border-slate-600 rounded p-2 text-white font-bold text-center text-lg" 
                                           value="${item.quantity}">
                                </div>
                            </div>
                            <div>
                                <label class="text-xs font-bold text-slate-500 uppercase block mb-1">Observação</label>
                                <input type="text" id="swal-edit-obs" class="w-full bg-slate-900 border border-slate-600 rounded p-2 text-white text-sm" 
                                       placeholder="Ex: Bem passado..." value="${item.observation || ''}">
                            </div>
                            ${ingredientsHtml}
                        </div>
                    `,
                    background: '#1e293b', color: '#fff',
                    showCancelButton: true, 
                    confirmButtonText: 'Salvar Alterações', confirmButtonColor: '#3b82f6', 
                    cancelButtonText: 'Voltar',
                    preConfirm: () => {
                        const removedIds = [];
                        const removedNames = [];
                        document.querySelectorAll('.edit-ing-check').forEach(cb => {
                            if (!cb.checked) { removedIds.push(parseInt(cb.value)); removedNames.push(cb.dataset.name); }
                        });
                        return { 
                            qty: document.getElementById('swal-edit-qty').value, 
                            obs: document.getElementById('swal-edit-obs').value, 
                            removed: removedIds, 
                            removed_names: removedNames 
                        };
                    }
                });

                // 4. Salva APENAS se confirmar (Não deleta se cancelar)
                if (formValues) {
                    const qty = parseFloat(formValues.qty) || 1;
                    
                    // Atualiza o objeto existente no carrinho (Preserva ID e Referências)
                    CART[index].quantity = qty;
                    CART[index].observation = formValues.obs;
                    CART[index].removed_ingredients = formValues.removed;
                    CART[index].removed_names = formValues.removed_names;
                    
                    // Se tiver detalhes gerados automaticamente (ex: "Sem Cebola"), atualiza também
                    // (Opcional, pois o updateCartUI lê removed_names na renderização do modo 2)
                    
                    updateCartUI();
                    
                    const Toast = Swal.mixin({ toast: true, position: 'bottom', showConfirmButton: false, timer: 1000, background: '#3b82f6', color: '#fff' });
                    Toast.fire({ icon: 'success', title: 'Atualizado!' });
                }
            }
        }
    }


    function removeItem(idx) {
        CART.splice(idx, 1);
        updateCartUI();
    }

    function renderCart() { updateCartUI(); } // Wrapper para os onchange do HTML antigo


    function setClient(c) {
        CURRENT_CLIENT = c;

        // 1. Preenche Visual
        document.getElementById('lblClientName').innerText = c.name;
        document.getElementById('lblClientPhone').innerText = c.phone || 'Sem telefone';

        let addrText = "Retirada / Sem endereço";
        if (c.street) {
            addrText = `${c.street}, ${c.number || 'S/N'} - ${c.neighborhood || ''}`;
        }
        document.getElementById('lblClientAddress').innerText = addrText;

        // 2. Preenche Campos Ocultos (CRUCIAL PARA SALVAR)
        document.getElementById('pdvName').value = c.name;
        document.getElementById('pdvPhone').value = c.phone;
        document.getElementById('pdvStreet').value = c.street || '';
        document.getElementById('pdvNum').value = c.number || '';

        // Garante que o bairro seja salvo no input oculto
        const neighClean = (c.neighborhood || '').trim();
        document.getElementById('pdvNeigh').value = neighClean;

        // 3. Mostra a caixa do cliente
        document.getElementById('selectedClientBox').classList.remove('hidden');
        document.getElementById('pdvSearch').value = '';
        document.getElementById('pdvSearch').parentElement.classList.add('hidden');

        // 4. Lógica de Taxa (Auto-calcula)
        if (neighClean) {
            const neighUpper = neighClean.toUpperCase();
            // Busca a taxa no objeto PDV_DATA (carregado do banco)
            const fee = PDV_DATA.fees ? PDV_DATA.fees[neighUpper.toLowerCase()] : 0;

            // Só aplica a taxa se for > 0, para não zerar uma taxa manual que você já tenha colocado
            if (fee > 0) {
                document.getElementById('valFee').value = fee;
            }
            // Força modo Delivery
            setDeliveryMode('delivery');
        }

        updateCartUI();
    }

    // 2. Nova função para abrir modal em modo Edição Completa
    function editClientFull() {
        if (!CURRENT_CLIENT) return;
        // Passa o ID e flag de edição
        openNewClientModal({
            isEdit: true,
            id: CURRENT_CLIENT.id // <--- O Backend precisa mandar o ID na busca (veremos isso abaixo)
        });
    }

    function clearClient() {
        CURRENT_CLIENT = null;
        document.getElementById('pdvName').value = '';
        document.getElementById('pdvPhone').value = '';
        document.getElementById('selectedClientBox').classList.add('hidden');
        document.getElementById('pdvSearch').parentElement.classList.remove('hidden');
        document.getElementById('valFee').value = 0;
        updateCartUI();
    }


    // --- FUNÇÃO PARA ABRIR O MODAL DE PAGAMENTO ---
    async function openPaymentLayer() {
        // 1. Validações Iniciais
        if (CART.length === 0) {
            return Swal.fire('Ops', 'Carrinho vazio.', 'warning');
        }
        
        // Verifica se há itens pendentes (função auxiliar do seu sistema)
        if (typeof confirmCheckItems === 'function') {
            if (!await confirmCheckItems()) return;
        }

        // 2. Prepara os Dados
        const totalElement = document.getElementById('lblTotal');
        if (!totalElement) return console.error("Erro: lblTotal não encontrado");
        
        const total = parseFloat(totalElement.dataset.val);
        
        // Carrega pagamentos existentes (se estiver editando)
        // A função loadOrderIntoPDV já deve ter preenchido a variável PAYMENTS
        // Se for pedido novo, PAYMENTS começa vazio ou com o total se preferir lógica automática
        
        // 3. Renderiza a Lista Visual
        renderPaymentList(total);

        // 4. Atualiza os Textos do Modal
        const displayTotal = document.getElementById('payTotalDisplay');
        const inputVal = document.getElementById('payInputVal');
        
        if (displayTotal) displayTotal.innerText = `R$ ${total.toFixed(2)}`;
        
        // Sugere o valor total no input para facilitar (se ainda faltar tudo)
        const paid = PAYMENTS.reduce((s, p) => s + p.value, 0);
        const remaining = total - paid;
        if (inputVal && remaining > 0) {
            inputVal.value = remaining.toFixed(2);
        }

        // 5. ABRE O MODAL (Aqui estava o erro provável)
        const layer = document.getElementById('paymentLayer');
        if (layer) {
            layer.classList.remove('translate-y-full');
        } else {
            console.error("CRÍTICO: A div com id='paymentLayer' não foi encontrada no HTML.");
            Swal.fire('Erro Técnico', 'O modal de pagamento não foi encontrado na página.', 'error');
        }
    }

    function closePaymentLayer() {
        document.getElementById('paymentLayer').classList.add('translate-y-full');
    }

    function selectPayMethod(method, btn) {
        // 1. Visual dos Botões
        document.querySelectorAll('.pay-btn-opt').forEach(b => b.classList.remove('active', 'ring-2', 'ring-indigo-500', 'bg-indigo-900'));
        btn.classList.add('active', 'ring-2', 'ring-indigo-500', 'bg-indigo-900');

        // 2. Define método
        document.getElementById('selectedMethod').value = method;

        // 3. Foco e Seleção do Input
        const input = document.getElementById('payInputVal');
        const label = document.getElementById('payInputLabel');

        // --- AQUI ESTÁ A MÁGICA ---
        if (method === 'Dinheiro') {
            // Muda texto para instruir sobre o troco
            label.innerHTML = '<i class="fas fa-hand-holding-usd"></i> Quanto o cliente entregou? (Calcula Troco)';
            label.className = "text-xs font-bold text-yellow-400 ml-1 mb-1 animate-pulse";
            input.classList.add('border-yellow-500', 'text-yellow-400');
        } else {
            // Volta ao normal
            label.innerHTML = 'Valor a Cobrar';
            label.className = "text-xs font-bold text-slate-400 ml-1 mb-1";
            input.classList.remove('border-yellow-500', 'text-yellow-400');
        }

        input.focus();
        input.select(); // Seleciona o texto para facilitar a digitação do valor entregue
    }

    function addPayment() {
        const val = parseFloat(document.getElementById('payInputVal').value);
        const method = document.getElementById('selectedMethod').value;
        const total = parseFloat(document.getElementById('lblTotal').dataset.val);

        if (!method) return Swal.fire('Selecione o método (Pix, Dinheiro...)');
        if (!val || val <= 0) return;

        // Calcula quanto já foi pago
        const paidSoFar = PAYMENTS.reduce((sum, p) => sum + p.value, 0);

        // Verifica se vai exceder muito (opcional, mas bom pra evitar erro)
        // Deixamos passar se for dinheiro (troco), mas avisamos se for cartão

        PAYMENTS.push({ method, value: val });
        renderPaymentList(total);

        // Limpa input e calcula restante para sugerir
        const newPaid = paidSoFar + val;
        const remaining = total - newPaid;
        document.getElementById('payInputVal').value = remaining > 0 ? remaining.toFixed(2) : '';
    }

    function removePayment(idx) {
        PAYMENTS.splice(idx, 1);
        const total = parseFloat(document.getElementById('lblTotal').dataset.val);
        renderPaymentList(total);
    }

    // Atualiza a lista visual de pagamentos e controla os botões
    function renderPaymentList(total) {
        const listEl = document.getElementById('paymentListEl');
        if (listEl) listEl.innerHTML = ''; // Proteção
        
        let paid = 0;
        if (typeof PAYMENTS !== 'undefined') {
            PAYMENTS.forEach((p, idx) => {
                paid += p.value;
                if (listEl) {
                    const div = document.createElement('div');
                    div.className = "flex justify-between items-center bg-slate-700 p-2 rounded mb-2 border border-slate-600";
                    div.innerHTML = `
                        <span class="text-white"><i class="fas fa-money-bill-wave mr-2 text-emerald-400"></i> ${p.method}</span>
                        <div class="flex items-center gap-3">
                            <span class="font-bold text-white">R$ ${p.value.toFixed(2)}</span>
                            <button onclick="removePayment(${idx})" class="text-red-400 hover:text-red-300 transition"><i class="fas fa-trash"></i></button>
                        </div>
                    `;
                    listEl.appendChild(div);
                }
            });
        }

        const remaining = total - paid;
        
        // --- AQUI ESTAVA O ERRO ---
        const lblRest = document.getElementById('payRestanteDisplay');
        
        // Só tenta escrever se o elemento EXISTIR no HTML
        if (lblRest) {
            if (remaining > 0.05) {
                lblRest.innerHTML = `Faltam: <span class="text-red-400 font-bold">R$ ${remaining.toFixed(2)}</span>`;
            } else if (remaining < -0.05) {
                lblRest.innerHTML = `Troco: <span class="text-blue-400 font-bold">R$ ${Math.abs(remaining).toFixed(2)}</span>`;
            } else {
                lblRest.innerHTML = `<span class="text-emerald-400 font-bold"><i class="fas fa-check"></i> Pago</span>`;
            }
        }

        // Libera os botões de ação
        const btnFinish = document.getElementById('btnActionFinish');
        if (btnFinish) btnFinish.disabled = false;
    }


    // --- FINALIZAR PEDIDO (VERSÃO BLINDADA CONTRA ERRO 422) ---
    async function finishOrderProfessional(isExplicitFinish = false) {

        // 1. Validação de Taxa
        if (!await validateDeliveryFee()) return;

        // --- Bloqueio de Interface ---
        const btnSave = document.getElementById('btnActionSave');
        const btnFinish = document.getElementById('btnActionFinish');
        
        if(btnSave) btnSave.disabled = true;
        if(btnFinish) {
            btnFinish.disabled = true;
            btnFinish.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> PROCESSANDO...';
        }

        const restoreButtons = () => {
            if(btnSave) btnSave.disabled = false;
            if(btnFinish) {
                btnFinish.disabled = false;
                btnFinish.innerHTML = '<i class="fas fa-check-double"></i> PAGAR E FINALIZAR';
            }
        };

        // --- Leitura e Tratamento de Valores ---
        // (.replace serve para aceitar 5,00 e converter para 5.00)
        const getMoney = (id) => {
            const el = document.getElementById(id);
            if (!el) return 0.0;
            return parseFloat(el.value.replace(',', '.')) || 0.0;
        };

        const deliveryType = IS_TABLE_MODE ? 'balcao' : document.getElementById('pdvDeliveryType').value;
        const feeVal = getMoney('valFee');

        // Validação Delivery sem taxa
        if (deliveryType === 'delivery' && feeVal <= 0) {
            Swal.fire({ icon: 'warning', title: 'Taxa Obrigatória!', text: 'Pedidos de entrega não podem ter taxa R$ 0,00.', background: '#1e293b', color: '#fff' });
            restoreButtons();
            return;
        }

        const discountVal = getMoney('valDisc');
        if (discountVal > 0) {
            const { value: password } = await Swal.fire({
                title: '<i class="fas fa-lock"></i> Autorização Necessária',
                html: `Desconto de R$ ${discountVal.toFixed(2)} requer senha.`,
                input: 'password', icon: 'warning',
                showCancelButton: true, confirmButtonText: 'Autorizar', background: '#1e293b', color: '#fff'
            });
            if (!password) { restoreButtons(); return; }
        }

        // --- Construção do Pagamento ---
        let paymentString = "A Combinar / Na Entrega";
        if (typeof PAYMENTS !== 'undefined' && PAYMENTS.length > 0) {
            paymentString = PAYMENTS.map(p => `${p.method}: ${p.value.toFixed(2)}`).join(' | ');
        }
        
        const totalElement = document.getElementById('lblTotal');
        const total = totalElement ? parseFloat(totalElement.dataset.val) : 0;
        const paid = (typeof PAYMENTS !== 'undefined') ? PAYMENTS.reduce((s, p) => s + p.value, 0) : 0;

        if (paid > total) {
            paymentString += ` (Troco: ${(paid - total).toFixed(2)})`;
        }

        // --- MONTAGEM DO FORMDATA (Envio Seguro) ---
        const fd = new FormData();
        
        // Campos de Texto (Obrigatórios)
        fd.append('customer_name', document.getElementById('pdvName').value || 'Cliente');
        fd.append('customer_phone', document.getElementById('pdvPhone').value || '');
        fd.append('delivery_type', deliveryType);
        fd.append('payment_method', paymentString);
        fd.append('items_json', JSON.stringify(CART)); // Carrinho vazio envia []
        
        // Endereço (Envia vazio se não for delivery para cumprir contrato)
        if (deliveryType === 'delivery') {
            fd.append('address_street', document.getElementById('pdvStreet').value || '');
            fd.append('address_number', document.getElementById('pdvNum').value || '');
            fd.append('address_neighborhood', document.getElementById('pdvNeigh').value || '');
        } else {
            fd.append('address_street', '');
            fd.append('address_number', '');
            fd.append('address_neighborhood', '');
        }

        // Mesa
        if (IS_TABLE_MODE) {
            fd.append('table_number', document.getElementById('pdvTableNum').value || '');
        }

        // Valores Numéricos (Sempre envia, nem que seja 0)
        fd.append('delivery_fee', feeVal);
        const realDisc = totalElement ? (parseFloat(totalElement.dataset.realDiscount) || 0) : 0;
        fd.append('discount', realDisc.toFixed(2));
        
        const chkService = document.getElementById('chkService10');
        if (chkService && chkService.checked) {
            const sub = CART.reduce((s, i) => s + (i.price * i.quantity), 0);
            fd.append('service_fee', (sub * 0.10).toFixed(2));
        } else {
            fd.append('service_fee', '0.00');
        }
        
        // Campos opcionais numéricos (Envia 0 para evitar erro de missing field)
        fd.append('driver_tip', getMoney('valTip'));
        fd.append('customer_credit', getMoney('valCredit'));
        // change_for geralmente não usamos via API direta, mas se precisar envie 0
        // fd.append('change_for', 0); 

        const orderId = document.getElementById('pdvOrderId').value;
        if (orderId) fd.append('order_id', orderId);

        // --- LÓGICA DE STATUS ---
        if (isExplicitFinish && IS_FINALIZE_MODE) {
            fd.append('finalize_order', 'True');
            fd.append('force_status', 'CONCLUIDO');
        }

        try {
            const res = await fetch('/admin/orders/save', { method: 'POST', body: fd });
            const data = await res.json();

            if (res.ok && data.success) {
                let titleMsg = 'Salvo!';
                let textMsg = 'Pedido atualizado.';

                if (isExplicitFinish && IS_FINALIZE_MODE) {
                    titleMsg = 'Arquivado!';
                    textMsg = 'Conferência finalizada.';
                } else if (!orderId) {
                    titleMsg = 'Criado!';
                    textMsg = 'Pedido enviado para produção.';
                }

                Swal.fire({
                    icon: 'success', title: titleMsg, text: textMsg,
                    timer: 1500, showConfirmButton: false,
                    background: '#1e293b', color: '#fff'
                });
                closePDV();
                fetchOrders();
            } else {
                // LOG DETALHADO NO CONSOLE
                console.error("❌ ERRO BACKEND:", data);
                // Tenta mostrar mensagem legível
                let msg = data.message || 'Falha ao salvar.';
                if (data.detail && Array.isArray(data.detail)) {
                    // Pega o primeiro erro da lista do Pydantic
                    msg = `Erro no campo: ${data.detail[0].loc[1]} - ${data.detail[0].msg}`;
                }
                Swal.fire('Erro', msg, 'error');
            }
        } catch (e) {
            console.error("❌ ERRO REDE:", e);
            Swal.fire('Erro', 'Falha na conexão.', 'error');
        } finally {
            restoreButtons();
        }
    }


    // --- FUNÇÃO ESPECÍFICA PARA FECHAR MESA (ROTA /close-account) ---
    async function finishTableSession() {
        // 1. Validações Básicas
        if (PAYMENTS.length === 0) {
            return Swal.fire({ icon: 'warning', title: 'Atenção', text: 'Informe o pagamento para fechar a mesa.', background: '#1e293b', color: '#fff' });
        }
        
        const orderId = document.getElementById('pdvOrderId').value;
        const total = parseFloat(document.getElementById('lblTotal').dataset.val);
        const paid = PAYMENTS.reduce((s, p) => s + p.value, 0);

        // 2. Valida se pagou tudo (com margem de segurança de 5 centavos)
        if (paid < total - 0.05) { 
            return Swal.fire({ icon: 'error', title: 'Valor Incompleto', text: `Faltam R$ ${(total - paid).toFixed(2)}`, background: '#1e293b', color: '#fff' });
        }

        // 3. Prepara String de Pagamento (Concatenada)
        let paymentString = PAYMENTS.map(p => `${p.method}: ${p.value.toFixed(2)}`).join(' | ');
        if (paid > total) {
            paymentString += ` (Troco: ${(paid - total).toFixed(2)})`;
        }

        // 4. Interface (Bloqueia botões)
        const btnSave = document.getElementById('btnActionSave');
        const btnFinish = document.getElementById('btnActionFinish');
        
        if(btnSave) btnSave.disabled = true;
        if(btnFinish) {
            btnFinish.disabled = true;
            btnFinish.innerHTML = '<i class="fas fa-spinner fa-spin"></i> FECHANDO MESA...';
        }

        // 5. Prepara Dados para o Backend
        const fd = new FormData();
        // A rota /close-account exige estes campos específicos
        fd.append('payment_method', paymentString);
        fd.append('total_paid', total); 
        
        // Dados Extras (Desconto e Serviço)
        const discReal = parseFloat(document.getElementById('lblTotal').dataset.realDiscount) || 0;
        fd.append('discount', discReal.toFixed(2));
        
        const serviceFee = document.getElementById('chkService10').checked ? (total * 0.10) : 0;
        fd.append('service_fee', serviceFee.toFixed(2));

        try {
            // CHAMA A ROTA ESPECÍFICA DE MESA
            // Essa rota força o status CONCLUIDO, o que libera a mesa na hora
            const res = await fetch(`/admin/orders/${orderId}/close-account`, { method: 'POST', body: fd });
            const data = await res.json();

            if (res.ok) {
                Swal.fire({
                    icon: 'success', 
                    title: 'Mesa Encerrada!', 
                    text: 'Mesa liberada e pedido concluído.',
                    timer: 1500, 
                    showConfirmButton: false,
                    background: '#1e293b', 
                    color: '#fff'
                });
                closePaymentLayer();
                closePDV();
                fetchOrders(); // Atualiza o grid de mesas imediatamente
            } else {
                Swal.fire({ icon: 'error', title: 'Erro', text: data.message || 'Falha ao fechar mesa', background: '#1e293b', color: '#fff' });
            }
        } catch (e) {
            console.error(e);
            Swal.fire({ icon: 'error', title: 'Erro', text: 'Falha na conexão', background: '#1e293b', color: '#fff' });
        } finally {
            // Restaura botões em caso de erro
            if(btnSave) btnSave.disabled = false;
            if(btnFinish) {
                btnFinish.disabled = false;
                btnFinish.innerHTML = '<i class="fas fa-check-double"></i> PAGAR E FINALIZAR';
            }
        }
    }


    function renderGridCategories() {
        const container = document.getElementById('catFilterContainer');
        // Botão "Tudo" fixo
        let html = '<div class="cat-chip active" id="chip-all" onclick="filterGridCategory(\'all\')">Tudo</div>';

        // Renderiza categorias vindas do banco
        if (PDV_DATA.categories) {
            PDV_DATA.categories.forEach(c => {
                html += `<div class="cat-chip" id="chip-${c.id}" onclick="filterGridCategory(${c.id})">${c.name}</div>`;
            });
        }
        container.innerHTML = html;
    }

    // --- SELEÇÃO DE CATEGORIA ---
    function filterGridCategory(catId) {
        document.getElementById('prodSearch').value = ''; // Limpa busca
        CURRENT_CAT_FILTER = catId;

        // Atualiza botões
        document.querySelectorAll('.cat-chip').forEach(c => c.classList.remove('active', 'bg-indigo-600', 'text-white', 'border-indigo-600'));
        const targetId = catId === 'all' ? 'chip-all' : `chip-${catId}`;
        const activeBtn = document.getElementById(targetId);
        if (activeBtn) activeBtn.classList.add('active', 'bg-indigo-600', 'text-white', 'border-indigo-600');

        filterProductsGrid();
    }

    // --- LÓGICA DE MODO DE ENTREGA ---
    function setDeliveryMode(mode) {
        document.getElementById('pdvDeliveryType').value = mode;

        const btnBalcao = document.getElementById('btnModeBalcao');
        const btnDelivery = document.getElementById('btnModeDelivery');
        const feeInput = document.getElementById('valFee');

        if (mode === 'balcao') {
            btnBalcao.className = "flex-1 py-1.5 rounded-md text-xs font-bold bg-indigo-600 text-white shadow transition";
            btnDelivery.className = "flex-1 py-1.5 rounded-md text-xs font-bold text-slate-400 hover:text-white transition";

            // Zera taxa se mudar para balcão (opcional)
            feeInput.value = 0;
        } else {
            btnDelivery.className = "flex-1 py-1.5 rounded-md text-xs font-bold bg-green-600 text-white shadow transition";
            btnBalcao.className = "flex-1 py-1.5 rounded-md text-xs font-bold text-slate-400 hover:text-white transition";
        }
        updateCartUI();
    }

    // --- DESPACHO MOTOBOY ---
    function openDispatchModal(id) {
        document.getElementById('dspOrderId').value = id;
        document.getElementById('dispatchModal').classList.remove('hidden');
    }
    function closeDispatchModal() { document.getElementById('dispatchModal').classList.add('hidden'); }

    async function confirmDispatch() {
        const orderIds = document.getElementById('dspOrderId').value;
        const driverId = document.getElementById('dspDriverSelect').value;

        if (!driverId) return Swal.fire('Atenção', 'Selecione um motoboy!', 'warning');

        const fd = new FormData();
        fd.append('driver_id', driverId);
        fd.append('order_ids', orderIds);

        try {
            await fetch('/admin/orders/assign-driver', { method: 'POST', body: fd });

            Swal.fire({
                icon: 'success',
                title: 'Atribuído!',
                text: 'Pedidos enviados para o motoboy.',
                timer: 1500,
                showConfirmButton: false
            });

            closeDispatchModal();
            closeOrderModal(); // Fecha se estiver aberto
            clearBulkSelection(); // Limpa seleção
            fetchOrders(); // Recarrega Kanban
        } catch (e) {
            Swal.fire('Erro', 'Falha ao atribuir motoboy.', 'error');
        }
    }

    // --- LÓGICA DE BUSCA DE CLIENTE (ATUALIZADA) ---

    // --- LÓGICA DE BUSCA DE CLIENTE (CORRIGIDA) ---
    function searchClient(val) {
        const list = document.getElementById('clientList');

        // Limpa se tiver menos de 3 caracteres (igual à regra do Backend)
        if (!val || val.length < 3) {
            list.classList.add('hidden');
            return;
        }

        // Debounce (Reinicia o timer se digitar rápido)
        if (SEARCH_TIMER) clearTimeout(SEARCH_TIMER);

        SEARCH_TIMER = setTimeout(async () => {
            try {
                // EncodeURIComponent é vital para nomes com espaço ou acento
                const encodedVal = encodeURIComponent(val.trim());

                // Mostra um "Carregando..." visual
                list.classList.remove('hidden');
                list.innerHTML = `<div class="p-3 text-slate-500 text-xs text-center"><i class="fas fa-circle-notch fa-spin"></i> Buscando...</div>`;

                const res = await fetch(`/admin/api/customers/search?query=${encodedVal}`);

                if (!res.ok) throw new Error("Erro na API");

                const data = await res.json();

                list.innerHTML = '';

                if (data.length > 0) {
                    data.forEach(c => {
                        // Prepara objeto seguro para o HTML
                        const clientObj = {
                            id: c.id,
                            name: c.name,
                            phone: c.phone,
                            email: c.email || '',
                            birth_date: c.birth_date || '',
                            street: c.street || '',
                            number: c.number || '',
                            neighborhood: c.neighborhood || '',
                            complement: c.complement || '',
                            zip_code: c.zip_code || '',
                            city: c.city || '',
                            state: c.state || ''
                        };

                        // Escapa aspas para não quebrar o HTML inline
                        const jsonC = JSON.stringify(clientObj).replace(/'/g, "&#39;").replace(/"/g, "&quot;");

                        list.innerHTML += `
                        <div class="p-3 hover:bg-slate-700 cursor-pointer border-b border-slate-700 text-sm flex justify-between items-center group transition" onclick='selectClientSearch(${jsonC})'>
                            <div>
                                <div class="font-bold text-white group-hover:text-indigo-300">${c.name}</div>
                                <div class="text-slate-400 text-xs font-mono">${c.phone}</div>
                            </div>
                            ${c.neighborhood ? `<span class="text-[10px] bg-slate-800 px-1.5 py-0.5 rounded text-slate-500 border border-slate-700">${c.neighborhood}</span>` : ''}
                        </div>`;
                    });
                } else {
                    list.innerHTML = `<div class="p-3 text-slate-500 text-xs italic text-center">Nenhum cliente encontrado.</div>`;
                }

                // Opção de Cadastro Rápido sempre visível
                list.innerHTML += `
                <div class="p-3 bg-indigo-900/20 hover:bg-indigo-900/40 cursor-pointer text-sm text-indigo-400 font-bold border-t border-slate-700 flex items-center justify-center gap-2 transition" onclick="createNewClient('${val.replace(/'/g, "\\'")}')">
                    <i class="fas fa-user-plus"></i> CADASTRAR "${val}"
                </div>`;

            } catch (e) {
                console.error("Erro busca cliente:", e);
                list.innerHTML = `<div class="p-3 text-red-400 text-xs text-center">Erro ao buscar.</div>`;
            }
        }, 400); // 400ms de espera para não sobrecarregar o servidor
    }


    // Função intermediária para fechar a lista e chamar o setClient (que já criamos no passo anterior)
    function selectClientSearch(clientData) {
        setClient(clientData);
        document.getElementById('clientList').classList.add('hidden');
    }


    // Fecha a lista se clicar fora
    document.addEventListener('click', function (event) {
        const box = document.querySelector('.relative'); // Container do input
        const list = document.getElementById('clientList');
        if (list && !list.classList.contains('hidden') && !box.contains(event.target)) {
            list.classList.add('hidden');
        }
    });

    // --- 1. FUNÇÃO INTERMEDIÁRIA (Conecta o Botão HTML à Lógica) ---
    function cancelFromViewModal() {
        if (CURRENT_MODAL_ORDER_ID) {
            confirmCancelOrder(CURRENT_MODAL_ORDER_ID); // Chama a lógica pesada (Senha/Motivo)
        } else {
            console.error("Erro: Nenhum ID de pedido carregado no modal.");
        }
    }

    // --- FUNÇÃO DE VISUALIZAÇÃO BLINDADA ---
    async function openOrderDetails(el) {
        if (event && (event.target.tagName === 'BUTTON' || event.target.tagName === 'INPUT' || event.target.closest('button'))) return;

        const o = JSON.parse(el.dataset.json);
        CURRENT_MODAL_ORDER_ID = o.id; 

        // 1. Limpa e Preenche Dados Básicos (Do Card)
        document.getElementById('voId').innerText = `#${o.wabiz_id}`;
        document.getElementById('voStatusBadge').innerText = o.status;
        document.getElementById('voName').innerText = o.name;
        document.getElementById('voPhone').innerText = o.phone || '--';
        document.getElementById('voEmail').innerText = o.email || 'Não informado';
        document.getElementById('voAddress').innerText = o.address;
        document.getElementById('voDriverName').innerText = o.driver_name || "Sem Motoboy";

        // Whatsapp
        const btnWpp = document.getElementById('voWppLink');
        if (btnWpp) {
            if (o.phone) {
                btnWpp.href = `https://wa.me/${o.phone.replace(/\D/g, '')}`;
                btnWpp.classList.remove('hidden');
            } else {
                btnWpp.classList.add('hidden');
            }
        }

        // Botão Cancelar
        const btnCancel = document.getElementById('btnCancelView');
        if (btnCancel) btnCancel.onclick = function () { confirmCancelOrder(o.id); };

        // 2. RENDERIZAÇÃO DOS ITENS (PRIORIDADE)
        renderModalItems(o.items);

        // Abre o modal
        document.getElementById('viewOrderModal').classList.remove('hidden');

        // 3. BUSCA DADOS FINANCEIROS FRESCOS (Backend)
        try {
            const res = await fetch(`/admin/api/orders/${o.id}`);
            if (res.ok) {
                const fullData = await res.json();
                
                // Debug no Console (F12) para ver se a taxa veio
                console.log("💰 Dados Financeiros Recebidos:", fullData);

                // --- NOVA LÓGICA: OBSERVAÇÃO DO PEDIDO ---
                const obsContainer = document.getElementById('modal-order-obs-container');
                const obsText = document.getElementById('modal-order-obs-text');
                
                if (fullData.notes && fullData.notes.trim() !== "") {
                    obsText.innerText = fullData.notes;
                    obsContainer.classList.remove('hidden'); // Mostra a caixa amarela
                } else {
                    obsContainer.classList.add('hidden');    // Esconde se não tiver obs
                    obsText.innerText = '';
                }

                // Pagamento
                document.getElementById('voPayment').innerText = fullData.payment_method || '-';

                // Taxa de Entrega (Força conversão para float)
                const feeVal = parseFloat(fullData.delivery_fee || 0);
                const elFee = document.getElementById('voDeliveryFee');
                if(elFee) {
                    elFee.innerText = `R$ ${feeVal.toFixed(2)}`;
                    // Se for maior que 0, pinta de amarelo para destacar
                    if(feeVal > 0) elFee.className = "text-yellow-400 font-mono font-bold";
                    else elFee.className = "text-slate-500 font-mono";
                }

                // Desconto
                const discVal = parseFloat(fullData.discount || 0);
                document.getElementById('voDiscount').innerText = `R$ -${discVal.toFixed(2)}`;

                // Troco (Amarelo)
                const boxChange = document.getElementById('boxVoChange');
                const changeVal = parseFloat(fullData.change || 0);
                if (boxChange) {
                    if (changeVal > 0) {
                        boxChange.classList.remove('hidden');
                        document.getElementById('voChangeVal').innerText = `R$ ${changeVal.toFixed(2)}`;
                    } else {
                        boxChange.classList.add('hidden');
                    }
                }

                // Total Final
                document.getElementById('voTotal').innerText = `R$ ${parseFloat(fullData.total_value).toFixed(2)}`;
            }
        } catch (e) {
            console.error("Erro ao atualizar financeiro:", e);
        }
    }

    // --- RENDERIZADOR DE ITENS (CORRIGIDO PARA MOSTRAR DETALHES) ---
    function renderModalItems(items) {
        const iDiv = document.getElementById('voItems');
        iDiv.innerHTML = '';
        
        if (!items || items.length === 0) {
            iDiv.innerHTML = '<div class="text-center text-slate-500 italic p-4">Sem itens.</div>';
            return;
        }

        items.forEach(i => {
            const totalItem = (parseFloat(i.price || 0) * parseFloat(i.quantity || 1)).toFixed(2);
            let mainTitle = i.title || i.name || "Item";

            // Limpeza de título de pizza
            if ((i.type === 'pizza' || i.is_pizza) && mainTitle.includes(':')) {
                mainTitle = mainTitle.split(':')[0].trim();
            }

            // GERA HTML DOS DETALHES (O que estava sumindo)
            let detailsHtml = '';
            
            // Prioriza 'details' (novo padrão), mas tenta 'display_lines' (legado) se falhar
            const detailsList = i.details || i.display_lines || [];

            if (detailsList.length > 0) {
                detailsList.forEach(det => {
                    // Garante que é string ou objeto {text: ...}
                    const txt = (det.text || det || "").toString().trim();
                    const type = det.type || 'info';
                    
                    if (!txt) return;

                    if (type === 'flavor' || txt.startsWith('•')) {
                        // Sabor (Branco com borda)
                        detailsHtml += `<div class="text-sm text-slate-200 ml-2 border-l-2 border-indigo-500 pl-2 mt-1 leading-snug font-medium">${txt.replace('•', '').trim()}</div>`;
                    } 
                    else if (type === 'addon' || txt.startsWith('+')) {
                        // Adicional (Verde)
                        detailsHtml += `<div class="text-xs text-green-400 ml-4 font-bold mt-0.5 flex items-center gap-1"><i class="fas fa-plus text-[8px]"></i> ${txt.replace('+', '').trim()}</div>`;
                    } 
                    else if (type === 'edge' || txt.includes('Borda') || txt.includes('🧀')) {
                        // Borda (Laranja)
                        detailsHtml += `<div class="text-xs text-orange-400 ml-4 font-bold italic mt-1 flex items-center gap-1"><i class="fas fa-ring text-[10px]"></i> ${txt.replace('🧀', '').trim()}</div>`;
                    } 
                    else if (type === 'removed' || txt.includes('Sem ')) {
                        // Remoção (Vermelho)
                        detailsHtml += `<div class="text-xs text-red-400 ml-4 font-bold decoration-red-500/50 flex items-center gap-1 mt-0.5"><i class="fas fa-ban text-[8px]"></i> ${txt}</div>`;
                    } 
                    else {
                        // Info genérica
                        detailsHtml += `<div class="text-xs text-slate-400 ml-3 mt-0.5">${txt}</div>`;
                    }
                });
            }

            // HTML da Linha
            iDiv.innerHTML += `
            <div class="flex justify-between items-start p-3 rounded-lg border border-slate-700/50 bg-slate-900 text-slate-300 hover:bg-slate-800 transition">
                <div class="flex-1">
                    <div class="font-bold text-sm text-white flex items-center gap-2">
                        <span class="bg-slate-700 text-slate-300 px-1.5 rounded text-xs font-mono">${parseInt(i.quantity)}x</span> 
                        ${mainTitle}
                    </div>
                    
                    <div class="mt-1 space-y-0.5">
                        ${detailsHtml}
                    </div>

                    ${i.observation ? `<div class="text-yellow-500 text-xs italic mt-2 bg-yellow-900/10 p-1 rounded inline-block border border-yellow-500/20"><i class="fas fa-comment-alt mr-1"></i> ${i.observation}</div>` : ''}
                </div>
                <span class="font-mono text-sm font-bold text-emerald-400 ml-3 whitespace-nowrap">R$ ${totalItem}</span>
            </div>`;
        });
    }
    


    function closeOrderModal() {
        document.getElementById('viewOrderModal').classList.add('hidden');
    }

    // --- 4. FUNÇÃO PARA O BOTÃO DO MODAL FUNCIONAR ---
    function openDispatchFromModal() {
        if (!CURRENT_MODAL_ORDER_ID) {
            console.error("Erro: Nenhum pedido selecionado.");
            return;
        }
        closeOrderModal(); // Fecha o detalhe
        openDispatchModal(CURRENT_MODAL_ORDER_ID); // Abre a tela de motoboy
    }

    // --- LÓGICA DE AÇÃO EM MASSA ---

    function toggleBulkActions() {
        const checked = document.querySelectorAll('.order-checkbox:checked');
        const bar = document.getElementById('bulkActionBar');

        if (checked.length > 0) {
            document.getElementById('bulkCount').innerText = checked.length;
            bar.classList.add('active');
        } else {
            bar.classList.remove('active');
        }
    }

    function clearBulkSelection() {
        document.querySelectorAll('.order-checkbox').forEach(c => c.checked = false);
        toggleBulkActions();
    }

    function openBulkDispatch() {
        const checked = document.querySelectorAll('.order-checkbox:checked');
        if (checked.length === 0) return;

        const ids = Array.from(checked).map(c => c.value).join(',');

        // Reusa o modal de despacho existente, mas passa os IDs múltiplos
        document.getElementById('dspOrderId').value = ids;
        document.getElementById('dispatchModal').classList.remove('hidden');
    }


    function showFlavor2() {
        document.getElementById('boxFlavor2').classList.remove('hidden');
        document.getElementById('btnAddFlavor').classList.add('hidden');
        calcPizza();
    }


    // Estilização bonita para o Select2 (Opcional)
    function formatState(state) {
        if (!state.id) return state.text;
        return $(`<div class="flex justify-between"><span>${state.text.split('(')[0]}</span><span class="text-green-400 font-mono text-xs">${state.text.split('(')[1] || ''}</span></div>`);
    }

    function removeFlavorRow(rowId) {
        document.getElementById(rowId).remove();
        CURRENT_FLAVORS_COUNT--;
        updateUI();
        onFlavorChange();
    }

    function updateUI() {
        // CORREÇÃO: Atualiza o texto "X/Y Selecionados"
        const counterEl = document.getElementById('flavorCounter');
        if (counterEl) {
            counterEl.innerText = `${CURRENT_FLAVORS_COUNT}/${MAX_FLAVORS_ALLOWED} Selecionados`;

            // Destaque visual se atingiu o limite
            if (CURRENT_FLAVORS_COUNT === MAX_FLAVORS_ALLOWED) {
                counterEl.classList.add('bg-green-900', 'text-green-400', 'border-green-700');
                counterEl.classList.remove('bg-slate-800', 'text-slate-400', 'border-slate-700');
            } else {
                counterEl.classList.remove('bg-green-900', 'text-green-400', 'border-green-700');
                counterEl.classList.add('bg-slate-800', 'text-slate-400', 'border-slate-700');
            }
        }

        // Controla visibilidade do botão "Adicionar Sabor"
        const btn = document.getElementById('btnAddFlavor');
        if (btn) {
            if (CURRENT_FLAVORS_COUNT < MAX_FLAVORS_ALLOWED) {
                btn.classList.remove('hidden');
            } else {
                btn.classList.add('hidden');
            }
        }
    }

    async function updateStatus(id, st) { await fetch(`/admin/orders/${id}/status`, { method: 'POST', body: new URLSearchParams({ status: st }) }); fetchOrders(); }

    // --- CHECKOUT ---
    function openCheckoutModal() {
        const modal = document.getElementById('checkoutModal');
        const totalRaw = CART.reduce((sum, i) => sum + (i.price * i.quantity), 0);
        document.getElementById('chkTableNum').innerText = document.getElementById('pdvTableNum').value;
        document.getElementById('chkSubtotal').dataset.val = totalRaw;
        document.getElementById('chkSubtotal').innerText = `R$ ${totalRaw.toFixed(2)}`;
        calcCheckout();
        modal.classList.remove('hidden');
    }

    function calcCheckout() {
        const subtotal = parseFloat(document.getElementById('chkSubtotal').dataset.val);
        const hasFee = document.getElementById('chkServiceFee').checked;
        const discount = parseFloat(document.getElementById('chkDiscount').value) || 0;
        const fee = hasFee ? subtotal * 0.10 : 0;
        const final = subtotal + fee - discount;
        document.getElementById('chkFeeVal').innerText = `R$ ${fee.toFixed(2)}`;
        document.getElementById('chkFinalTotal').innerText = `R$ ${final.toFixed(2)}`;
        document.getElementById('chkFinalTotal').dataset.val = final;
    }

    function setPayMethod(method) {
        document.querySelectorAll('.pay-btn').forEach(b => b.classList.remove('ring-2', 'ring-indigo-500', 'bg-slate-700'));
        event.target.classList.add('ring-2', 'ring-indigo-500', 'bg-slate-700');
        document.getElementById('chkPayMethod').value = method;
    }

    async function confirmCloseAccount() {
        const method = document.getElementById('chkPayMethod').value;
        if (!method) return alert('Selecione o Pagamento');
        const fee = document.getElementById('chkServiceFee').checked ? (parseFloat(document.getElementById('chkSubtotal').dataset.val) * 0.10) : 0;
        const disc = document.getElementById('chkDiscount').value;
        const total = document.getElementById('chkFinalTotal').dataset.val;
        const fd = new FormData();
        fd.append('payment_method', method); fd.append('service_fee', fee); fd.append('discount', disc); fd.append('total_paid', total);
        try { await fetch(`/admin/orders/${CURRENT_ORDER_ID}/close-account`, { method: 'POST', body: fd }); closeCheckoutModal(); closePDV(); fetchOrders(); } catch (e) { alert('Erro ao fechar'); }
    }

    function closeCheckoutModal() { document.getElementById('checkoutModal').classList.add('hidden'); }

    function sendBillWhatsapp() {
        const table = document.getElementById('pdvTableNum').value;
        const total = document.getElementById('chkFinalTotal').innerText;
        let msg = `🧾 *Comanda Mesa ${table}*\n\n`;
        CART.forEach(i => { msg += `▫️ ${i.quantity}x ${i.title} - R$ ${(i.price * i.quantity).toFixed(2)}\n`; });
        if (document.getElementById('chkServiceFee').checked) msg += `\nTaxa de Serviço (10%): ${document.getElementById('chkFeeVal').innerText}`;
        msg += `\n\n*TOTAL: ${total}*`;
        msg += `\n\nObrigado pela preferência! 🍕`;
        const phone = document.getElementById('pdvPhone').value.replace(/\D/g, '') || '';
        const url = `https://wa.me/${phone}?text=${encodeURIComponent(msg)}`;
        window.open(url, '_blank');
    }

    // --- FUNÇÕES DO MODAL DE NOVO CLIENTE ---

    function openNewClientModal(prefillData = {}) {
        // ... (limpezas iniciais mantidas) ...
        document.querySelectorAll('#newClientModal input').forEach(i => i.value = '');
        document.getElementById('boxNewNeigh').classList.add('hidden');
        document.getElementById('ncId').value = prefillData.id || '';

        // ... (populateNcNeighSelect mantido) ...
        populateNcNeighSelect(prefillData.neighborhood);

        if (prefillData.name) document.getElementById('ncName').value = prefillData.name;
        if (prefillData.phone) document.getElementById('ncPhone').value = prefillData.phone;

        if (prefillData.isEdit && CURRENT_CLIENT) {
            // ... (campos existentes mantidos) ...
            document.getElementById('ncId').value = CURRENT_CLIENT.id || '';
            document.getElementById('ncName').value = CURRENT_CLIENT.name;
            document.getElementById('ncPhone').value = CURRENT_CLIENT.phone;
            document.getElementById('ncEmail').value = CURRENT_CLIENT.email || '';

            // --- CORREÇÃO: Preenche a Data de Nascimento ---
            document.getElementById('ncBirth').value = CURRENT_CLIENT.birth_date || '';
            // -----------------------------------------------

            // ... (endereço mantido) ...
            document.getElementById('ncZip').value = CURRENT_CLIENT.zip_code || '';
            document.getElementById('ncStreet').value = CURRENT_CLIENT.street || '';
            document.getElementById('ncNum').value = CURRENT_CLIENT.number || '';
            document.getElementById('ncComp').value = CURRENT_CLIENT.complement || '';
            document.getElementById('ncCity').value = CURRENT_CLIENT.city || 'São Vicente';
            document.getElementById('ncState').value = CURRENT_CLIENT.state || 'SP';
            populateNcNeighSelect(CURRENT_CLIENT.neighborhood);
        }

        document.getElementById('newClientModal').classList.remove('hidden');
    }

    function closeNewClientModal() {
        document.getElementById('newClientModal').classList.add('hidden');
    }

    // 2. Substitui a função antiga que criava cliente vazio
    function createNewClient(val) {
        const isPhone = val.match(/\d/);
        const data = {
            name: isPhone ? "" : val,
            phone: isPhone ? val : ""
        };
        openNewClientModal(data);
    }

    // 3. Botão "Mudar Endereço"
    function editAddress() {
        // Abre o modal de cadastro preenchido para atualizar os dados
        openNewClientModal({ isEdit: true });
    }

    // --- FUNÇÃO CORRIGIDA (Versão Final: Cache em Minúsculo) ---
    async function submitNewClientFromPOS(e) {
        e.preventDefault();
        const btn = e.target.querySelector('button[type="submit"]');
        const oldHtml = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> ...';
        btn.disabled = true;

        const formData = new FormData(e.target);

        // 1. LÓGICA DE BAIRRO NOVO
        const selectVal = document.getElementById('ncNeighSelect').value;
        let finalNeigh = selectVal;
        let newFeeVal = 0;

        if (selectVal === 'NEW_NEIGH') {
            // Pega o nome digitado e força maiúsculo para ficar bonito no banco
            finalNeigh = document.getElementById('newNeighName').value.trim().toUpperCase();
            newFeeVal = parseFloat(document.getElementById('newNeighFee').value) || 0;

            if (!finalNeigh) {
                Swal.fire('Atenção', 'Digite o nome do novo bairro.', 'warning');
                btn.innerHTML = oldHtml;
                btn.disabled = false;
                return;
            }

            // A. Salva a Taxa no Banco (Background)
            const fdFee = new FormData();
            fdFee.append('neighborhood', finalNeigh);
            fdFee.append('fee', newFeeVal);
            
            try {
                fetch('/admin/api/fees/save', { method: 'POST', body: fdFee });
                
                // B. Atualiza o Cache Local do PDV (CORREÇÃO AQUI: toLowerCase)
                // O sistema lê as chaves sempre em minúsculo, então salvamos assim no cache
                if (typeof PDV_DATA !== 'undefined' && PDV_DATA.fees) {
                    PDV_DATA.fees[finalNeigh.toLowerCase()] = newFeeVal;
                }
            } catch (err) { console.error("Erro ao salvar taxa nova", err); }
        }

        // Substitui "NEW_NEIGH" pelo nome real no formulário
        formData.set('neighborhood', finalNeigh);

        try {
            const res = await fetch('/admin/customers/save', { method: 'POST', body: formData });
            const result = await res.json();

            if (res.ok) {
                const savedId = document.getElementById('ncId').value;

                // Cria objeto atualizado
                const updatedClient = {
                    id: savedId || null,
                    name: document.getElementById('ncName').value,
                    phone: document.getElementById('ncPhone').value,
                    email: document.getElementById('ncEmail').value,
                    birth_date: document.getElementById('ncBirth').value,
                    street: document.getElementById('ncStreet').value,
                    number: document.getElementById('ncNum').value,
                    neighborhood: finalNeigh, // Nome novo
                    zip_code: document.getElementById('ncZip').value,
                    complement: document.getElementById('ncComp').value,
                    city: document.getElementById('ncCity').value,
                    state: document.getElementById('ncState').value
                };

                // Aplica o cliente no PDV (Isso vai puxar a taxa do cache que acabamos de corrigir)
                setClient(updatedClient);
                
                closeNewClientModal();
                Swal.fire({ toast: true, position: 'top-end', icon: 'success', title: 'Salvo!', showConfirmButton: false, timer: 1000 });

            } else {
                Swal.fire('Erro', result.message, 'error');
            }
        } catch (err) {
            console.error(err);
            Swal.fire('Erro', 'Conexão falhou', 'error');
        } finally {
            btn.innerHTML = oldHtml;
            btn.disabled = false;
        }
    }

    // Função auxiliar para buscar e selecionar quando dá conflito
    async function searchAndSelectExisting(phone) {
        try {
            // Usa a API de busca que já temos
            const res = await fetch(`/admin/api/customers/search?query=${phone}`);
            const data = await res.json();

            if (data && data.length > 0) {
                // Pega o primeiro resultado (match exato ou mais próximo)
                setClient(data[0]);
                Swal.fire({ toast: true, position: 'top-end', icon: 'success', title: 'Cliente Selecionado', showConfirmButton: false, timer: 1000 });
            } else {
                Swal.fire('Erro', 'Não foi possível recuperar os dados do cliente existente.', 'error');
            }
        } catch (e) { console.error(e); }
    }

    // --- FUNÇÃO DE BAIRROS COM BUSCA (VERSÃO BLINDADA) ---
    function populateNcNeighSelect(selectedNeigh = null) {
        const $sel = $('#ncNeighSelect');
        
        // 1. Limpeza Completa: Remove Select2 se existir
        if ($sel.hasClass("select2-hidden-accessible")) {
            $sel.select2('destroy');
        }

        // 2. Limpa opções e remove ouvintes antigos (apenas do nosso namespace)
        $sel.empty().off('change.custom');
        
        // Opção Vazia (Placeholder)
        $sel.append(new Option("Selecione ou Digite...", "", true, true));

        // 3. Prepara Dados
        const fees = PDV_DATA.fees || {};
        const sortedKeys = Object.keys(fees).sort();
        const targetUpper = selectedNeigh ? selectedNeigh.trim().toUpperCase() : '';
        let valueToSelect = "";

        // 4. Monta Opções
        sortedKeys.forEach(key => {
            const feeVal = parseFloat(fees[key] || 0).toFixed(2);
            const displayName = key.toUpperCase();
            
            // Cria o objeto Option (Texto, Valor, DefaultSelected, Selected)
            const isSelected = (key.toUpperCase() === targetUpper);
            if (isSelected) valueToSelect = key;
            
            const option = new Option(`${displayName} (R$ ${feeVal})`, key, isSelected, isSelected);
            $sel.append(option);
        });

        // Caso Especial: Bairro do cliente existe mas não tem taxa (Legado)
        if (selectedNeigh && !valueToSelect && selectedNeigh !== 'NEW_NEIGH') {
            const option = new Option(`${selectedNeigh.toUpperCase()} (Sem Taxa)`, selectedNeigh, true, true);
            $sel.append(option);
            valueToSelect = selectedNeigh;
        }

        // Opção de Cadastro
        const newOpt = new Option("+ CADASTRAR NOVO", "NEW_NEIGH");
        $sel.append(newOpt);

        // 5. Inicializa o Select2
        $sel.select2({
            dropdownParent: $('#newClientModal'),
            width: '100%',
            placeholder: "Digite o bairro...",
            language: { noResults: () => "Bairro não encontrado" }
        });

        // 6. Força a seleção visualmente (Crucial para Edição)
        if (valueToSelect) {
            $sel.val(valueToSelect).trigger('change.select2');
        } else {
            // Se for novo cadastro, reseta para vazio
            $sel.val("").trigger('change.select2');
        }

        // 7. Evento de Mudança (Namespace .custom para não quebrar o plugin)
        $sel.on('change.custom', function() {
            toggleNewNeighFields();
        });
        
        // Garante estado inicial dos campos (ex: esconder campo de novo bairro)
        toggleNewNeighFields();
    }

    function toggleNewNeighFields() {
        const val = document.getElementById('ncNeighSelect').value;
        const box = document.getElementById('boxNewNeigh');

        if (val === 'NEW_NEIGH') {
            box.classList.remove('hidden');
            document.getElementById('newNeighName').focus();
        } else {
            box.classList.add('hidden');
        }
    }


    // --- FUNÇÃO DE CANCELAMENTO (MOTIVO + SENHA) ---
    // --- FUNÇÃO DE CANCELAMENTO (ATUALIZADA) ---
    async function confirmCancelOrder(orderId) {
        if (!orderId) return;

        // 1. Motivo
        const { value: reason } = await Swal.fire({
            title: 'Cancelar Pedido',
            text: "Qual o motivo do cancelamento?",
            input: 'text',
            inputPlaceholder: 'Ex: Cliente desistiu...',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            confirmButtonText: 'Próximo',
            background: '#1e293b', color: '#fff',
            inputValidator: (value) => { if (!value) return 'Digite o motivo!'; }
        });

        if (!reason) return;

        // 2. Senha
        const { value: password } = await Swal.fire({
            title: 'Autorização Gerente',
            text: "Senha para confirmar:",
            input: 'password',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            background: '#1e293b', color: '#fff'
        });

        if (!password) return;

        try {
            // 3. Valida Senha
            const fdAuth = new FormData();
            fdAuth.append('password', password);
            const resAuth = await fetch('/admin/auth/verify-admin', { method: 'POST', body: fdAuth });

            if (!resAuth.ok) {
                return Swal.fire({ icon: 'error', title: 'Negado!', text: 'Senha incorreta.', background: '#1e293b', color: '#fff' });
            }

            // 4. Envia Cancelamento
            const fdCancel = new FormData();
            fdCancel.append('reason', reason);
            const resCancel = await fetch(`/admin/orders/${orderId}/cancel`, { method: 'POST', body: fdCancel });
            const dataCancel = await resCancel.json(); // Lê a resposta JSON

            if (resCancel.ok) {
                Swal.fire({
                    icon: 'success',
                    title: 'Cancelado!',
                    text: dataCancel.message, // Mostra mensagem do servidor ("Já estava cancelado" ou "Sucesso")
                    timer: 1500,
                    showConfirmButton: false,
                    background: '#1e293b', color: '#fff'
                });

                // Limpa tudo e recarrega
                closeOrderModal();
                closePDV();
                fetchOrders(); // Isso vai fazer a mesa sumir/ficar verde
            } else {
                // Mostra o erro real que veio do backend
                Swal.fire('Erro', dataCancel.message || 'Falha ao cancelar.', 'error');
            }

        } catch (e) {
            console.error(e);
            Swal.fire('Erro', 'Erro de conexão.', 'error');
        }
    }

    // --- 4. FUNÇÃO DO BOTÃO NO PDV (MESA) ---
    function cancelCurrentPdvOrder() {
        const orderId = document.getElementById('pdvOrderId').value;
        if (orderId) {
            confirmCancelOrder(orderId);
        } else {
            if (confirm('Limpar dados e sair?')) closePDV();
        }
    }


    // --- FUNÇÃO DE SALVAR (ADAPTADA) ---
    async function saveOrderDraft(silent = false, closeOnSuccess = true) {
        if (CART.length === 0) {
            if(!silent) Swal.fire('Vazio', 'Adicione itens primeiro.', 'warning');
            return false;
        }

        // 1. TRAVA DE TAXA
        if (!await validateDeliveryFee()) return false;

        const btn = document.getElementById('btnSaveOrder');
        const oldHtml = btn ? btn.innerHTML : '';
        if(btn) {
            btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i>';
            btn.disabled = true;
        }

        // ... (resto da lógica de captura de dados permanece igual até o fetch) ...
        // Vou resumir a captura aqui para não ocupar espaço, mas MANTENHA A LÓGICA DE CAPTURA DO SEU ARQUIVO ORIGINAL
        // ...
        // COPIE A LÓGICA DE MONTAGEM DO FORMDATA (fd) QUE JÁ EXISTE NO SEU ARQUIVO AQUI
        // ...
        
        // --- REPLICANDO A MONTAGEM DE DADOS PARA VOCÊ COPIAR E COLAR SEGURO ---
        // LIMPEZA PRÉ-ENVIO:
        CART.forEach(item => {
            if (item.kds_done === undefined) { item.kds_done = false; item.kds_stage = 0; }
        });
        const hasNewItems = CART.some(item => !item.kds_done);
        const fd = new FormData();
        if (hasNewItems) fd.append('force_status', 'PREPARO');

        fd.append('customer_name', document.getElementById('pdvName').value || 'Cliente Balcão');
        fd.append('customer_phone', document.getElementById('pdvPhone').value || '');

        let paymentString = "Em Aberto";
        if (typeof PAYMENTS !== 'undefined' && PAYMENTS.length > 0) {
            paymentString = PAYMENTS.map(p => `${p.method}: ${p.value.toFixed(2)}`).join(' | ');
            const total = parseFloat(document.getElementById('lblTotal').dataset.val);
            const paid = PAYMENTS.reduce((s, p) => s + p.value, 0);
            if (paid > total) paymentString += ` (Troco: ${(paid - total).toFixed(2)})`;
        }
        fd.append('payment_method', paymentString);

        if (IS_TABLE_MODE) {
            fd.append('delivery_type', 'balcao');
            fd.append('table_number', document.getElementById('pdvTableNum').value);
        } else {
            const dtype = document.getElementById('pdvDeliveryType').value;
            fd.append('delivery_type', dtype);
            if (dtype === 'delivery') {
                fd.append('address_street', document.getElementById('pdvStreet').value || '');
                fd.append('address_number', document.getElementById('pdvNum').value || '');
                fd.append('address_neighborhood', document.getElementById('pdvNeigh').value || '');
            }
        }

        fd.append('items_json', JSON.stringify(CART));
        fd.append('delivery_fee', document.getElementById('valFee').value || 0);
        const realDisc = parseFloat(document.getElementById('lblTotal').dataset.realDiscount) || 0;
        fd.append('discount', realDisc.toFixed(2));

        if (document.getElementById('chkService10').checked) {
            const sub = CART.reduce((s, i) => s + (i.price * i.quantity), 0);
            fd.append('service_fee', (sub * 0.10).toFixed(2));
        }

        const orderId = document.getElementById('pdvOrderId').value;
        if (orderId) fd.append('order_id', orderId);
        // -----------------------------------------------------------------------

        try {
            const res = await fetch('/admin/orders/save', { method: 'POST', body: fd });
            const data = await res.json();

            if (res.ok && data.success) {
                // --- AQUI ESTÁ A MUDANÇA ---
                if (!silent) {
                    Swal.fire({
                        icon: 'success', title: 'Salvo!', timer: 1000, showConfirmButton: false,
                        background: '#1e293b', color: '#fff'
                    });
                }
                
                // Limpa dock se existir
                if (typeof renderPDVDock === 'function') renderPDVDock(); 

                if (closeOnSuccess) {
                    closePDV();
                    fetchOrders();
                }
                return true; // Retorna sucesso para quem chamou
            } else {
                if(!silent) Swal.fire('Erro', data.message || 'Falha ao salvar', 'error');
                return false;
            }
        } catch (e) {
            if(!silent) Swal.fire('Erro', 'Conexão falhou.', 'error');
            return false;
        } finally {
            if(btn) {
                btn.innerHTML = oldHtml;
                btn.disabled = false;
            }
        }
    }

    // Abre o PDV em modo "Conferência Final"
    async function openFinalizePDV(orderId) {
        const card = document.querySelector(`.kanban-card[onclick*="${orderId}"]`) || document.querySelector(`input[value="${orderId}"]`).closest('.kanban-card');
        if (!card) return;

        const orderData = JSON.parse(card.dataset.json);

        // 1. Carrega dados
        loadOrderIntoPDV(orderData);

        // 2. Ativa Modo Finalização
        IS_FINALIZE_MODE = true;

        document.getElementById('pdvTitle').innerText = "Conferência Final";
        document.getElementById('pdvSubtitle').innerText = "Pedido Entregue - Ajuste Final";

        // Mostra campos de conferência
        document.getElementById('finalizationFields').classList.remove('hidden');
        document.getElementById('btnConcludeForever').classList.remove('hidden');

        // --- PERSONALIZAÇÃO DOS BOTÕES ---
        const btnSave = document.getElementById('btnSaveOrder');
        const btnPay = document.getElementById('btnOpenPay');

        // Esconde "Salvar" (Rascunho)
        if (btnSave) btnSave.classList.add('hidden');

        // Transforma "Pagar" em "Alterar Pagamento" (Azul)
        if (btnPay) {
            btnPay.innerHTML = '<i class="fas fa-edit"></i> <span>ALTERAR PAGAMENTO</span>';
            // Muda classes para Azul (Blue)
            btnPay.className = "flex-[1.5] bg-blue-600 hover:bg-blue-500 text-white border border-blue-400/30 py-3 rounded-xl font-bold text-sm shadow-lg shadow-blue-900/30 flex items-center justify-center gap-2 transition transform active:scale-95";
        }

        // Preenche valores extras
        document.getElementById('valTip').value = orderData.driver_tip || 0;
        document.getElementById('valCredit').value = orderData.customer_credit || 0;
    }

    // Ação do Botão "CONCLUIR E ARQUIVAR"
    async function finalizeOrderForever() {

        // Mesmo na finalização, se tiraram a taxa, precisa de senha
        if (!await validateDeliveryFee()) return;

        // NOVA VERIFICAÇÃO
        if (!await confirmCheckItems()) return;

        const orderId = document.getElementById('pdvOrderId').value;
        const tip = document.getElementById('valTip').value;
        const credit = document.getElementById('valCredit').value;

        // ... (resto da função continua igual) ...
        const fd = new FormData();
        fd.append('order_id', orderId);

        // Envia TODOS os dados normais para garantir consistência
        fd.append('customer_name', document.getElementById('pdvName').value);
        fd.append('customer_phone', document.getElementById('pdvPhone').value);
        fd.append('delivery_type', document.getElementById('pdvDeliveryType').value);
        // ... (resto dos campos obrigatórios se o backend exigir, mas vamos focar no update)

        // IMPORTANTE: Envia os itens atuais para não perder alterações
        fd.append('items_json', JSON.stringify(CART));
        fd.append('payment_method', 'Mantido'); // Ou recupera do objeto original se necessário

        // NOVOS CAMPOS
        fd.append('driver_tip', tip);
        fd.append('customer_credit', credit);
        fd.append('finalize_order', 'True'); // <--- A CHAVE MESTRA

        try {
            const res = await fetch('/admin/orders/save', { method: 'POST', body: fd });
            const data = await res.json();

            if (res.ok) {
                Swal.fire({
                    icon: 'success',
                    title: 'Pedido Concluído!',
                    text: 'Saiu do quadro e foi para o histórico.',
                    timer: 1500, showConfirmButton: false
                });
                closePDV();
                fetchOrders(); // Atualiza o Kanban (o pedido vai sumir da coluna A FINALIZAR)
            } else {
                Swal.fire('Erro', data.message, 'error');
            }
        } catch (e) {
            Swal.fire('Erro', 'Conexão falhou', 'error');
        }
    }

    // ATENÇÃO: Ao resetar o PDV (resetPDV), lembre de esconder os campos novos e mostrar os antigos
    const oldReset = resetPDV;
    resetPDV = function () {
        oldReset(); // Chama original
        document.getElementById('finalizationFields').classList.add('hidden');
        document.getElementById('btnConcludeForever').classList.add('hidden');
        const normalBtns = document.querySelector('#pdvModal .pdv-left .flex.gap-3');
        if (normalBtns) normalBtns.classList.remove('hidden');
    }


    function renderKanbanBalcao(orders) {
        // 1. Prepara as listas na memória
        const cols = { 'PREPARO': [], 'PRONTO': [], 'ENTREGUE': [] };

        orders.forEach(o => {
            let st = (o.status || '').trim().toUpperCase();

            // Normalização de Status (KDS -> Balcão)
            if (st === 'PENDENTE' || st === 'FORNO' || st === 'EXPEDICAO' || st === 'PRONTO_COZINHA') {
                st = 'PREPARO';
                // Mantém o estilo visual de forno se vier do KDS
                if (['FORNO', 'EXPEDICAO'].includes(o.status)) o.css_class = 'card-oven';
            }
            if (st === 'SAIU_ENTREGA') st = 'PRONTO'; // No balcão, saiu = pronto para retirar

            if (cols[st]) cols[st].push(o);
        });

        // 2. Sincroniza (DOM Inteligente)
        Object.keys(cols).forEach(key => {
            const container = document.getElementById(`balcao-col-${key}`);
            const badge = document.getElementById(`count-balcao-${key}`);

            if (container) {
                // Usa a função syncColumn que já criamos (mantém checkboxes e scroll)
                syncColumn(container, cols[key], key);
            }
            if (badge) badge.innerText = cols[key].length;
        });
    }

    // --- LÓGICA DE CONFERÊNCIA (CHECKLIST) ---

    function openCheckOrderModal() {
        if (CART.length === 0) return Swal.fire('Vazio', 'Adicione itens antes de conferir.', 'warning');

        const list = document.getElementById('checkOrderList');
        list.innerHTML = '';

        CART.forEach((item, idx) => {
            // Prepara texto de observações e remoções para destaque
            let obsHtml = '';

            // Observação
            if (item.observation) {
                obsHtml += `<div class="mt-2 text-xl font-bold text-yellow-400 bg-yellow-900/20 p-2 rounded border border-yellow-500/30 flex items-start gap-2">
                                <i class="fas fa-exclamation-triangle mt-1"></i> OBS: ${item.observation}
                            </div>`;
            }

            // Remoções (Sem cebola, etc) - Vermelho Grande
            if (item.removed_names && item.removed_names.length > 0) {
                obsHtml += `<div class="mt-2 text-xl font-bold text-red-400 bg-red-900/20 p-2 rounded border border-red-500/30 flex items-start gap-2">
                                <i class="fas fa-ban mt-1"></i> SEM: ${item.removed_names.join(', ')}
                            </div>`;
            }

            // Nome do Item (Trata Pizza vs Simples)
            let titleHtml = item.title;
            // Se for pizza, destaca os sabores
            if (item.type === 'pizza' || item.title.includes('/')) {
                titleHtml = item.title.replace(':', ':<br>').replace('/', '<br>+ ');
            }

            // HTML da Linha (Checkbox Gigante + Texto Grande)
            list.innerHTML += `
            <label class="flex items-start gap-6 p-6 bg-slate-800 rounded-2xl border-2 border-slate-700 cursor-pointer hover:bg-slate-750 transition group select-none relative overflow-hidden">
                <input type="checkbox" class="peer sr-only" onchange="toggleCheckRow(this)">
                
                <div class="w-12 h-12 flex-shrink-0 rounded-xl border-4 border-slate-500 peer-checked:bg-green-500 peer-checked:border-green-500 flex items-center justify-center transition-all bg-slate-900 mt-1">
                    <i class="fas fa-check text-white text-2xl opacity-0 peer-checked:opacity-100 scale-50 peer-checked:scale-100 transition-all"></i>
                </div>

                <div class="flex-1 opacity-100 peer-checked:opacity-50 peer-checked:line-through transition-all">
                    <div class="flex items-start gap-3">
                        <div class="bg-indigo-600 text-white font-black text-2xl px-4 py-2 rounded-lg shadow-lg">
                            ${item.quantity}x
                        </div>
                        <div class="text-3xl text-white font-bold leading-tight">
                            ${titleHtml}
                        </div>
                    </div>
                    ${obsHtml}
                </div>
                
                <div class="absolute inset-0 bg-green-500/10 opacity-0 peer-checked:opacity-100 pointer-events-none transition-opacity"></div>
            </label>`;
        });

        document.getElementById('checkOrderModal').classList.remove('hidden');
    }

    // Efeito visual ao marcar (opcional, só para garantir feedback)
    function toggleCheckRow(chk) {
        if (navigator.vibrate) navigator.vibrate(10); // Vibrar celular se for touch
        // A lógica visual já é feita pelo CSS 'peer-checked' do Tailwind
    }

    // --- FUNÇÃO DE SEGURANÇA ATUALIZADA ---
    async function confirmCheckItems() {
        const result = await Swal.fire({
            title: 'Conferência',
            text: 'Você já conferiu os itens do pedido?',
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#334155',
            confirmButtonText: 'Sim, está tudo certo',
            cancelButtonText: 'Revisar', // Botão que agora tem ação
            background: '#1e293b',
            color: '#fff',
            reverseButtons: true
        });

        // LÓGICA NOVA: Se clicar em "Revisar" (Cancel), abre o modal de conferência
        if (result.dismiss === Swal.DismissReason.cancel) {
            openCheckOrderModal(); // <--- ABRE A CONFERÊNCIA AUTOMATICAMENTE
            return false; // Retorna falso para bloquear o salvamento/pagamento
        }

        return result.isConfirmed;
    }


    // --- VALIDAÇÃO DE TAXA DE ENTREGA ---
    async function validateDeliveryFee() {
        const isTable = typeof IS_TABLE_MODE !== 'undefined' ? IS_TABLE_MODE : false;
        // Se for Mesa, não cobra taxa de entrega
        if (isTable) return true;

        const deliveryType = document.getElementById('pdvDeliveryType').value;
        const feeVal = parseFloat(document.getElementById('valFee').value) || 0;

        // Regra: Se for Delivery E Taxa <= 0
        if (deliveryType === 'delivery' && feeVal <= 0) {
            const { value: password } = await Swal.fire({
                title: 'Taxa Zerada!',
                text: "Este é um pedido de Delivery sem taxa. Digite a senha de ADMIN para autorizar a cortesia.",
                input: 'password',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                confirmButtonText: 'Autorizar Cortesia',
                cancelButtonText: 'Corrigir',
                background: '#1e293b',
                color: '#fff'
            });

            if (!password) return false; // Usuário cancelou para corrigir

            // Valida Senha no Backend
            const fd = new FormData();
            fd.append('password', password);

            try {
                const res = await fetch('/admin/auth/verify-admin', { method: 'POST', body: fd });
                if (!res.ok) {
                    Swal.fire({ icon: 'error', title: 'Senha Incorreta', text: 'Ação negada.', background: '#1e293b', color: '#fff' });
                    return false;
                }
                return true; // Autorizado
            } catch (e) {
                console.error(e);
                return false;
            }
        }

        return true; // Não é delivery ou tem taxa, segue o jogo
    }


    // --- FUNÇÃO MODO TV (FULL SCREEN) ---
    function toggleFullScreen() {
        const nav = document.querySelector('nav');
        const footer = document.querySelector('footer');
        const main = document.querySelector('main');

        if (!document.fullscreenElement) {
            // ENTRAR NO MODO CHEIO
            document.documentElement.requestFullscreen().catch(e => console.log(e));

            // Esconde Menu e Rodapé
            if (nav) nav.classList.add('hidden');
            if (footer) footer.classList.add('hidden');

            // Remove a trava de largura (max-w-1600px) para usar o monitor todo
            if (main) {
                main.classList.remove('max-w-[1600px]', 'p-4', 'md:p-6');
                main.classList.add('w-full', 'max-w-full', 'p-2'); // Menos padding para aproveitar espaço
            }

        } else {
            // SAIR DO MODO CHEIO
            if (document.exitFullscreen) document.exitFullscreen();
            restoreUI();
        }
    }

    // Restaura a interface se o usuário apertar ESC
    document.addEventListener('fullscreenchange', (event) => {
        if (!document.fullscreenElement) {
            restoreUI();
        }
    });

    function restoreUI() {
        const nav = document.querySelector('nav');
        const footer = document.querySelector('footer');
        const main = document.querySelector('main');

        if (nav) nav.classList.remove('hidden');
        if (footer) footer.classList.remove('hidden');

        if (main) {
            main.classList.add('max-w-[1600px]', 'p-4', 'md:p-6');
            main.classList.remove('w-full', 'max-w-full', 'p-2');
        }
    }


    // 2. Lógica do Modal de Combo
    function openComboPDV(product) {
        const config = product.config || {};

        // 1. Tenta carregar os grupos da estrutura nova
        let groupsData = config.flexible_rules || [];

        // Fallback de segurança: Se estiver vazio, tenta converter o formato antigo
        // (Isso previne o modal vazio se o produto foi salvo na versão anterior)
        if (groupsData.length === 0 && config.flexible_groups) {
            groupsData = config.flexible_groups;
        }

        // Se ainda estiver vazio, cria um grupo padrão temporário para não travar
        if (groupsData.length === 0) {
            groupsData = [{
                id: 1,
                name: "Escolha os Itens",
                limit: parseInt(config.total_limit) || 1,
                items: [] // Vai ficar vazio, mas o modal abre
            }];
        }

        // Prepara estrutura de estado (contadores zerados)
        CURRENT_COMBO_PDV = {
            product: product,
            groups: groupsData.map(g => ({
                id: g.id,
                name: g.name,
                limit: parseInt(g.limit) || 1,
                // Mapeia os itens permitidos e inicia qtd 0
                items: (g.items || []).map(i => ({
                    id: i.prod_id || i.id, // Suporta ambos os formatos de ID
                    name: i.name,
                    qty: 0
                }))
            }))
        };

        document.getElementById('cpTitle').innerText = product.name;

        // --- EXIBIR DESCRIÇÃO NO MODAL ---
        const descEl = document.getElementById('cpDesc');
        if (product.description) {
            // Quebra de linha segura
            descEl.innerHTML = product.description.replace(/\n/g, '<br>');
            descEl.classList.remove('hidden');
        } else {
            descEl.classList.add('hidden');
        }
        // ---------------------------------

        // Renderiza
        renderComboGroups();
        validateComboGlobal();

        document.getElementById('comboPDVModal').classList.remove('hidden');
    }

    function renderComboOptions(rules) {
        const list = document.getElementById('cpOptionsList');
        list.innerHTML = '';

        rules.forEach(rule => {
            // Busca o produto real para pegar preço/nome atualizados se necessário
            // Mas a regra já tem o nome salvo

            list.innerHTML += `
            <div class="flex justify-between items-center bg-slate-800/50 p-3 rounded-xl border border-slate-700 hover:border-indigo-500/50 transition group select-none">
                <div class="flex-1">
                    <div class="font-bold text-white text-sm">${rule.name}</div>
                    <div class="text-[10px] text-slate-500 flex gap-2">
                        <span>Mín: ${rule.min_qty}</span>
                        <span>Máx: ${rule.max_qty}</span>
                    </div>
                </div>
                
                <div class="flex items-center bg-slate-900 rounded-lg border border-slate-600">
                    <button onclick="updateComboQty(${rule.product_id}, -1, ${rule.min_qty}, ${rule.max_qty}, '${rule.name}')" 
                        class="w-10 h-10 text-slate-400 hover:text-white hover:bg-slate-800 rounded-l-lg transition font-bold text-lg">-</button>
                    
                    <input type="text" readonly id="qty-rule-${rule.product_id}" value="0" 
                        class="w-12 text-center bg-transparent text-white font-bold text-lg border-x border-slate-700 h-10">
                    
                    <button onclick="updateComboQty(${rule.product_id}, 1, ${rule.min_qty}, ${rule.max_qty}, '${rule.name}')" 
                        class="w-10 h-10 text-green-400 hover:text-white hover:bg-green-600 rounded-r-lg transition font-bold text-lg">+</button>
                </div>
            </div>`;
        });
    }

    function updateComboQty(prodId, change, min, max, name) {
        // Encontra ou cria a seleção
        let item = CURRENT_COMBO_PDV.selections.find(i => i.id == prodId);
        if (!item) {
            item = { id: prodId, name: name, qty: 0 };
            CURRENT_COMBO_PDV.selections.push(item);
        }

        const currentTotal = CURRENT_COMBO_PDV.selections.reduce((s, i) => s + i.qty, 0);
        const newQty = item.qty + change;

        // Validações
        if (newQty < 0) return; // Não pode negativo
        if (newQty > max) return; // Não pode passar do máximo individual
        if (change > 0 && currentTotal >= CURRENT_COMBO_PDV.limit) {
            // Treme a tela ou avisa que deu o limite total
            if (navigator.vibrate) navigator.vibrate(50);
            return;
        }

        item.qty = newQty;

        // Atualiza Visual
        document.getElementById(`qty-rule-${prodId}`).value = newQty;

        // Se zerou, remove do array (opcional, mas limpa a memória)
        if (newQty === 0) {
            CURRENT_COMBO_PDV.selections = CURRENT_COMBO_PDV.selections.filter(i => i.id != prodId);
        }

        updateComboProgress();
    }

    function renderComboGroups() {
        const container = document.getElementById('cpGroupsContainer');
        container.innerHTML = '';

        if (CURRENT_COMBO_PDV.groups.length === 0 || CURRENT_COMBO_PDV.groups[0].items.length === 0) {
            container.innerHTML = `
                <div class="text-center py-10 text-slate-500">
                    <i class="fas fa-exclamation-circle text-4xl mb-2"></i>
                    <p>Este combo não tem itens configurados.</p>
                    <p class="text-xs">Edite o produto no cardápio para adicionar grupos.</p>
                </div>`;
            return;
        }

        CURRENT_COMBO_PDV.groups.forEach((group, gIdx) => {
            // Calcula total atual do grupo
            const currentTotal = group.items.reduce((s, i) => s + i.qty, 0);
            const isComplete = currentTotal === group.limit;

            // Estilo dinâmico
            const headerColor = isComplete ? 'text-green-400' : 'text-white';
            const borderClass = isComplete ? 'border-green-500/50' : 'border-slate-700';
            const bgHeader = isComplete ? 'bg-green-900/20' : 'bg-black/20';

            let itemsHtml = '';
            group.items.forEach((item, iIdx) => {
                // Botões desabilitados se atingiu o limite (exceto o de diminuir)
                const isMaxed = currentTotal >= group.limit;
                const plusDisabled = isMaxed ? 'opacity-50 cursor-not-allowed' : 'hover:bg-green-600 active:bg-green-700';
                const minusDisabled = item.qty <= 0 ? 'opacity-50 cursor-not-allowed' : 'hover:bg-slate-700 active:bg-slate-600';

                itemsHtml += `
                <div class="flex justify-between items-center bg-slate-900/50 p-3 rounded-lg border border-slate-700/50 mb-2 select-none">
                    <span class="text-sm text-slate-300 font-medium">${item.name}</span>
                    
                    <div class="flex items-center bg-slate-800 rounded-lg border border-slate-600 overflow-hidden">
                        <button onclick="changeComboItemQty(${gIdx}, ${iIdx}, -1)" class="w-10 h-10 text-slate-400 font-bold text-xl transition ${minusDisabled}">-</button>
                        <div class="w-10 text-center text-white font-bold text-lg border-x border-slate-700 h-10 flex items-center justify-center bg-slate-900">${item.qty}</div>
                        <button onclick="changeComboItemQty(${gIdx}, ${iIdx}, 1)" class="w-10 h-10 text-green-500 font-bold text-xl transition ${plusDisabled}">+</button>
                    </div>
                </div>`;
            });

            container.innerHTML += `
            <div class="bg-slate-800 rounded-xl border ${borderClass} overflow-hidden transition-all shadow-md mb-4">
                <div class="p-4 border-b border-slate-700/50 flex justify-between items-center ${bgHeader}">
                    <div>
                        <h4 class="font-bold ${headerColor} uppercase text-sm tracking-wider flex items-center gap-2">
                            ${isComplete ? '<i class="fas fa-check-circle"></i>' : '<i class="far fa-circle"></i>'}
                            ${group.name}
                        </h4>
                        <p class="text-[10px] text-slate-500">Escolha ${group.limit} itens</p>
                    </div>
                    <span class="text-sm font-bold bg-slate-900 px-3 py-1 rounded border border-slate-700 ${headerColor}">
                        ${currentTotal} / ${group.limit}
                    </span>
                </div>
                <div class="p-4">
                    ${itemsHtml}
                </div>
            </div>`;
        });
    }

    function changeComboItemQty(gIdx, iIdx, delta) {
        const group = CURRENT_COMBO_PDV.groups[gIdx];
        const item = group.items[iIdx];
        const currentTotal = group.items.reduce((s, i) => s + i.qty, 0);

        // Regras
        if (delta < 0 && item.qty <= 0) return; // Não pode negativo
        if (delta > 0 && currentTotal >= group.limit) return; // Não pode estourar limite do grupo

        item.qty += delta;

        renderComboGroups(); // Re-renderiza para atualizar cores e contadores
        validateComboGlobal();
    }

    function updateComboProgress() {
        const total = CURRENT_COMBO_PDV.selections.reduce((s, i) => s + i.qty, 0);
        const limit = CURRENT_COMBO_PDV.limit;
        const btn = document.getElementById('btnConfirmCombo');
        const counter = document.getElementById('cpCurrentCount');

        counter.innerText = total;

        // Validação Final: Precisa atingir exatamente o limite? 
        // Geralmente sim para combos de "Escolha 10". 
        // Se quiser flexível (ex: "Até 10"), mude para total > 0
        if (total === limit) {
            btn.disabled = false;
            btn.classList.remove('opacity-50', 'cursor-not-allowed');
            counter.classList.replace('text-white', 'text-green-400');
        } else {
            btn.disabled = true;
            btn.classList.add('opacity-50', 'cursor-not-allowed');
            counter.classList.replace('text-green-400', 'text-white');
        }
    }

    function validateComboGlobal() {
        // Verifica se TODOS os grupos estão completos
        const allComplete = CURRENT_COMBO_PDV.groups.every(g => {
            const total = g.items.reduce((s, i) => s + i.qty, 0);
            return total === g.limit;
        });

        const btn = document.getElementById('btnConfirmCombo');
        const status = document.getElementById('cpGlobalStatus');

        if (allComplete) {
            btn.disabled = false;
            btn.classList.remove('opacity-50', 'cursor-not-allowed');
            status.innerText = "Tudo pronto!";
            status.className = "text-sm font-bold text-green-400";
        } else {
            btn.disabled = true;
            btn.classList.add('opacity-50', 'cursor-not-allowed');
            status.innerText = "Complete todos os grupos...";
            status.className = "text-sm font-bold text-yellow-500 animate-pulse";
        }
    }

    // --- FUNÇÃO CORRIGIDA (Versão Final: Fixos + Escolhas) ---
    function confirmComboPDV() {
        // 1. Prepara a lista visual (KDS/Carrinho)
        let generatedDetails = [];
        
        // --- PARTE A: ITENS FIXOS (Vindo do Backend) ---
        // Recupera a lista salva no cadastro do produto
        const fixedItems = CURRENT_COMBO_PDV.product.combo_items || [];
        
        fixedItems.forEach(fix => {
            // Busca o nome do produto no catálogo para ficar bonito (ex: "Coca 2L" em vez de ID 50)
            // '==' permite comparar string com numero ("50" == 50)
            const childProd = PDV_DATA.products.find(p => p.id == fix.product_id);
            const childName = childProd ? childProd.name : "Item Fixo";
            const qty = fix.qty || 1;
            
            generatedDetails.push({
                type: 'info', // 'info' aparece em cinza no carrinho
                text: `• ${qty}x ${childName}`, 
                code: fix.product_id
            });
        });

        // --- PARTE B: ITENS FLEXÍVEIS (Escolhas do Cliente no Modal) ---
        CURRENT_COMBO_PDV.groups.forEach(g => {
            g.items.forEach(i => {
                if (i.qty > 0) {
                    generatedDetails.push({
                        type: 'info',
                        text: `• ${i.qty}x ${i.name}`,
                        code: i.id
                    });
                }
            });
        });

        // 2. Define o Título
        const title = CURRENT_COMBO_PDV.product.name;

        // 3. Empurra para o Carrinho
        CART.push({
            type: 'combo',
            id: CURRENT_COMBO_PDV.product.id,
            product_id: CURRENT_COMBO_PDV.product.id,
            title: title,
            price: parseFloat(CURRENT_COMBO_PDV.product.price),
            quantity: 1,
            
            // O segredo: 'details' é o que o carrinho e o KDS leem para mostrar a lista
            details: generatedDetails, 
            
            // Dados técnicos para salvar no banco
            combo_data: CURRENT_COMBO_PDV.groups,
            
            kds_stage: 0,
            kds_done: false
        });

        updateCartUI();
        document.getElementById('comboPDVModal').classList.add('hidden');
        
        // Aviso de Sucesso
        const Toast = Swal.mixin({ toast: true, position: 'bottom', showConfirmButton: false, timer: 1000, background: '#10b981', color: '#fff' });
        Toast.fire({ icon: 'success', title: 'Combo Adicionado!' });
    }


    function togglePlatformFilter(plat) {
        // Se clicar no mesmo, desativa (toggle off)
        if (CURRENT_PLATFORM_FILTER === plat) {
            CURRENT_PLATFORM_FILTER = null;
        } else {
            CURRENT_PLATFORM_FILTER = plat;
        }

        // Atualiza Visual dos Botões
        ['ifood', 'wabiz', 'pdv'].forEach(p => {
            const btn = document.getElementById(`filter-btn-${p}`);
            if (p === CURRENT_PLATFORM_FILTER) {
                btn.classList.add('ring-2', 'ring-indigo-500', 'bg-slate-800');
                btn.classList.remove('bg-slate-900/50');
            } else {
                btn.classList.remove('ring-2', 'ring-indigo-500', 'bg-slate-800');
                btn.classList.add('bg-slate-900/50');
            }
        });

        fetchOrders(); // Recarrega a lista
    }

    function toggleDriverFilter(val) {
        CURRENT_DRIVER_FILTER = val;
        fetchOrders(); // Recarrega o Kanban
    }

    // --- AÇÕES EM MASSA (NOVAS FUNÇÕES) ---

    // 1. FUNÇÃO DE SELEÇÃO (Com correção de cor e campo)
    async function openBulkAdvance() {
        const checked = document.querySelectorAll('.order-checkbox:checked');
        if (checked.length === 0) return;
        const ids = Array.from(checked).map(c => c.value).join(',');

        const { value: status } = await Swal.fire({
            title: `Mover ${checked.length} Pedidos`,
            input: 'select',
            inputOptions: {
                'PREPARO': '👨‍🍳 Em Preparo',
                'PRONTO': '✅ Pronto / Aguardando',
                'SAIU_ENTREGA': '🛵 Saiu para Entrega',
                'ENTREGUE': '🏁 Entregue / Concluído'
            },
            inputPlaceholder: 'Selecione o novo status...',
            showCancelButton: true,
            confirmButtonText: 'Mover',
            confirmButtonColor: '#f59e0b',
            background: '#1e293b',
            color: '#fff',
            // [CORREÇÃO VISUAL] Isso conserta o fundo branco do select
            customClass: {
                input: 'bg-slate-800 text-white border border-slate-600 focus:ring-indigo-500 rounded-lg',
                popup: 'border border-slate-700 shadow-2xl'
            }
        });

        if (status) {
            executeBulkStatus(ids, status);
        }
    }

    // 2. FINALIZAR (Atalho Rápido para ENTREGUE)
    async function openBulkFinalize() {
        const checked = document.querySelectorAll('.order-checkbox:checked');
        if (checked.length === 0) return;
        const ids = Array.from(checked).map(c => c.value).join(',');

        const result = await Swal.fire({
            title: 'Finalizar Tudo?',
            text: `Marcar ${checked.length} pedidos como ENTREGUE?`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'Sim, Finalizar',
            confirmButtonColor: '#16a34a', // Verde
            cancelButtonColor: '#334155',
            background: '#1e293b', color: '#fff'
        });

        if (result.isConfirmed) {
            executeBulkStatus(ids, 'ENTREGUE');
        }
    }

    // 2. FUNÇÃO DE ENVIO (Com correção do nome do campo)
    async function executeBulkStatus(ids, status) {
        const fd = new FormData();
        fd.append('order_ids', ids);

        // [CORREÇÃO CRÍTICA] O nome aqui DEVE ser 'new_status' igual ao Python
        fd.append('new_status', status);

        try {
            const res = await fetch('/admin/orders/bulk/status', { method: 'POST', body: fd });

            if (res.ok) {
                const data = await res.json();
                Swal.fire({
                    toast: true, icon: 'success', title: data.message,
                    position: 'top-end', timer: 2000, showConfirmButton: false,
                    background: '#1e293b', color: '#fff'
                });
                clearBulkSelection();
                fetchOrders();
            } else {
                try {
                    const err = await res.json();
                    // Se o erro for de validação, mostra detalhes
                    const msg = err.detail ? JSON.stringify(err.detail) : (err.message || 'Erro');
                    Swal.fire('Erro', msg, 'error');
                } catch (e) {
                    Swal.fire('Erro', `Status HTTP: ${res.status}`, 'error');
                }
            }
        } catch (e) {
            console.error(e);
            Swal.fire('Erro', 'Falha na conexão', 'error');
        }
    }

    // 3. CANCELAR EM MASSA (Com Senha de Admin)
    async function openBulkCancel() {
        const checked = document.querySelectorAll('.order-checkbox:checked');
        if (checked.length === 0) return;
        const ids = Array.from(checked).map(c => c.value).join(',');

        // 1. Pede Motivo
        const { value: reason } = await Swal.fire({
            title: `Cancelar ${checked.length} Pedidos?`,
            text: "Isso irá estornar o estoque de todos os itens.",
            input: 'text',
            inputPlaceholder: 'Motivo (ex: Erro do sistema, Cancelado pelo iFood...)',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#ef4444',
            confirmButtonText: 'Continuar',
            background: '#1e293b', color: '#fff',
            inputValidator: (value) => { if (!value) return 'Digite um motivo!' }
        });

        if (!reason) return;

        // 2. Pede Senha (Segurança)
        const { value: password } = await Swal.fire({
            title: '<i class="fas fa-lock"></i> Senha de Admin',
            text: 'Confirme para cancelar em massa:',
            input: 'password',
            icon: 'warning', // Ícone padrão válido
            showCancelButton: true,
            confirmButtonColor: '#ef4444',
            background: '#1e293b', color: '#fff'
        });

        if (!password) return;

        // 3. Valida Senha
        const fdAuth = new FormData(); fdAuth.append('password', password);
        const resAuth = await fetch('/admin/auth/verify-admin', { method: 'POST', body: fdAuth });

        if (!resAuth.ok) {
            return Swal.fire({ icon: 'error', title: 'Negado', text: 'Senha incorreta.', background: '#1e293b', color: '#fff' });
        }

        // 4. Executa Cancelamento
        const fd = new FormData();
        fd.append('order_ids', ids);
        fd.append('reason', reason);

        try {
            Swal.fire({ title: 'Processando...', didOpen: () => Swal.showLoading(), background: '#1e293b', color: '#fff' });

            const res = await fetch('/admin/orders/bulk/cancel', { method: 'POST', body: fd });
            const data = await res.json();

            if (res.ok) {
                Swal.fire({ icon: 'success', title: 'Cancelados!', text: data.message, background: '#1e293b', color: '#fff' });
                clearBulkSelection();
                fetchOrders();
            } else {
                Swal.fire('Erro', data.message, 'error');
            }
        } catch (e) {
            Swal.fire('Erro', 'Falha na conexão', 'error');
        }
    }


    // 4. RETROCEDER (Voltar Status)
    async function openBulkRevert() {
        const checked = document.querySelectorAll('.order-checkbox:checked');
        if (checked.length === 0) return;
        const ids = Array.from(checked).map(c => c.value).join(',');

        // Não precisa de confirmação complexa, é uma ação de correção rápida
        const fd = new FormData();
        fd.append('order_ids', ids);

        try {
            const res = await fetch('/admin/orders/bulk/revert', { method: 'POST', body: fd });
            const data = await res.json();

            if (res.ok) {
                Swal.fire({ toast: true, icon: 'info', title: 'Retrocedido', text: data.message, position: 'bottom', timer: 2000, showConfirmButton: false, background: '#1e293b', color: '#fff' });
                clearBulkSelection();
                fetchOrders();
            } else {
                Swal.fire('Erro', data.message, 'error');
            }
        } catch (e) { console.error(e); }
    }

    // 5. ARQUIVAR DEFINITIVAMENTE (CONCLUIDO)
    async function openBulkArchive() {
        const checked = document.querySelectorAll('.order-checkbox:checked');
        if (checked.length === 0) return;
        const ids = Array.from(checked).map(c => c.value).join(',');

        const result = await Swal.fire({
            title: `Arquivar ${checked.length} Pedidos?`,
            text: "Eles sairão do quadro e ficarão como 'CONCLUIDO' no histórico. Confirma?",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Sim, Arquivar',
            confirmButtonColor: '#10b981', // Emerald
            cancelButtonColor: '#334155',
            background: '#1e293b', color: '#fff'
        });

        if (result.isConfirmed) {
            // Reusa a função de status padrão, enviando 'CONCLUIDO'
            executeBulkStatus(ids, 'CONCLUIDO');
        }
    }

    // --- SISTEMA DE SOM E IMPRESSÃO ---

    // Carrega o som (certifique-se de ter o arquivo em static/sounds/alert.mp3)
    const alertSound = new Audio('/static/sounds/alert.mp3');

    function playAlert() {
        // Navegadores bloqueiam som automático se o usuário não interagiu com a página.
        // O catch evita erro no console se estiver bloqueado.
        alertSound.play().catch(e => console.log("Som bloqueado pelo navegador (clique na página p/ ativar):", e));
    }

    // --- SISTEMA DE IMPRESSÃO HÍBRIDO ---
    // 1. Tenta mandar para o Agente Local (Com Logs de Diagnóstico)
    async function printOrder(orderId) {
        console.log(`🖨️ Iniciando impressão do pedido ${orderId}...`);

        try {
            // 1. Busca o Texto
            const resData = await fetch(`/admin/api/print-text/${orderId}`);
            if (!resData.ok) throw new Error("Erro ao gerar texto do cupom");
            const textContent = await resData.json();
            
            console.log("📄 Texto gerado com sucesso. Tentando conectar ao agente...");

            // 2. Envia para o Agente
            const payload = {
                printer_name: "Padrao", // Certifique-se que o nome bate com o Windows
                content: textContent.text
            };
            

            const resAgent = await fetch("http://127.0.0.1:5000/print", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });

            if (resAgent.ok) {
                console.log("✅ Agente respondeu OK!");
                const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 2000, background: '#1e293b', color: '#fff' });
                Toast.fire({ icon: 'success', title: 'Enviado para Impressora!' });
                return; 
            } else {
                console.error("❌ Agente respondeu com erro:", resAgent.status);
            }

        } catch (e) {
            console.warn("⚠️ Falha ao conectar com Agente Local:", e);
            console.log("ℹ️ Motivo provável: Agente fechado ou Bloqueio de HTTPS (Mixed Content).");
        }

        // 3. Fallback: Popup
        console.log("🌐 Abrindo modo Web (Popup)...");
        const url = `/admin/print/order/${orderId}`;
        const win = window.open(url, '_blank', 'width=400,height=600');
    }



    async function checkCashBox() {
        try {
            const res = await fetch('/admin/api/finance/daily-summary');
            const data = await res.json();
            const alertBox = document.getElementById('boxClosedAlert');

            if (data.is_box_open === false) {
                alertBox.classList.remove('hidden');
            } else {
                alertBox.classList.add('hidden');
            }
        } catch (e) { }
    }

    // Chama ao carregar e a cada 60s
    checkCashBox();
    setInterval(checkCashBox, 300000);

    function testSoundSystem() {
        // 1. Toca o som direto (Teste de Arquivo)
        playAlert();

        // 2. Feedback Visual
        const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 3000, background: '#1e293b', color: '#fff' });
        Toast.fire({ icon: 'info', title: 'Tocando som de teste...' });

        console.log("🔊 Teste de som iniciado pelo usuário.");
    }

    // --- NOVA FUNÇÃO AUXILIAR: Gerencia as cores do card ---
    function applyCardColor(div, status, cssClass) {
        // 1. Remove todas as cores possíveis (Limpeza)
        div.classList.remove(
            'border-slate-500', 'border-red-500', 'border-blue-500',
            'border-orange-500', 'border-green-500', 'border-slate-600',
            'border-red-600', 'animate-pulse-slow', // Remove efeitos de forno antigos
            'opacity-60', 'shadow-orange-500/20'
        );
        div.style.boxShadow = "none";

        // 2. PRIORIDADE: Verifica se é FORNO (pela classe css ou status)
        if (cssClass === 'card-oven' || status === 'FORNO' || status === 'EXPEDICAO') {
            div.classList.add('border-red-600', 'animate-pulse-slow');
            // Opcional: Adicionar fundo avermelhado
            // div.classList.add('bg-red-950/20'); 
            return; // Sai da função, pois forno tem prioridade visual
        }

        // 3. Cores normais
        if (status === 'PENDING') {
            div.classList.add('border-red-500');
        }
        else if (status === 'PREPARO') {
            div.classList.add('border-blue-500');
        }
        else if (status === 'PRONTO') {
            div.classList.add('border-orange-500');
            div.style.boxShadow = "0 0 10px rgba(249,115,22,0.3)";
        }
        else if (status === 'SAIU_ENTREGA' || status === 'DELIVERY') {
            div.classList.add('border-green-500');
        }
        else {
            div.classList.add('border-slate-500'); // Padrão (Entregue/Concluído)
        }
    }


    // --- FUNÇÕES DE LANÇAMENTO EQUIPE (NOVO) ---

    async function openEmployeeActionModal() {
        // Limpa campos
        document.getElementById('empValue').value = '';
        document.getElementById('empDesc').value = '';

        // Carrega Lista de Funcionários da Rota Certa
        try {
            const res = await fetch('/admin/api/finance/team/balances');
            if (!res.ok) throw new Error("Erro API");
            const employees = await res.json();

            const sel = $('#empSelect'); // Usa jQuery se tiver Select2, senão usa vanilla abaixo

            // Verifica se Select2 está ativo no elemento
            if (sel.hasClass("select2-hidden-accessible")) {
                sel.empty();
                sel.append('<option value="">Selecione...</option>');
                employees.forEach(e => {
                    let role = e.role === 'driver' ? ' (Motoboy)' : '';
                    sel.append(`<option value="${e.id}">${e.name}${role}</option>`);
                });
                sel.trigger('change'); // Atualiza Select2
            } else {
                // Fallback JS Puro
                const rawSel = document.getElementById('empSelect');
                rawSel.innerHTML = '<option value="">Selecione...</option>';
                employees.forEach(e => {
                    let role = e.role === 'driver' ? ' (Motoboy)' : '';
                    rawSel.innerHTML += `<option value="${e.id}">${e.name}${role}</option>`;
                });
            }

            document.getElementById('employeeActionModal').classList.remove('hidden');

        } catch (e) {
            console.error(e);
            Swal.fire('Erro', 'Não foi possível carregar a equipe.', 'error');
        }
    }

    async function submitEmployeeAction() {
        // 1. Coleta Dados
        // Tenta pegar do Select2 ou do nativo
        let userId = $('#empSelect').val();
        if (!userId) userId = document.getElementById('empSelect').value;

        const type = document.querySelector('input[name="empActionType"]:checked').value; // 'vale' ou 'bonus'
        const amount = document.getElementById('empValue').value;
        const description = document.getElementById('empDesc').value;
        const method = document.getElementById('empMethod').value;

        // 2. Validação Básica
        if (!userId || !amount || parseFloat(amount) <= 0) {
            return Swal.fire('Atenção', 'Selecione o funcionário e um valor válido.', 'warning');
        }
        if (!description) {
            return Swal.fire('Atenção', 'Digite o motivo (Ex: Gasolina, Adiantamento).', 'warning');
        }

        // 3. Validação de Segurança (Senha de Gerente)
        const { value: password } = await Swal.fire({
            title: 'Autorização',
            text: `Confirmar ${type.toUpperCase()} de R$ ${amount}?`,
            input: 'password',
            inputPlaceholder: 'Senha do Gerente',
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'Confirmar',
            confirmButtonColor: type === 'vale' ? '#ef4444' : '#10b981',
            background: '#1e293b', color: '#fff'
        });

        if (!password) return; // Cancelado

        // 4. Envio para o Backend
        const fd = new FormData();
        fd.append('employee_id', userId);
        fd.append('type', type);
        fd.append('amount', amount);
        fd.append('description', description);
        fd.append('payment_method', method);

        // Se precisar enviar a senha para validar no backend, adicione aqui. 
        // Mas a rota atual valida o usuário logado. Se o usuário logado no PDV não for gerente,
        // precisaria de uma rota que aceitasse 'admin_password' (como fizemos no pagamento de pedido).
        // Por enquanto, assumimos que quem acessa essa tela tem permissão ou o backend vai bloquear (403).

        // Se quiser usar a senha digitada para validar (igual ao pagamento de pedido),
        // teríamos que atualizar a rota 'create_manual_transaction' para aceitar senha.
        // Como não atualizamos ela, vamos confiar no cookie de sessão ou implementar depois.

        try {
            Swal.fire({ title: 'Salvando...', didOpen: () => Swal.showLoading(), background: '#1e293b', color: '#fff' });

            const res = await fetch('/admin/api/finance/transaction/manual', {
                method: 'POST',
                body: fd
            });

            const data = await res.json();

            if (res.ok) {
                Swal.fire({
                    icon: 'success',
                    title: 'Sucesso!',
                    text: `Novo saldo: R$ ${data.new_balance.toFixed(2)}`,
                    timer: 2000, showConfirmButton: false,
                    background: '#1e293b', color: '#fff'
                });
                document.getElementById('employeeActionModal').classList.add('hidden');

                // Se estiver usando o painel financeiro na mesma tela, atualize aqui
            } else {
                Swal.fire('Erro', data.message || 'Falha ao lançar.', 'error');
            }
        } catch (e) {
            console.error(e);
            Swal.fire('Erro', 'Conexão falhou.', 'error');
        }
    }


    // Helper de Normalização
    function normalizeStr(str) {
        return (str || '').normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
    }

    // --- VERSÃO COM BLOQUEIO DE ALCOOL/CIGARRO ---
    async function payWithEmployeeAccount() {
        // 1. Definição dos Itens Bloqueados (Adicione palavras chave aqui)
        const RESTRICTED_KEYWORDS = ['CERVEJA', 'CIGARRO', 'WHISKY', 'VODKA', 'GIN', 'CAIPIRINHA', 'DOSE', 'COCA', 'REFRIGERANTE', 'AGUA'];
        // (Ajuste a lista acima conforme sua necessidade. Se quiser liberar refri, remova 'COCA', etc.)

        let orderId = document.getElementById('pdvOrderId').value;

        // Tenta pegar totais
        let totalRaw = document.getElementById('lblTotal')?.dataset.val
            || document.getElementById('chkFinalTotal')?.dataset.val
            || 0;
        let orderTotal = parseFloat(totalRaw);

        // --- ANÁLISE DO CARRINHO (Separar o Joio do Trigo) ---
        // Se estivermos no PDV (CART existe), usamos ele. Se for modal de visualização, teríamos que buscar itens.
        // Assumindo uso no PDV ativo onde CART está preenchido:

        let discountableTotal = 0;
        let blockedTotal = 0;
        let blockedItemsNames = [];

        if (typeof CART !== 'undefined' && CART.length > 0) {
            CART.forEach(item => {
                const title = (item.title || item.name).toUpperCase();
                const itemTotal = item.price * item.quantity;

                // Verifica se contém alguma palavra proibida
                const isRestricted = RESTRICTED_KEYWORDS.some(word => title.includes(word));

                if (isRestricted) {
                    blockedTotal += itemTotal;
                    blockedItemsNames.push(item.title); // Guarda nome para exibir (opcional)
                } else {
                    discountableTotal += itemTotal;
                }
            });
        } else {
            // Fallback se CART estiver vazio (ex: edição via modal sem carregar CART), 
            // assume tudo descontável ou avisa erro.
            discountableTotal = orderTotal;
        }

        // Ajuste fino para bater com o total (caso haja taxas/serviços não inclusos no loop do CART)
        // Se tiver taxa de entrega, geralmente não damos desconto nela também.
        // Vamos assumir: discountableTotal é a soma dos produtos permitidos.
        // O restante (Taxas + Produtos Bloqueados) vai para blockedTotal.
        if (discountableTotal > orderTotal) discountableTotal = orderTotal; // Segurança
        blockedTotal = orderTotal - discountableTotal;


        if (!orderId || orderId === "") {
            if (typeof CURRENT_MODAL_ORDER_ID !== 'undefined') orderId = CURRENT_MODAL_ORDER_ID;
            else return Swal.fire('Atenção', 'Salve o pedido primeiro.', 'warning');
        }

        // 2. Carrega Funcionários
        let employees = [];
        try {
            const res = await fetch('/admin/api/finance/team/balances');
            if (res.ok) employees = await res.json();
        } catch (e) { return Swal.fire('Erro', 'Erro ao buscar equipe.', 'error'); }

        employees.sort((a, b) => a.name.localeCompare(b.name));
        let options = employees.map(e => {
            let role = e.role === 'driver' ? ' (Motoboy)' : '';
            return `<option value="${e.id}" data-role="${e.role}">${e.name}${role}</option>`;
        }).join('');

        // HTML do Alerta de Bloqueio
        let alertHtml = '';
        if (blockedTotal > 0) {
            alertHtml = `
        <div class="bg-yellow-900/30 border-l-4 border-yellow-500 p-2 mb-2 rounded-r text-left">
            <p class="text-[10px] font-bold text-yellow-500 uppercase flex items-center gap-1">
                <i class="fas fa-ban"></i> Itens sem Desconto detectados
            </p>
            <p class="text-xs text-yellow-100">
                Produtos restritos (Bebidas/Cigarro) somam <b>R$ ${blockedTotal.toFixed(2)}</b>.
                O desconto será aplicado apenas sobre <b>R$ ${discountableTotal.toFixed(2)}</b>.
            </p>
        </div>`;
        }

        // 3. Modal Inteligente
        const { value: formValues } = await Swal.fire({
            title: 'Pagamento Funcionário',
            html: `
            <div class="text-left space-y-4">
                ${alertHtml}
                
                <div class="bg-slate-800 p-3 rounded border border-slate-600">
                    <div class="flex justify-between text-slate-400 text-xs uppercase mb-1">
                        <span>Total Pedido</span>
                        <span>Desconto Real</span>
                    </div>
                    <div class="flex justify-between items-end">
                        <span class="text-white font-bold text-lg">R$ ${orderTotal.toFixed(2)}</span>
                        <span class="text-red-400 font-bold" id="disp-discount">- R$ 0.00</span>
                    </div>
                    <div class="border-t border-slate-600 my-2"></div>
                    <div class="flex justify-between items-center">
                        <span class="text-indigo-300 font-bold">A DEBITAR:</span>
                        <span class="text-2xl font-black text-white" id="disp-final">R$ ${orderTotal.toFixed(2)}</span>
                    </div>
                </div>
                
                <div>
                    <label class="block text-xs uppercase font-bold text-slate-300 mb-1">Colaborador</label>
                    <select id="swal-emp" class="w-full bg-slate-900 border border-slate-600 rounded-lg p-3 text-white outline-none focus:border-indigo-500 cursor-pointer">
                        <option value="">Selecione...</option>
                        ${options}
                    </select>
                </div>

                <div>
                    <label class="block text-xs uppercase font-bold text-slate-300 mb-1">Desconto (%)</label>
                    <div class="relative">
                        <span class="absolute left-3 top-3 text-slate-500 font-bold">%</span>
                        <input id="swal-disc" type="number" class="w-full bg-slate-900 border border-slate-600 rounded-lg p-3 pl-8 text-white font-bold outline-none focus:border-indigo-500" 
                               placeholder="0" value="0" min="0" max="100">
                    </div>
                    <p class="text-[10px] text-slate-500 mt-1">*Aplicado apenas sobre itens permitidos.</p>
                </div>

                <div class="bg-red-900/10 p-3 rounded border border-red-500/20 mt-2">
                    <label class="block text-xs uppercase font-bold text-red-400 mb-1"><i class="fas fa-lock mr-1"></i> Senha Gerente</label>
                    <input id="swal-pass" type="password" class="w-full bg-slate-900 border border-red-500/40 rounded-lg p-3 text-white outline-none focus:border-red-500" placeholder="Autorização">
                </div>
            </div>
        `,
            focusConfirm: false,
            showCancelButton: true,
            confirmButtonText: 'Confirmar Débito',
            background: '#1e293b', color: '#fff',

            didOpen: () => {
                const inputDisc = document.getElementById('swal-disc');
                const dispDisc = document.getElementById('disp-discount');
                const dispFinal = document.getElementById('disp-final');

                inputDisc.addEventListener('input', () => {
                    let percInput = parseFloat(inputDisc.value) || 0;
                    if (percInput > 100) percInput = 100;

                    // LÓGICA DE OURO: Aplica % apenas na parte descontável
                    const realDiscountValue = discountableTotal * (percInput / 100);

                    const finalVal = orderTotal - realDiscountValue;

                    dispDisc.innerText = `- R$ ${realDiscountValue.toFixed(2)}`;
                    dispFinal.innerText = `R$ ${finalVal.toFixed(2)}`;

                    // Guarda o valor calculado no dataset para usar no preConfirm
                    inputDisc.dataset.realDiscount = realDiscountValue;
                });
            },

            preConfirm: () => {
                const emp = document.getElementById('swal-emp').value;
                const pass = document.getElementById('swal-pass').value;
                
                // Pega o valor calculado na tela (que já descontou o que tinha que descontar)
                const dispFinalText = document.getElementById('disp-final').innerText; 
                // Limpa "R$ " e converte para float (Ex: "R$ 18.00" -> 18.00)
                const finalVal = parseFloat(dispFinalText.replace('R$', '').replace(',', '.').trim());

                if (!emp) Swal.showValidationMessage('Selecione o colaborador');
                else if (!pass) Swal.showValidationMessage('Senha obrigatória');

                return {
                    empId: emp,
                    finalVal: finalVal, // <--- Envia o valor R$
                    pass: pass
                }
            }
        });

        // 4. Envio (Mantido)
        if (formValues) {
            Swal.fire({ title: 'Processando...', didOpen: () => Swal.showLoading(), background: '#1e293b', color: '#fff', showConfirmButton: false });

            // --- NOVO: SALVA O PEDIDO ATUAL ANTES DE PAGAR ---
            // Isso garante que os itens novos (cigarro, esfiha) estejam no banco
            // false = não fecha o PDV ainda
            const saved = await saveOrderDraft(true, false); 
            
            if (!saved) {
                Swal.fire('Erro', 'Não foi possível salvar os itens do pedido antes do pagamento.', 'error');
                return;
            }
            // -------------------------------------------------

            const fd = new FormData();
            fd.append('order_id', orderId);
            fd.append('employee_id', formValues.empId);
            fd.append('final_value', formValues.finalVal);
            fd.append('admin_password', formValues.pass);

            try {
                const res = await fetch('/admin/api/finance/pay-order-employee', { method: 'POST', body: fd });
                const data = await res.json();

                if (res.ok) {
                    Swal.fire({ icon: 'success', title: 'Pago!', text: data.message, background: '#1e293b', color: '#fff', timer: 2000, showConfirmButton: false })
                        .then(() => {
                            if (typeof closePDV === 'function') closePDV();
                            if (typeof closePaymentLayer === 'function') closePaymentLayer();
                            if (typeof fetchOrders === 'function') fetchOrders();
                            location.reload();
                        });
                } else {
                    Swal.fire({ icon: 'error', title: 'Negado', text: data.message, background: '#1e293b', color: '#fff' });
                }
            } catch (e) {
                Swal.fire('Erro', 'Falha na conexão.', 'error');
            }
        }
    }


    // --- FUNÇÃO PARA EDITAR PREÇO DO ITEM NO CARRINHO ---
    async function editItemPrice(index) {
        const item = CART[index];
        const currentUnit = parseFloat(item.price);
        const currentTotal = currentUnit * item.quantity;

        const { value: newPrice } = await Swal.fire({
            title: 'Alterar Preço',
            html: `
                <div class="text-left mb-4">
                    <p class="text-xs text-slate-400">Produto: <b class="text-white">${item.title}</b></p>
                    <p class="text-xs text-slate-400">Qtd atual: <b class="text-white">${item.quantity}x</b></p>
                </div>
                <label class="block text-xs font-bold text-indigo-400 uppercase mb-1">Novo Preço Unitário (R$)</label>
                <input id="swal-new-price" type="number" step="0.01" class="swal2-input" placeholder="0.00" value="${currentUnit.toFixed(2)}">
            `,
            focusConfirm: false,
            showCancelButton: true,
            confirmButtonText: 'Atualizar',
            cancelButtonText: 'Cancelar',
            background: '#1e293b', color: '#fff',
            preConfirm: () => {
                const val = document.getElementById('swal-new-price').value;
                if (!val || parseFloat(val) < 0) Swal.showValidationMessage('Digite um valor válido');
                return parseFloat(val);
            }
        });

        if (newPrice !== undefined && newPrice !== null) {
            // Atualiza o preço no carrinho
            CART[index].price = newPrice;

            // Recalcula visual
            updateCartUI();

            // Feedback sutil
            const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 1500, background: '#1e293b', color: '#fff' });
            Toast.fire({ icon: 'success', title: 'Preço atualizado' });
        }
    }


    // --- NOVAS FUNÇÕES DE AÇÃO PADRÃO ---

    // Ação do Botão "SALVAR PAGAMENTO" (Cinza)
    function actionSavePayment() {
        // Salvar Pagamento sempre usa a rota padrão de salvar pedido
        // Isso atualiza os dados no banco (pagamento, itens, cliente) mas NÃO finaliza a mesa
        finishOrderProfessional(false); // false = não forçar finalização
    }

    // Ação do Botão "PAGAR E FINALIZAR" (Verde)
    function actionPayAndFinish() {
        if (IS_TABLE_MODE) {
            // SE FOR MESA: Chama a função especial que libera a mesa (/close-account)
            finishTableSession();
        } else {
            // SE FOR DELIVERY/BALCÃO:
            // Chama a função padrão, mas ela mesma já sabe lidar com finalização 
            // baseada na flag IS_FINALIZE_MODE ou criação de novo pedido.
            finishOrderProfessional(true); 
        }
    }


    // ==========================================
    //   LÓGICA DE PIZZA (COM ADICIONAIS RECOLHÍVEIS)
    // ==========================================

    async function openPizzaModal(product) {

        // --- ADICIONE ESTAS LINHAS NO TOPO ---
        EDITING_CART_INDEX = null; // Reseta modo edição
        
        // Reseta visual do botão para Verde (Padrão)
        const btn = document.querySelector('#pizzaModal button[onclick="confirmPizza()"]');
        if(btn) {
            btn.innerHTML = '<i class="fas fa-check"></i> CONFIRMAR';
            btn.classList.replace('bg-blue-600', 'bg-green-600');
            btn.classList.replace('hover:bg-blue-500', 'hover:bg-green-500');
        }
        // -------------------------------------

        CURRENT_PIZZA = { product: product, size: null, parts: [], parts_ids: [], finalPrice: 0 };
        
        // 1. TÍTULO
        const elTitle = document.getElementById('pizzaModalTitle') || document.querySelector('#pizzaModal h3');
        if (elTitle) elTitle.innerText = product.name;

        // 2. ELEMENTOS DE UI (IDs originais do seu HTML)
        const elTotal = document.getElementById('pizzaTotal');
        const elStepEdges = document.getElementById('stepEdges');
        const elObs = document.getElementById('pizzaObs');

        if (elTotal) elTotal.innerText = 'R$ 0.00';
        if (elStepEdges) elStepEdges.classList.add('hidden');
        if (elObs) elObs.value = '';

        // >>>>> INSERIR ESTE BLOCO AQUI (CORREÇÃO) <<<<<
        document.getElementById('stepFlavors').classList.add('hidden'); // Esconde a etapa de sabores
        document.getElementById('flavorsContainer').innerHTML = '';     // Limpa os sabores anteriores
        CURRENT_FLAVORS_COUNT = 0;                                      // Zera o contador
        // >>>>> FIM DO BLOCO <<<<<
        
        // 3. INGREDIENTES (Ajustado para usar 'pizzaIngsList' que já existe)
        const ingContainer = document.getElementById('pizzaIngsList');
        if (ingContainer) {
            ingContainer.innerHTML = '';
            // Mostra o container pai se estiver oculto (pizzaIngsBox)
            const box = document.getElementById('pizzaIngsBox');
            if (box) box.classList.add('hidden'); // Começa oculto até selecionar tamanho/sabor

            if (product.ingredients) {
                product.ingredients.forEach(ing => {
                    ingContainer.innerHTML += `
                    <label class="flex items-center gap-2 p-2 bg-slate-700 rounded border border-slate-600 cursor-pointer select-none">
                        <input type="checkbox" class="pizza-ing-check w-4 h-4 rounded text-red-500 bg-slate-800 border-slate-500 focus:ring-0" 
                               value="${ing.id}" data-name="${ing.name}" checked>
                        <span class="text-xs text-slate-300">${ing.name}</span>
                    </label>`;
                });
            }
        }

        // 4. TAMANHOS (Já estava correto com 'pizzaSizesBox')
        const sizesContainer = document.getElementById('pizzaSizesBox');
        if (!sizesContainer) {
            console.error("ERRO: 'pizzaSizesBox' não encontrado.");
            return;
        }
        sizesContainer.innerHTML = '';
        
        const sortedSizes = (PDV_DATA.sizes || []).sort((a, b) => a.id - b.id);

        sortedSizes.forEach(size => {
            if (product.size_prices && product.size_prices[size.id]) {
                const price = product.size_prices[size.id];
                // Escapa aspas para o JSON
                const sizeJson = JSON.stringify(size).replace(/'/g, "&#39;").replace(/"/g, "&quot;");

                sizesContainer.innerHTML += `
                <label class="cursor-pointer group">
                    <input type="radio" name="size" value="${size.id}" class="peer sr-only" onchange='selectSize(this.parentElement, ${sizeJson})'>
                    <div class="p-3 bg-slate-700 border-2 border-slate-600 rounded-xl peer-checked:border-green-500 peer-checked:bg-green-900/20 hover:border-slate-500 transition text-center h-full flex flex-col justify-between relative overflow-hidden selected-ring-container">
                        <div class="font-bold text-white text-sm relative z-10">${size.name}</div>
                        <div class="text-[10px] text-slate-400 mb-1 relative z-10">${size.slices} Fatias</div>
                        <div class="text-green-400 font-mono font-bold relative z-10">R$ ${price.toFixed(2)}</div>
                        <div class="absolute inset-0 border-2 border-green-500 rounded-xl opacity-0 peer-checked:opacity-100 transition-opacity pointer-events-none selected-ring"></div>
                    </div>
                </label>`;
            }
        });

        // Limpa cache de opções para forçar recarga
        window.PIZZA_OPTIONS_CACHE = null;

        document.getElementById('pizzaModal').classList.remove('hidden');
    }

    function selectSize(el, sizeObj) {
        document.querySelectorAll('.size-card .selected-ring').forEach(r => {
            r.classList.remove('opacity-100', 'scale-100');
            r.classList.add('opacity-0', 'scale-95');
        });
        el.querySelector('.selected-ring').classList.remove('opacity-0', 'scale-95');
        el.querySelector('.selected-ring').classList.add('opacity-100', 'scale-100');

        CURRENT_PIZZA.size = sizeObj;
        MAX_FLAVORS_ALLOWED = sizeObj.max_flavors || 2;
        CURRENT_FLAVORS_COUNT = 0;

        document.getElementById('stepFlavors').classList.remove('hidden');
        document.getElementById('flavorsContainer').innerHTML = '';

        addFlavorRow(CURRENT_PIZZA.product.id, true);
        
        updateUI();
        renderEdges(sizeObj.id);
        calcPizza();
    }

    // --- FUNÇÃO DE LINHA DE SABOR (COM BOTÃO EXPANDIR) ---
    function addFlavorRow(preselectedId = null, isFirst = false) {
        if (CURRENT_FLAVORS_COUNT >= MAX_FLAVORS_ALLOWED) return;

        CURRENT_FLAVORS_COUNT++;
        const rowId = `flavor-row-${Date.now()}`;
        const container = document.getElementById('flavorsContainer');

        const div = document.createElement('div');
        div.className = "flavor-row bg-slate-900/50 p-2 rounded-xl border border-slate-700 mb-2 animate-fade-in-up";
        div.id = rowId;

        const products = PDV_DATA.products || [];
        const availablePizzas = products.filter(p => p.is_pizza && p.size_prices && p.size_prices[CURRENT_PIZZA.size.id]);

        let options = '<option value="">Selecione o sabor...</option>';
        availablePizzas.forEach(p => {
            const selected = (preselectedId && p.id == preselectedId) ? 'selected' : '';
            const price = p.size_prices[CURRENT_PIZZA.size.id];
            options += `<option value="${p.id}" ${selected}>${p.name} (R$ ${price.toFixed(2)})</option>`;
        });

        // HTML ESTRUTURADO: Select + Botão Seta + Lixeira
        div.innerHTML = `
            <div class="flex flex-col gap-2">
                <div class="flex gap-2 items-center">
                    <div class="flex-1 bg-slate-800 rounded-lg border border-slate-600 relative p-0.5">
                        <select class="flavor-select w-full">
                            ${options}
                        </select>
                    </div>
                    
                    <button type="button" onclick="toggleRowExtras(this)" 
                            class="btn-toggle-extras hidden w-10 h-10 rounded-lg bg-slate-700 text-slate-400 hover:text-white hover:bg-slate-600 border border-slate-600 transition flex items-center justify-center shrink-0" 
                            title="Expandir Adicionais">
                        <i class="fas fa-chevron-down transition-transform duration-200"></i>
                    </button>

                    ${!isFirst ? `
                    <button type="button" onclick="removeFlavorRow('${rowId}')" class="w-10 h-10 rounded-lg bg-red-900/20 text-red-400 hover:bg-red-600 hover:text-white transition flex items-center justify-center border border-red-500/30 shrink-0">
                        <i class="fas fa-trash"></i>
                    </button>` : ''}
                </div>
                
                <div class="flavor-extras-container hidden pl-2 border-l-2 border-indigo-500/30 space-y-2 pb-2">
                    <div class="text-[10px] font-bold text-indigo-400 uppercase">Adicionais para este sabor:</div>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-2 flavor-extras-list"></div>
                </div>
            </div>
        `;

        container.appendChild(div);

        renderRowExtrasHTML(div.querySelector('.flavor-extras-list'));

        const $select = $(div).find('.flavor-select');
        $select.select2({
            dropdownParent: $('#pizzaModal'),
            width: '100%',
            language: { noResults: () => "Não encontrado" },
            templateResult: formatState
        });

        $select.on('select2:select change', function (e) {
            onRowChange(this); 
        });

        updateUI();
        
        if (preselectedId) {
            setTimeout(() => onRowChange(div.querySelector('.flavor-select')), 50);
        }
    }

    // --- RENDERIZA O HTML DOS EXTRAS (VERSÃO COM FONTE GRANDE) ---
    function renderRowExtrasHTML(container) {
        if (!container) return;
        const sizeId = CURRENT_PIZZA.size.id;
        const addons = PDV_DATA.addons || [];
        
        // Filtra apenas tipo 'extra' com preço para o tamanho
        const extras = addons.filter(a => a.type === 'extra' && a.prices && a.prices[sizeId]);

        if (extras.length === 0) {
            container.innerHTML = '<span class="text-sm text-slate-500 italic col-span-2 p-2">Sem adicionais para este tamanho.</span>';
            return;
        }

        let html = '';
        extras.forEach(a => {
            const price = a.prices[sizeId];
            html += `
            <label class="flex items-center gap-3 cursor-pointer group select-none bg-slate-800 p-3 rounded-lg border border-slate-700 hover:border-indigo-500 transition shadow-sm">
                
                <input type="checkbox" class="flavor-extra-check accent-indigo-500 w-5 h-5 rounded" 
                       value="${a.id}" data-name="${a.name}" data-price="${price}" 
                       onchange="calcPizza()">
                
                <div class="flex-1 flex justify-between items-center overflow-hidden">
                    <span class="text-base font-bold text-slate-200 truncate mr-2 group-hover:text-white transition">
                        ${a.name}
                    </span>
                    
                    <span class="text-sm text-green-400 font-bold font-mono shrink-0 bg-slate-900 px-2 py-0.5 rounded border border-slate-700">
                        +${price.toFixed(2)}
                    </span>
                </div>
            </label>`;
        });
        container.innerHTML = html;
    }

    // --- GERENCIA MUDANÇA NA LINHA ---
    function onRowChange(selectEl) {
        const row = selectEl.closest('.flavor-row');
        if (!row) return;

        const val = $(selectEl).val() || selectEl.value;
        const toggleBtn = row.querySelector('.btn-toggle-extras');
        const extrasContainer = row.querySelector('.flavor-extras-container');

        if (val) {
            // Sabor selecionado: Mostra o botão da seta, mas MANTÉM container fechado
            toggleBtn.classList.remove('hidden');
        } else {
            // Sem sabor: Esconde seta e container, e reseta tudo
            toggleBtn.classList.add('hidden');
            extrasContainer.classList.add('hidden');
            
            // Reseta visual da seta
            const icon = toggleBtn.querySelector('i');
            if(icon) icon.classList.remove('-rotate-180');
            
            // Desmarca extras
            row.querySelectorAll('.flavor-extra-check').forEach(c => c.checked = false);
        }

        calcPizza();
        renderPizzaIngredients();
    }

    // --- NOVA FUNÇÃO DE TOGGLE (CLIQUE NA SETA) ---
    function toggleRowExtras(btn) {
        const row = btn.closest('.flavor-row');
        const container = row.querySelector('.flavor-extras-container');
        const icon = btn.querySelector('i');

        // Alterna visibilidade
        container.classList.toggle('hidden');

        // Alterna Estilo do Botão (Ativo/Inativo)
        if (container.classList.contains('hidden')) {
            // Fechou
            icon.classList.remove('-rotate-180');
            btn.classList.remove('bg-indigo-600', 'text-white', 'border-indigo-500');
            btn.classList.add('bg-slate-700', 'text-slate-400');
        } else {
            // Abriu
            icon.classList.add('-rotate-180');
            btn.classList.remove('bg-slate-700', 'text-slate-400');
            btn.classList.add('bg-indigo-600', 'text-white', 'border-indigo-500');
        }
    }

    // --- CÁLCULO FINANCEIRO (VARRE LINHAS) ---
    function calcPizza() {
        if (!CURRENT_PIZZA.size) return;

        let maxPrice = 0;
        let flavorNames = [];
        let flavorIds = [];

        // Varre cada Select de Sabor
        $('.flavor-select').each(function() {
            const $select = $(this);
            const pid = $select.val();
            
            if(pid) {
                const p = PDV_DATA.products.find(x => x.id == pid);
                if(p) {
                    // 1. Preço Base
                    const price = p.size_prices[CURRENT_PIZZA.size.id];
                    if(price > maxPrice) maxPrice = price;
                    
                    // 2. BUSCA INTELIGENTE DOS EXTRAS
                    // Sobe na árvore até achar um elemento que contenha checkboxes
                    // Isso garante que pegamos o grupo correto, independente do layout
                    const $row = $select.parents().filter(function() { 
                        return $(this).find('input[type="checkbox"]').length > 0; 
                    }).first();
                    
                    let myExtras = [];
                    let extrasCost = 0;
                    
                    // 3. Soma os marcados dentro desse grupo
                    if ($row.length > 0) {
                        $row.find('input[type="checkbox"]:checked').each(function() {
                            const $chk = $(this);
                            if ($chk.data('price') !== undefined) {
                                const addPrice = parseFloat($chk.data('price'));
                                extrasCost += addPrice;
                                myExtras.push($chk.data('name'));
                            }
                        });
                    }

                    // Soma custo ao total
                    maxPrice += extrasCost;

                    // 4. Monta Nome: "Calabresa (+ Bacon)"
                    let fullName = p.name.replace(/^Pizza\s+/i, '');
                    if(myExtras.length > 0) {
                        fullName += ` (+ ${myExtras.join(', ')})`;
                    }

                    flavorNames.push(fullName);
                    flavorIds.push(p.id);
                }
            }
        });

        // Soma Borda
        const edge = document.querySelector('input[name="edge"]:checked');
        if (edge && edge.value) {
             maxPrice += parseFloat(edge.dataset.price || 0);
        }

        // Atualiza UI
        document.getElementById('pizzaTotal').innerText = `R$ ${maxPrice.toFixed(2)}`;
        
        // Salva Estado
        CURRENT_PIZZA.finalPrice = maxPrice;
        CURRENT_PIZZA.parts = flavorNames; 
        CURRENT_PIZZA.parts_ids = flavorIds;
    }

    // --- GARANTIA DE FUNCIONAMENTO ---
    // Adicione isso LOGO ABAIXO da função calcPizza para forçar o recálculo ao clicar
    $(document).on('change', 'input[type="checkbox"]', function() {
        // Só recalcula se o modal de pizza estiver aberto
        if(document.getElementById('pizzaModal') && !document.getElementById('pizzaModal').classList.contains('hidden')) {
            calcPizza();
        }
    });

    function confirmPizza() {
        calcPizza(); // Força o cálculo final para garantir valores
        
        if (!CURRENT_PIZZA.size || CURRENT_PIZZA.parts.length === 0) {
            return Swal.fire('Atenção', 'Selecione pelo menos um sabor.', 'warning');
        }

        // 1. Gera o Título (Visual Simples para Lista Curta)
        // Ex: "Pizza G: Calabresa / Frango (Borda: Catupiry)"
        let title = `Pizza ${CURRENT_PIZZA.size.name}: ${CURRENT_PIZZA.parts.join(' / ')}`;
        
        const edge = document.querySelector('input[name="edge"]:checked');
        let edgeName = "";
        let edgeId = "";
        
        if (edge && edge.value) {
            const edgeObj = PDV_DATA.addons.find(a => a.id == edge.value);
            if (edgeObj) {
                edgeName = edgeObj.name;
                edgeId = edgeObj.id;
                title += ` (Borda: ${edgeName})`;
            }
        }

        // 2. GERAÇÃO DOS DETALHES (A CORREÇÃO DEFINITIVA)
        // Aqui nós criamos a estrutura perfeita que o KDS e o Visualizador amam
        let generatedDetails = [];
        let parts_rich_clean = [];
        let clean_parts_names = []; // Lista de nomes limpos (sem adicionais) para o 'parts'

        // Varre os selects para montar a estrutura detalhada
        $('.flavor-select').each(function() {
            const pid = $(this).val();
            if(pid) {
                const p = PDV_DATA.products.find(x => x.id == pid);
                if(p) {
                    // A. Adiciona o Sabor
                    // Fração: Se tiver mais de 1 sabor, adiciona "1/2" ou "1/3" visualmente
                    const fraction = CURRENT_FLAVORS_COUNT > 1 ? `1/${CURRENT_FLAVORS_COUNT} ` : '';
                    
                    // CORREÇÃO: Remove "Pizza " do nome para ficar limpo (Ex: "Calabresa")
                    const flavorName = p.name.replace(/^Pizza\s+/i, '');

                    generatedDetails.push({
                        type: 'flavor',
                        text: `• ${fraction}${flavorName}`,
                        code: p.id
                    });
                    
                    // Guarda dados limpos para o parts_rich
                    parts_rich_clean.push({ id: p.id, name: flavorName, price: 0 });
                    clean_parts_names.push(flavorName); // Nome puro

                    // B. Busca Adicionais deste sabor
                    const $row = $(this).closest('.flavor-row');
                    $row.find('input[type="checkbox"]:checked').each(function() {
                        const $chk = $(this);
                        const addName = $chk.data('name');
                        const addId = $chk.val();
                        
                        generatedDetails.push({
                            type: 'addon',
                            text: `  + ${addName}`,
                            code: addId
                        });
                    });
                }
            }
        });

        // C. Adiciona Borda aos Detalhes
        if (edgeName) {
            generatedDetails.push({
                type: 'edge',
                text: `🧀 Borda: ${edgeName}`,
                code: edgeId
            });
        }

        // 3. Ingredientes Removidos
        const removedIds = [];
        const removedNames = [];
        document.querySelectorAll('.pizza-ing-check').forEach(cb => {
            if (!cb.checked) {
                removedIds.push(parseInt(cb.value));
                removedNames.push(cb.dataset.name);
                // Adiciona visualmente aos detalhes também para ficar explícito
                generatedDetails.push({
                    type: 'removed',
                    text: `Sem ${cb.dataset.name}`,
                    code: null
                });
            }
        });

        const obs = document.getElementById('pizzaObs').value;

        // 4. ENVIA PARA O CARRINHO (LÓGICA HÍBRIDA: NOVO ou EDIÇÃO)
        const newItem = {
            type: 'pizza',
            id: CURRENT_PIZZA.product.id,          
            product_id: CURRENT_PIZZA.product.id,  
            title: title, 
            price: CURRENT_PIZZA.finalPrice,
            quantity: 1, // Mantém 1, quantidade se altera na lista
            parts: clean_parts_names,
            parts_rich: parts_rich_clean,
            details: generatedDetails,
            removed_ingredients: removedIds,
            removed_names: removedNames,
            observation: obs,
            kds_stage: 0,
            kds_done: false
        };

        if (EDITING_CART_INDEX !== null && CART[EDITING_CART_INDEX]) {
            // --- MODO EDIÇÃO: Atualiza o existente ---
            // Preserva a quantidade que o usuário já tinha definido na lista
            newItem.quantity = CART[EDITING_CART_INDEX].quantity;
            CART[EDITING_CART_INDEX] = newItem;
            
            // Feedback Visual
            const Toast = Swal.mixin({ toast: true, position: 'bottom', showConfirmButton: false, timer: 1000, background: '#3b82f6', color: '#fff' });
            Toast.fire({ icon: 'success', title: 'Pizza Atualizada!' });
            
            EDITING_CART_INDEX = null; // Reseta
        } else {
            // --- MODO CRIAÇÃO: Adiciona novo ---
            CART.push(newItem);
            
            const Toast = Swal.mixin({ toast: true, position: 'bottom', showConfirmButton: false, timer: 1000, background: '#10b981', color: '#fff' });
            Toast.fire({ icon: 'success', title: 'Adicionado!' });
        }

        updateCartUI();
        closePizzaModal();
    }

    function removeFlavorRow(rowId) {
        document.getElementById(rowId).remove();
        CURRENT_FLAVORS_COUNT--;
        updateUI();
        onFlavorChange(); // Recalcula total e ingredientes
    }

    // Função de renderizar ingredientes (Mantida para garantir que o "Retirar Ingredientes" funcione)
    function renderPizzaIngredients() {
        const list = document.getElementById('pizzaIngsList');
        const box = document.getElementById('pizzaIngsBox');
        
        if (!list || !box) return;

        list.innerHTML = '';
        let hasIngs = false;
        const products = PDV_DATA.products || [];

        $('.flavor-select').each(function () {
            const prodId = $(this).val();
            if (!prodId) return;

            const prod = products.find(p => p.id == prodId);
            if (prod && prod.ingredients && prod.ingredients.length > 0) {
                hasIngs = true;
                if (CURRENT_FLAVORS_COUNT > 1) {
                    list.innerHTML += `<div class="col-span-full text-[10px] text-orange-400 font-bold uppercase mt-2 border-b border-white/10 pb-1">${prod.name}</div>`;
                }
                prod.ingredients.forEach(ing => {
                    list.innerHTML += `
                    <label class="relative cursor-pointer group select-none">
                        <input type="checkbox" class="pizza-ing-check peer sr-only" value="${ing.id}" data-name="${ing.name}" checked>
                        <div class="bg-slate-900 border border-slate-600 rounded-lg p-2 flex items-center justify-between transition-all peer-checked:border-slate-600 peer-checked:opacity-100 opacity-60 border-red-500 peer-checked:bg-slate-900 bg-red-900/10">
                            <span class="text-xs text-slate-300 peer-checked:text-slate-300 text-red-400 font-medium peer-checked:font-normal peer-checked:no-underline line-through transition-colors">${ing.name}</span>
                            <i class="fas fa-times text-red-500 text-xs peer-checked:hidden"></i>
                        </div>
                    </label>`;
                });
            }
        });

        if (hasIngs) box.classList.remove('hidden'); else box.classList.add('hidden');
    }

    // Renderiza Bordas
    function renderEdges(sizeId) {
        const box = document.getElementById('pizzaEdgesBox');
        box.innerHTML = `
        <label class="flex items-center gap-3 p-3 bg-slate-900 rounded-xl border border-slate-600 cursor-pointer hover:bg-slate-800 transition shadow-sm">
            <input type="radio" name="edge" value="" checked onchange="calcPizza()" class="accent-indigo-500 w-4 h-4"> 
            <span class="text-sm text-slate-300 font-bold">Sem Borda</span>
        </label>`;

        const edges = (PDV_DATA.addons || []).filter(a => a.type === 'edge' && a.prices && a.prices[sizeId]);
        
        if (edges.length > 0) {
            document.getElementById('stepEdges').classList.remove('hidden');
            edges.forEach(a => {
                const price = a.prices[sizeId];
                box.innerHTML += `
                <label class="flex items-center gap-3 p-3 bg-slate-900 rounded-xl border border-slate-600 cursor-pointer hover:border-yellow-500 transition shadow-sm group">
                    <input type="radio" name="edge" value="${a.id}" data-price="${price}" onchange="calcPizza()" class="accent-yellow-500 w-4 h-4">
                    <div class="flex-1 flex justify-between items-center">
                        <span class="text-sm text-slate-300 group-hover:text-white transition">${a.name}</span>
                        <span class="text-xs text-yellow-400 font-bold font-mono">+R$ ${price.toFixed(2)}</span>
                    </div>
                </label>`;
            });
        } else {
            document.getElementById('stepEdges').classList.add('hidden');
        }
    }

    // Função de wrapper para o onRowChange (caso algo chame externamente)
    function onFlavorChange() {
        // Obsoleta, mas mantida para evitar erros se algo antigo chamar
    }

    function closePizzaModal() { document.getElementById('pizzaModal').classList.add('hidden'); }


    // --- GERENCIADOR DE TAXAS ---
    
    let ALL_FEES = [];

    async function openFeeManager() {
        document.getElementById('feeManagerModal').classList.remove('hidden');
        resetFeeForm();
        await loadFees();
    }

    async function loadFees() {
        const list = document.getElementById('feesList');
        list.innerHTML = '<div class="text-center py-10 text-slate-500 text-xs"><i class="fas fa-circle-notch fa-spin"></i> Carregando...</div>';
        
        try {
            const res = await fetch('/admin/api/fees/list');
            ALL_FEES = await res.json();
            renderFees(ALL_FEES);
        } catch (e) {
            console.error(e);
            list.innerHTML = '<div class="text-center py-4 text-red-400 text-xs">Erro ao carregar.</div>';
        }
    }

    function renderFees(data) {
        const list = document.getElementById('feesList');
        list.innerHTML = '';

        if (data.length === 0) {
            list.innerHTML = '<div class="text-center py-10 text-slate-500 text-xs italic">Nenhum bairro cadastrado.</div>';
            return;
        }

        data.forEach(f => {
            list.innerHTML += `
            <div class="flex justify-between items-center bg-slate-900/50 p-3 rounded-lg border border-slate-700/50 hover:bg-slate-700 transition group fee-item">
                <div class="flex-1 cursor-pointer" onclick="editFee(${f.id}, '${f.neighborhood}', ${f.fee})">
                    <div class="font-bold text-white text-sm">${f.neighborhood}</div>
                </div>
                <div class="flex items-center gap-3">
                    <span class="text-green-400 font-mono font-bold text-sm bg-slate-900 px-2 py-1 rounded border border-slate-600">R$ ${f.fee.toFixed(2)}</span>
                    <button onclick="deleteFee(${f.id})" class="text-slate-500 hover:text-red-400 transition w-8 h-8 flex items-center justify-center rounded hover:bg-slate-800"><i class="fas fa-trash text-xs"></i></button>
                    <button onclick="editFee(${f.id}, '${f.neighborhood}', ${f.fee})" class="text-slate-500 hover:text-blue-400 transition w-8 h-8 flex items-center justify-center rounded hover:bg-slate-800"><i class="fas fa-pen text-xs"></i></button>
                </div>
            </div>`;
        });
    }

    function filterFees() {
        const term = document.getElementById('searchFee').value.toUpperCase();
        const filtered = ALL_FEES.filter(f => f.neighborhood.includes(term));
        renderFees(filtered);
    }

    function editFee(id, name, val) {
        document.getElementById('feeId').value = id;
        document.getElementById('feeName').value = name;
        document.getElementById('feeVal').value = val.toFixed(2);
        
        // Muda ícone do botão para indicar edição
        const btn = document.querySelector('#feeManagerModal button[type="submit"]');
        btn.innerHTML = '<i class="fas fa-save"></i>';
        btn.classList.remove('bg-yellow-600', 'hover:bg-yellow-500');
        btn.classList.add('bg-blue-600', 'hover:bg-blue-500');
        
        document.getElementById('feeName').focus();
    }

    function resetFeeForm() {
        document.getElementById('feeId').value = '';
        document.getElementById('feeName').value = '';
        document.getElementById('feeVal').value = '';
        
        const btn = document.querySelector('#feeManagerModal button[type="submit"]');
        btn.innerHTML = '<i class="fas fa-plus"></i>';
        btn.classList.add('bg-yellow-600', 'hover:bg-yellow-500');
        btn.classList.remove('bg-blue-600', 'hover:bg-blue-500');
    }

    async function submitFee(e) {
        e.preventDefault();
        
        const id = document.getElementById('feeId').value;
        const name = document.getElementById('feeName').value;
        const val = document.getElementById('feeVal').value;

        if (!name || !val) return;

        const fd = new FormData();
        if(id) fd.append('fee_id', id);
        fd.append('neighborhood', name);
        fd.append('fee', val);

        try {
            const res = await fetch('/admin/api/fees/save', { method: 'POST', body: fd });
            if (res.ok) {
                const Toast = Swal.mixin({toast: true, position: 'top-end', showConfirmButton: false, timer: 1500, background: '#1e293b', color: '#fff'});
                Toast.fire({icon: 'success', title: 'Salvo!'});
                resetFeeForm();
                loadFees();
                
                // Atualiza o cache global do PDV para a busca funcionar sem reload
                if(typeof PDV_DATA !== 'undefined' && PDV_DATA.fees) {
                    PDV_DATA.fees[name.toUpperCase()] = parseFloat(val);
                }
                
            } else {
                Swal.fire('Erro', 'Falha ao salvar.', 'error');
            }
        } catch (e) { console.error(e); }
    }

    async function deleteFee(id) {
        if (!confirm('Excluir este bairro?')) return;
        
        try {
            const res = await fetch(`/admin/api/fees/${id}`, { method: 'DELETE' });
            if (res.ok) {
                loadFees();
            } else {
                Swal.fire('Erro', 'Falha ao excluir.', 'error');
            }
        } catch (e) { console.error(e); }
    }


    // --- GESTÃO DE MÚLTIPLAS ABAS (FINAL BLINDADO V4) ---
    
    let PDV_SESSIONS = {}; // Armazena os pedidos minimizados
    
    // Função auxiliar para pegar a janela correta do modal
    function getPDVWindow() {
        return document.querySelector('#pdvModal > div.relative');
    }

    // Função auxiliar apenas para capturar os dados
    function captureCurrentState() {
        const orderId = document.getElementById('pdvOrderId').value;
        const tempId = orderId ? `ord-${orderId}` : `new-${Date.now()}`;
        
        let title = "Novo Pedido";
        const clientName = document.getElementById('pdvName').value;
        const tableNum = document.getElementById('pdvTableNum').value;
        
        if (IS_TABLE_MODE && tableNum) title = `Mesa ${tableNum}`;
        else if (clientName) title = clientName.split(' ')[0];

        return {
            id: tempId,
            data: {
                // SALVA O CARRINHO COM CLONAGEM PROFUNDA
                cart: JSON.parse(JSON.stringify(CART)),
                payments: JSON.parse(JSON.stringify(PAYMENTS)),
                client: CURRENT_CLIENT ? JSON.parse(JSON.stringify(CURRENT_CLIENT)) : null,
                isTable: IS_TABLE_MODE,
                
                orderId: orderId,
                tableNum: tableNum,
                name: clientName,
                phone: document.getElementById('pdvPhone').value,
                street: document.getElementById('pdvStreet').value,
                number: document.getElementById('pdvNum').value,
                neigh: document.getElementById('pdvNeigh').value,
                
                fee: document.getElementById('valFee').value,
                disc: document.getElementById('valDisc').value,
                tip: document.getElementById('valTip').value,
                credit: document.getElementById('valCredit').value,
                service: document.getElementById('chkService10').checked,
                deliveryType: document.getElementById('pdvDeliveryType').value,
                
                titleDisplay: title,
                totalVal: document.getElementById('lblTotal').dataset.val || 0
            }
        };
    }

    function minimizeCurrentPDV() {
        const snapshot = captureCurrentState();
        
        // Só minimiza se tiver dados relevantes
        if (snapshot.data.cart.length === 0 && !snapshot.data.name && !snapshot.data.orderId) {
             closePDV(); return;
        }

        PDV_SESSIONS[snapshot.id] = snapshot.data;
        
        // Animação de Saída
        const modalWindow = getPDVWindow();
        if(modalWindow) modalWindow.classList.add('translate-y-full', 'scale-90', 'opacity-0');
        
        setTimeout(() => {
            if(modalWindow) modalWindow.classList.remove('translate-y-full', 'scale-90', 'opacity-0');
            document.getElementById('pdvModal').classList.add('hidden');
            
            resetPDV(); // Limpa tela
            renderPDVDock(); // Cria o botão
            
            const Toast = Swal.mixin({toast: true, position: 'bottom-start', showConfirmButton: false, timer: 1500, background: '#1e293b', color: '#fff'});
            Toast.fire({icon: 'success', title: 'Minimizado'});
        }, 200);
    }

    function restorePDVSession(sessionId) {
        const dataToRestore = PDV_SESSIONS[sessionId];
        if (!dataToRestore) return;

        // 1. Swap: Salva o atual se tiver dados
        if (CART.length > 0 || document.getElementById('pdvName').value || document.getElementById('pdvOrderId').value) {
            const currentSnapshot = captureCurrentState();
            PDV_SESSIONS[currentSnapshot.id] = currentSnapshot.data;
        }

        // 2. Remove da barra
        delete PDV_SESSIONS[sessionId];
        renderPDVDock();

        // 3. RESTAURA VARIÁVEIS GLOBAIS (CRÍTICO: ANTES DE QUALQUER FUNÇÃO UI)
        CART = dataToRestore.cart || []; // Garante array mesmo se vier nulo
        PAYMENTS = dataToRestore.payments || [];
        CURRENT_CLIENT = dataToRestore.client;
        IS_TABLE_MODE = dataToRestore.isTable;
        EDITING_CART_INDEX = null; // Reseta edição pendente
        
        // 4. RESTAURA CAMPOS DO DOM
        document.getElementById('pdvOrderId').value = dataToRestore.orderId;
        document.getElementById('pdvTableNum').value = dataToRestore.tableNum;
        document.getElementById('pdvName').value = dataToRestore.name;
        document.getElementById('pdvPhone').value = dataToRestore.phone;
        document.getElementById('pdvStreet').value = dataToRestore.street;
        document.getElementById('pdvNum').value = dataToRestore.number;
        document.getElementById('pdvNeigh').value = dataToRestore.neigh;
        
        document.getElementById('valFee').value = dataToRestore.fee;
        document.getElementById('valDisc').value = dataToRestore.disc;
        document.getElementById('valTip').value = dataToRestore.tip;
        document.getElementById('valCredit').value = dataToRestore.credit;
        document.getElementById('chkService10').checked = dataToRestore.service;
        
        // 5. Configura Modo (Isso chama updateCartUI, por isso CART já deve estar setado)
        setDeliveryMode(dataToRestore.deliveryType);
        
        // 6. Títulos
        if (dataToRestore.isTable) {
            document.getElementById('pdvTitle').innerText = `Mesa ${dataToRestore.tableNum}`;
            document.getElementById('pdvSubtitle').innerText = "Retomando...";
        } else {
            document.getElementById('pdvTitle').innerText = dataToRestore.orderId ? "Editando Pedido" : "Novo Pedido";
            document.getElementById('pdvSubtitle').innerText = dataToRestore.name || "Venda Avulsa";
        }
        
        // 7. Configura Cliente Visualmente
        if (CURRENT_CLIENT) {
            document.getElementById('selectedClientBox').classList.remove('hidden');
            document.getElementById('pdvSearch').parentElement.classList.add('hidden');
            document.getElementById('lblClientName').innerText = dataToRestore.name;
            document.getElementById('lblClientPhone').innerText = dataToRestore.phone;
            let addr = "Retirada / Sem endereço";
            if (CURRENT_CLIENT.street) addr = `${CURRENT_CLIENT.street}, ${CURRENT_CLIENT.number}`;
            document.getElementById('lblClientAddress').innerText = addr;
        } else {
            document.getElementById('selectedClientBox').classList.add('hidden');
            document.getElementById('pdvSearch').parentElement.classList.remove('hidden');
        }
        
        // 8. FORÇA A RENDERIZAÇÃO DO CARRINHO (GARANTIA FINAL)
        updateCartUI();

        // 9. Abre a Janela
        const modalContainer = document.getElementById('pdvModal');
        const modalWindow = getPDVWindow();
        
        modalContainer.classList.remove('hidden');
        if(modalWindow) modalWindow.classList.remove('translate-y-full', 'scale-90', 'opacity-0');
    }

    function renderPDVDock() {
        const dock = document.getElementById('pdvTaskbar');
        dock.innerHTML = '';
        
        const keys = Object.keys(PDV_SESSIONS);
        if (keys.length === 0) return;

        keys.forEach(key => {
            const sess = PDV_SESSIONS[key];
            
            // Calcula totais
            let itemsCount = 0;
            if(sess.cart && Array.isArray(sess.cart)) {
                itemsCount = sess.cart.reduce((acc, i) => acc + (parseFloat(i.quantity) || 0), 0);
            }
            
            const totalFmt = parseFloat(sess.totalVal || 0).toFixed(2);
            const icon = sess.isTable ? '<i class="fas fa-utensils"></i>' : '<i class="fas fa-motorcycle"></i>';
            
            // Renderiza Botão
            dock.innerHTML += `
            <div class="group relative transition-transform hover:-translate-y-1" style="pointer-events: auto;">
                <button onclick="event.stopPropagation(); delete PDV_SESSIONS['${key}']; renderPDVDock();" 
                        class="absolute -top-2 -right-2 w-5 h-5 bg-red-500 text-white rounded-full flex items-center justify-center text-[10px] opacity-0 group-hover:opacity-100 transition shadow-md z-10 cursor-pointer">
                    <i class="fas fa-times"></i>
                </button>

                <div onclick="restorePDVSession('${key}')" 
                     class="bg-slate-800 border border-slate-500 border-b-0 rounded-t-xl px-4 py-2 cursor-pointer hover:bg-indigo-900 hover:border-indigo-400 transition shadow-2xl flex items-center gap-3 min-w-[160px]">
                    <div class="w-8 h-8 rounded-full bg-slate-700 text-indigo-400 border border-slate-600 flex items-center justify-center text-xs font-bold shrink-0">
                        ${icon}
                    </div>
                    <div class="flex flex-col overflow-hidden">
                        <span class="text-xs font-bold text-white truncate max-w-[100px] leading-tight">${sess.titleDisplay}</span>
                        <div class="flex items-center gap-2 text-[10px] text-slate-400">
                            <span class="bg-indigo-500/20 text-indigo-300 px-1 rounded">${itemsCount} it</span>
                            <span class="text-green-400 font-mono">R$ ${totalFmt}</span>
                        </div>
                    </div>
                </div>
            </div>`;
        });
    }

    

</script>
{% endblock %}