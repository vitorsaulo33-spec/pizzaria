{% extends "base.html" %}

{% block title %}Dashboard Inteligente - ALIV{% endblock %}

{% block content %}

<div class="max-w-[1600px] mx-auto p-6 space-y-6">

    <div
        class="bg-slate-800 p-5 rounded-2xl border border-slate-700 shadow-lg flex flex-col md:flex-row justify-between items-center gap-4">
        <div>
            <h1 class="text-2xl font-bold text-white flex items-center gap-3">
                <i class="fas fa-brain text-purple-500"></i>
                ALIV Dashboard
            </h1>
            <p class="text-slate-400 text-xs mt-1">Intelig√™ncia de Vendas em Tempo Real</p>
        </div>

        <div class="flex gap-3">
            <button onclick="optimizeSystem()" id="btnOptimize"
                class="bg-slate-700 hover:bg-emerald-600 hover:text-white text-slate-300 border border-slate-600 px-4 py-2 rounded-lg text-xs font-bold transition flex items-center gap-2 shadow-lg group">
                <i class="fas fa-magic group-hover:animate-spin"></i> OTIMIZAR SISTEMA
            </button>
        </div>

        <form method="get"
            class="w-full xl:w-auto flex flex-wrap gap-2 items-end bg-slate-900/50 p-3 rounded-xl border border-slate-700/50">
            <div class="flex-1 min-w-[120px]">
                <label class="text-[10px] text-slate-500 font-bold uppercase pl-1">Data In√≠cio</label>
                <input type="date" name="start" value="{{ filters.start }}" autocomplete="off"
                    class="w-full bg-slate-800 border border-slate-600 rounded-lg px-3 py-2 text-sm focus:border-indigo-500 outline-none text-white">
            </div>
            <div class="flex-1 min-w-[120px]">
                <label class="text-[10px] text-slate-500 font-bold uppercase pl-1">Data Fim</label>
                <input type="date" name="end" value="{{ filters.end }}" autocomplete="off"
                    class="w-full bg-slate-800 border border-slate-600 rounded-lg px-3 py-2 text-sm focus:border-indigo-500 outline-none text-white">
            </div>

            <div class="flex-1 min-w-[150px]">
                <label class="text-[10px] text-slate-500 font-bold uppercase pl-1">Busca</label>
                <input type="text" name="search" value="{{ filters.search }}" placeholder="Nome, ID ou Tel..."
                    class="w-full bg-slate-800 border border-slate-600 rounded-lg px-3 py-2 text-sm focus:border-indigo-500 outline-none text-white placeholder-slate-500">
            </div>
            <div class="flex-1 min-w-[120px]">
                <label class="text-[10px] text-slate-500 font-bold uppercase pl-1">Pagamento</label>
                <select name="payment_method"
                    class="w-full bg-slate-800 border border-slate-600 rounded-lg px-3 py-2 text-sm focus:border-indigo-500 outline-none text-white">
                    <option value="Todos" {% if filters.payment_method=='Todos' %}selected{% endif %}>Todos</option>
                    <option value="Dinheiro" {% if filters.payment_method=='Dinheiro' %}selected{% endif %}>Dinheiro
                    </option>
                    <option value="Cart√£o" {% if filters.payment_method=='Cart√£o' %}selected{% endif %}>Cart√£o</option>
                    <option value="Pix" {% if filters.payment_method=='Pix' %}selected{% endif %}>Pix</option>
                </select>
            </div>
            <button type="submit"
                class="bg-indigo-600 hover:bg-indigo-500 text-white px-5 py-2 rounded-lg text-sm font-bold shadow-lg shadow-indigo-900/50 transition h-[38px] flex items-center gap-2">
                <i class="fas fa-filter"></i>
            </button>
        </form>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
        <div class="bg-slate-800 p-5 rounded-2xl border border-slate-700 relative overflow-hidden">
            <div class="absolute top-0 right-0 p-4 opacity-10"><i class="fas fa-wallet text-5xl text-green-400"></i>
            </div>
            <p class="text-slate-400 text-xs uppercase font-bold tracking-wider">Faturamento</p>
            <h2 class="text-3xl font-bold text-white mt-1">R$ {{ "%.2f"|format(kpis.revenue) }}</h2>
            <p class="text-xs text-green-400 mt-2">Margem Est: R$ {{ "%.2f"|format(kpis.estimated_profit) }}</p>
        </div>

        <div class="bg-slate-800 p-5 rounded-2xl border border-slate-700 relative overflow-hidden">
            <div class="absolute top-0 right-0 p-4 opacity-10"><i class="fas fa-box text-5xl text-blue-400"></i></div>
            <p class="text-slate-400 text-xs uppercase font-bold tracking-wider">Pedidos Filtrados</p>
            <h2 class="text-3xl font-bold text-white mt-1">{{ kpis.orders }}</h2>
        </div>

        <div class="bg-slate-800 p-5 rounded-2xl border border-slate-700 relative overflow-hidden">
            <div class="absolute top-0 right-0 p-4 opacity-10"><i class="fas fa-receipt text-5xl text-yellow-400"></i>
            </div>
            <p class="text-slate-400 text-xs uppercase font-bold tracking-wider">Ticket M√©dio</p>
            <h2 class="text-3xl font-bold text-yellow-400 mt-1">R$ {{ "%.2f"|format(kpis.avg_ticket) }}</h2>
        </div>

        <div class="bg-slate-800 p-5 rounded-2xl border border-slate-700 relative overflow-hidden">
            <div class="absolute top-0 right-0 p-4 opacity-10"><i class="fas fa-users text-5xl text-pink-400"></i></div>
            <p class="text-slate-400 text-xs uppercase font-bold tracking-wider">Base Ativa (90d)</p>
            <h2 class="text-3xl font-bold text-pink-400 mt-1">{{ customers.total_active }}</h2>
            <p class="text-xs text-pink-500/70 mt-2">Clientes Recentes</p>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

        <div class="lg:col-span-1 flex flex-col gap-6">
            <div
                class="bg-gradient-to-b from-slate-800 to-slate-900 p-6 rounded-2xl border border-purple-500/30 shadow-xl flex-1 flex flex-col">

                <div class="mb-4 space-y-3">
                    <div class="flex justify-between items-center">
                        <h3 class="text-lg font-bold text-white flex items-center gap-2">
                            <i class="fas fa-robot text-purple-400"></i> Intelig√™ncia Artificial
                        </h3>
                    </div>

                    <div class="flex gap-2">
                        <button onclick="askGemini('strategy')"
                            class="flex-1 bg-purple-600 hover:bg-purple-500 text-white py-2 rounded-lg text-xs font-bold transition shadow-lg shadow-purple-900/20 border border-purple-500/50">
                            <i class="fas fa-chart-line mr-1"></i> Analisar Dados
                        </button>
                        <button onclick="askGemini('creative')"
                            class="flex-1 bg-pink-600 hover:bg-pink-500 text-white py-2 rounded-lg text-xs font-bold transition shadow-lg shadow-pink-900/20 border border-pink-500/50">
                            <i class="fas fa-video mr-1"></i> Criar Roteiros
                        </button>
                    </div>
                </div>

                <div id="aiResponseBox"
                    class="bg-black/20 p-4 rounded-xl border border-white/5 text-sm text-slate-300 overflow-y-auto max-h-[500px] min-h-[300px] flex-1 whitespace-pre-wrap leading-relaxed">
                    <div class="flex flex-col items-center justify-center h-full text-slate-500 gap-3 text-center px-4">
                        <i class="fas fa-sparkles text-2xl opacity-50"></i>
                        <p>Escolha uma op√ß√£o acima:</p>
                        <ul class="text-xs space-y-1 opacity-70">
                            <li><strong>Analisar Dados:</strong> Insights sobre vendas e metas.</li>
                            <li><strong>Criar Roteiros:</strong> Ideias de v√≠deos baseadas nos produtos.</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <div class="lg:col-span-2 space-y-6">
            <div class="bg-slate-800 p-6 rounded-2xl border border-slate-700">
                <h3 class="text-sm font-bold text-slate-400 uppercase tracking-wider mb-4">
                    <i class="fas fa-fire text-orange-500"></i> Hor√°rios de Pico (Per√≠odo Selecionado)
                </h3>
                <div class="overflow-x-auto">
                    <div class="grid grid-cols-[auto_repeat(24,minmax(20px,1fr))] gap-1 text-[10px]">
                        <div class="text-transparent">.</div>
                        {% for h in range(24) %} <div class="text-center text-slate-500">{{ h }}h</div> {% endfor %}

                        {% set days_label = ['Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b', 'Dom'] %}
                        {% for day_row in heatmap %}
                        <div class="text-slate-400 font-bold text-right pr-2 py-1">{{ days_label[loop.index0] }}</div>
                        {% for val in day_row %}
                        {% set intensity = 'bg-slate-800' %}
                        {% if val > 0 %} {% set intensity = 'bg-orange-900/40 text-orange-500' %} {% endif %}
                        {% if val > 2 %} {% set intensity = 'bg-orange-700/60 text-white font-bold' %} {% endif %}
                        {% if val > 5 %} {% set intensity = 'bg-orange-500 text-white font-bold shadow' %} {% endif %}
                        <div class="{{ intensity }} rounded flex items-center justify-center h-8"
                            title="{{ val }} pedidos">{{ val if val > 0 else '.' }}</div>
                        {% endfor %}
                        {% endfor %}
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-slate-800 p-5 rounded-2xl border border-slate-700">
                    <h3 class="text-sm font-bold text-slate-400 uppercase tracking-wider mb-4">Top Produtos</h3>
                    <div class="h-48"><canvas id="productsChart"></canvas></div>
                </div>

                <div class="bg-slate-800 p-5 rounded-2xl border border-slate-700 overflow-hidden">
                    <h3 class="text-sm font-bold text-slate-400 uppercase tracking-wider mb-4 flex justify-between">
                        <span><i class="fas fa-user-clock text-red-500 mr-1"></i> Risco Churn</span>
                        <span class="text-[10px] bg-red-900/30 text-red-400 px-2 rounded">90 Dias</span>
                    </h3>
                    <div class="overflow-y-auto max-h-48 space-y-2">
                        {% for client in customers.churn_risk %}
                        <div
                            class="flex justify-between items-center bg-slate-900/50 p-2 rounded border border-slate-700/50">
                            <div>
                                <div class="text-sm font-bold text-slate-200">{{ client.name }}</div>
                                <div class="text-[10px] text-slate-500">{{ client.last_order_days }} dias sem pedir
                                </div>
                            </div>
                            <a href="https://wa.me/55{{ client.phone }}" target="_blank" class="text-green-500"><i
                                    class="fab fa-whatsapp"></i></a>
                        </div>
                        {% else %}
                        <p class="text-slate-500 text-sm text-center py-4">Tudo certo! Nenhum risco alto.</p>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    // Verifica√ß√£o de seguran√ßa para evitar erro se o canvas n√£o existir
    const canvas = document.getElementById('productsChart');

    if (canvas) {
        const ctxProd = canvas.getContext('2d');

        // Dados vindos do Python
        const labels = {{ charts.prod_labels | tojson
    }};
    const dataValues = {{ charts.prod_data | tojson }};

    // Se tiver dados, renderiza. Se n√£o, mostra aviso (opcional)
    if (labels.length > 0) {
        new Chart(ctxProd, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Qtd Vendida',
                    data: dataValues,
                    backgroundColor: '#eab308', // Amarelo do tema
                    borderRadius: 4,
                    barThickness: 20 // Deixa a barra mais elegante
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y', // Barra horizontal
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function (context) {
                                return context.raw + ' unidades';
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        grid: { color: '#334155' },
                        ticks: { color: '#94a3b8' }
                    },
                    y: {
                        grid: { display: false },
                        ticks: { color: '#e2e8f0', font: { size: 11 } }
                    }
                }
            }
        });
    } else {
        // Opcional: Escreve no canvas se estiver vazio
        ctxProd.font = "14px Arial";
        ctxProd.fillStyle = "gray";
        ctxProd.textAlign = "center";
        ctxProd.fillText("Sem dados para exibir", canvas.width / 2, canvas.height / 2);
    }
        }

    // Fun√ß√£o para corrigir a URL visualmente se estiver invertida
    window.addEventListener('load', () => {
        const startInput = document.querySelector('input[name="start"]').value;
        const endInput = document.querySelector('input[name="end"]').value;

        // Se os inputs (corrigidos pelo Python) forem diferentes da URL, atualiza a URL sem recarregar
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('start') && (urlParams.get('start') !== startInput || urlParams.get('end') !== endInput)) {
            urlParams.set('start', startInput);
            urlParams.set('end', endInput);
            const newUrl = `${window.location.pathname}?${urlParams.toString()}`;
            window.history.replaceState(null, '', newUrl);
        }
    });

    async function askGemini(mode) {
        const box = document.getElementById('aiResponseBox');

        let loadingText = mode === 'strategy'
            ? 'Analisando n√∫meros e encontrando padr√µes...'
            : 'Criando roteiros virais para seus v√≠deos...';

        let iconClass = mode === 'strategy' ? 'fa-chart-pie' : 'fa-video';
        let colorClass = mode === 'strategy' ? 'text-purple-400' : 'text-pink-400';

        box.innerHTML = `
                <div class="text-center ${colorClass} animate-pulse mt-10">
                    <i class="fas ${iconClass} fa-spin text-3xl mb-3"></i>
                    <p>${loadingText}</p>
                </div>`;

        // CORRE√á√ÉO CR√çTICA: Pega valores dos INPUTS (j√° corrigidos), n√£o da URL antiga
        const startVal = document.querySelector('input[name="start"]').value;
        const endVal = document.querySelector('input[name="end"]').value;
        const payVal = document.querySelector('select[name="payment_method"]').value;

        const payload = {
            start: startVal,
            end: endVal,
            payment_method: payVal
        };

        const endpoint = mode === 'strategy' ? '/admin/ask-ai' : '/admin/generate-creatives';

        try {
            const response = await fetch(endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const data = await response.json();

            if (data.response) {
                let formatted = data.response
                    .replace(/\*\*(.*?)\*\*/g, `<b class="${colorClass}">$1</b>`)
                    .replace(/### (.*?)\n/g, '<h4 class="text-lg font-bold text-white mt-6 mb-2 border-b border-white/10 pb-1">$1</h4>')
                    .replace(/- (.*?)\n/g, '<li class="ml-4 mb-1 marker:text-slate-500">$1</li>')
                    .replace(/\n/g, '<br>');

                box.innerHTML = `<div class="fade-in">${formatted}</div>`;
            } else {
                box.innerHTML = '<div class="text-yellow-400 p-4">A IA n√£o retornou resposta. Tente novamente.</div>';
            }
        } catch (error) {
            console.error(error);
            box.innerHTML = '<div class="text-red-400 p-4 border border-red-900/50 rounded bg-red-900/10">‚ùå Erro na conex√£o com a IA. Tente novamente.</div>';
        }
    }

    // No final do arquivo, dentro da tag <script>

    async function optimizeSystem() {
        const btn = document.getElementById('btnOptimize');
        const originalContent = btn.innerHTML;

        // Estado Carregando
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> FAZENDO FAXINA...';
        btn.classList.add('bg-emerald-600', 'text-white'); // Fica verde enquanto roda

        try {
            const res = await fetch('/admin/system/optimize', { method: 'POST' });
            const data = await res.json();

            if (res.ok) {
                Swal.fire({
                    title: 'Sistema Otimizado! üöÄ',
                    text: data.message,
                    icon: 'success',
                    background: '#1e293b',
                    color: '#fff',
                    timer: 2000,
                    showConfirmButton: false
                });
            } else {
                Swal.fire('Erro', data.message, 'error');
            }
        } catch (e) {
            Swal.fire('Erro', 'Falha na conex√£o.', 'error');
        } finally {
            // Restaura bot√£o
            setTimeout(() => {
                btn.innerHTML = originalContent;
                btn.disabled = false;
                btn.classList.remove('bg-emerald-600', 'text-white');
            }, 2000);
        }
    }
</script>

{% endblock %}